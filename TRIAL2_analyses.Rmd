---
title: "T2.D5_LabyInoc_PrelimAnalyse"
author: "Forest Schenck"
date: "August 17, 2016"
output: pdf_document
---

#Packages Library
```{r eval = FALSE, echo = FALSE}
#Data manipulation and plotting packages
library (dplyr)
library(tidyr)
library(sciplot)
library(ggplot2)

#Analyses packages
library(lme4) #Random effects
library(lmerTest) #Pvalues for Random effects
library(lsmeans) #post-hoc for random effects models
library(bbmle)
#library(lmerTest)
library(car) #P values for glm
library(multcomp) #Tukey tests
library(multcompView) #Tukey tests
library(survival) #survival analyses
library(survminer)


#Site mapping packages
#library(maps)  #also in temp and salinity
#library(rgdal) #also in temp and salinity
library(mapdata)
library(mapplots)
library(mapproj)
#library(maptools) #didn't work for shape file
#gpclibPermit() # Not permited
library(sp)

#Temp and salinity data packages
library(rgdal)
library(raster)
library(viridis) #color palettes
library(maps)
library(scales)

#Model
library(deSolve)


```

#uploading data
```{r eval = FALSE, echo = FALSE}
##Mesocosm
mesocosm.leaf <- read.csv("TRIAL2_mesocosm.csv") ##old name = d1

str(mesocosm.leaf)

mesocosm.leaf$no. <- as.factor(mesocosm.leaf$no.)
mesocosm.leaf$experiment.day <- as.factor(mesocosm.leaf$experiment.day)
mesocosm.leaf$exp.leaf.no <- as.factor(mesocosm.leaf$exp.leaf.no)
mesocosm.leaf$current.leaf.no <- as.factor(mesocosm.leaf$current.leaf.no)
mesocosm.leaf$mesocosm <- as.factor(mesocosm.leaf$mesocosm)
mesocosm.leaf$vase <- as.factor(mesocosm.leaf$vase)
mesocosm.leaf$exp.day.appeared <- as.numeric(mesocosm.leaf$exp.day.appeared)
mesocosm.leaf$lesion.presence.factor <- as.factor(mesocosm.leaf$lesion.presence)

mesocosm.leaf$shoot.ID <- paste(mesocosm.leaf$site, mesocosm.leaf$no.)
mesocosm.leaf$shoot.ID <- as.factor(mesocosm.leaf$shoot.ID)

mesocosm.leaf$field.prevalence <- 0
for (n in 1:length(mesocosm.leaf$site)) {
  if (mesocosm.leaf$site[n] == "LP")
  {mesocosm.leaf$field.prevalence[n] = 0.29
  }else if (mesocosm.leaf$site[n] == "NB")
  {mesocosm.leaf$field.prevalence[n] = 0.47
  } else if (mesocosm.leaf$site[n] == "DC")
  {mesocosm.leaf$field.prevalence[n] = 0.61
  }  else {
    mesocosm.leaf$field.prevalence[n] = 0.69
    }
}

## Shoot level responses
mesocosm.shoot <- mesocosm.leaf %>%
  dplyr::select(c(month, year, mesocosm, vase, infection, site, experiment.day, S1.no.leaves, no.leaves.lost, no.leaves.new, shoot.no, S1.total.length, S2.total.length, rhizome.length, ag.biomass, bg.biomass, mortality.day, stat, shoot.notes)) %>%
  group_by(month, year, mesocosm, vase, infection, site, experiment.day) %>%
  summarize(S1.no.leaves = mean(S1.no.leaves, na.rm = T), no.leaves.lost = mean(no.leaves.lost, na.rm = T), no.leaves.new = mean(no.leaves.new, na.rm = T), shoot.no = mean(shoot.no, na.rm = T), S1.total.length = mean(S1.total.length, na.rm = T), S2.total.length = mean(S2.total.length, na.rm = T), rhizome.length = mean(rhizome.length, na.rm = T), ag.biomass = mean(ag.biomass, na.rm = T), bg.biomass = mean(bg.biomass, na.rm = T), mortality.day = mean(mortality.day, na.rm = T), stat = mean(stat, na.rm = T))

mesocosm.shoot.initial <- mesocosm.shoot %>%
  dplyr::select(c(month, year, mesocosm, vase, infection, site, experiment.day, S1.no.leaves, no.leaves.lost, no.leaves.new, shoot.no, S1.total.length, S2.total.length, rhizome.length, ag.biomass, bg.biomass)) %>%
  subset(experiment.day == "0")
colnames(mesocosm.shoot.initial) <- c("month", "year", "mesocosm", "vase", "infection", "site", "experiment.day", "no.leaves.initial", "no.leaves.lost.initial", "no.leaves.new.initial", "shoot.no.initial", "S1.total.length.initial", "S2.total.length.initial", "rhizome.length.initial", "ag.biomass.initial", "bg.biomass.initial")

mesocosm.shoot.final <- mesocosm.shoot %>%
  dplyr::select(c(month, year, mesocosm, vase, infection, site, experiment.day, S1.no.leaves, no.leaves.lost, no.leaves.new, shoot.no, S1.total.length, S2.total.length, rhizome.length, ag.biomass, bg.biomass)) %>%
  subset(experiment.day == "28")
colnames(mesocosm.shoot.final) <- c("month", "year", "mesocosm", "vase", "infection", "site", "experiment.day", "no.leaves.final", "no.leaves.lost.final", "no.leaves.new.final", "shoot.no.final", "S1.total.length.final", "S2.total.length.final", "rhizome.length.final", "ag.biomass.final", "bg.biomass.final")

mesocosm.shoot.temp <- merge(mesocosm.shoot.initial, mesocosm.shoot.final, by = c("month", "year", "mesocosm", "vase", "infection", "site"))

mesocosm.shoot <- dplyr::select(mesocosm.shoot.temp, c(month, year, mesocosm, vase, infection, site, no.leaves.initial, shoot.no.initial, shoot.no.final, S1.total.length.initial, S2.total.length.final, rhizome.length.initial, rhizome.length.final, ag.biomass.final, bg.biomass.final))

mesocosm.shoot.leaf.no.final.edit <- dplyr::select(mesocosm.shoot.temp, c(month:site, no.leaves.final, no.leaves.lost.final, no.leaves.new.final, S1.total.length.final, S2.total.length.final, shoot.no.final))
#mesocosm.shoot.leaf.no.final.edit <- subset(mesocosm.shoot.leaf.no.final.edit,   vase != "81") #excluded dead shoot from control
mesocosm.shoot.leaf.no.final.edit <- dplyr::select(mesocosm.shoot.leaf.no.final.edit, c(month:S1.total.length.final)) #removing final leaf number values of dead shoots

mesocosm.shoot <- merge(mesocosm.shoot, mesocosm.shoot.leaf.no.final.edit, by = c("month", "year", "mesocosm", "vase", "infection", "site"), all.x = T)

mesocosm.shoot$survival <- 0
for (n in 1:88) {
  if (mesocosm.shoot$shoot.no.final[n] >= 1)
  {mesocosm.shoot$survival[n] = 1
  } else {
    mesocosm.shoot$survival[n] = 0
    }
} 
mesocosm.shoot$mortality <- 1-mesocosm.shoot$survival
##adding in survival and mortality data

mesocosm.shoot$shoot.production <- 0
for (n in 1:88) {
  if (mesocosm.shoot$shoot.no.final[n] - mesocosm.shoot$shoot.no.initial[n] >= 0) {
    mesocosm.shoot$shoot.production[n] <- mesocosm.shoot$shoot.no.final[n]-mesocosm.shoot$shoot.no.initial[n]
  } else {
   mesocosm.shoot$shoot.production[n] <- NA
  }
}
mesocosm.shoot$no.shoot.production <- 1-mesocosm.shoot$shoot.production ##adding in shoot production

mesocosm.shoot <- merge(mesocosm.shoot, mesocosm.survival, by = c("month", "year", "mesocosm", "vase", "infection", "site"), all.x = T)

##Adding field prevalence
mesocosm.shoot$field.prevalence <- 0
for (n in 1:length(mesocosm.shoot$site)) {
  if (mesocosm.shoot$site[n] == "LP")
  {mesocosm.shoot$field.prevalence[n] = 0.29
  }else if (mesocosm.shoot$site[n] == "NB")
  {mesocosm.shoot$field.prevalence[n] = 0.47
  } else if (mesocosm.shoot$site[n] == "DC")
  {mesocosm.shoot$field.prevalence[n] = 0.61
  }  else {
    mesocosm.shoot$field.prevalence[n] = 0.69
    }
}

mesocosm.shoot$rhizome.growth <- (mesocosm.shoot$rhizome.length.final - mesocosm.shoot$rhizome.length.initial)/28 ##Rhizome growth

#leaves lost per day
mesocosm.shoot$leaf.p <- mesocosm.shoot$no.leaves.new.final/28
mesocosm.shoot$leaf.l <- mesocosm.shoot$no.leaves.lost.final/28

str(mesocosm.shoot)

##Leaf growth
mesocosm.growth.d0 <- mesocosm.leaf %>%
  dplyr::select(mesocosm, vase, infection, experiment.day, site, exp.leaf.no, length.cm) %>%
  subset(experiment.day == "0" & exp.leaf.no == "1") %>%
  dplyr::select(-experiment.day)
colnames(mesocosm.growth.d0)[6] <- "initial.length.cm"

mesocosm.growth.d5 <- mesocosm.leaf %>%
  dplyr::select(mesocosm, vase, infection, experiment.day, site, exp.leaf.no, delta.sheath.length) %>%
  subset(experiment.day == "5" & exp.leaf.no == "1")
mesocosm.growth.d5$delta.sheath.length[is.na(mesocosm.growth.d5$delta.sheath.length)] <-0

mesocosm.growth.d28 <- mesocosm.leaf %>%
  dplyr::select(mesocosm, vase, infection, experiment.day, site, exp.leaf.no, length.cm, delta.sheath.length) %>%
  subset(experiment.day == "28" & exp.leaf.no == "1") %>%
  dplyr::select(-experiment.day)
mesocosm.growth.d28$delta.sheath.length[is.na(mesocosm.growth.d28$delta.sheath.length)] <-0
mesocosm.growth.d28$delta.sheath.length <- mesocosm.growth.d5$delta.sheath.length + mesocosm.growth.d28$delta.sheath.length
colnames(mesocosm.growth.d28)[6] <- "final.length.cm"

mesocosm.growth <- merge(mesocosm.growth.d0, mesocosm.growth.d28, by = c("mesocosm", "vase", "infection", "site", "exp.leaf.no"))

mesocosm.growth$leaf1.growth <- ((mesocosm.growth$final.length.cm - mesocosm.growth$delta.sheath.length) - mesocosm.growth$initial.length.cm)/28

#only using surviving plants
for (n in 1:88) {
  if (mesocosm.growth$survival[n] > 0) {
    mesocosm.growth$leaf1.growth[n] <- mesocosm.growth$leaf1.growth[n]
  } else {
   mesocosm.growth$leaf1.growth[n] <- NA
  }
}

mesocosm.shoot.survival <- mesocosm.shoot %>%
  dplyr::select(mesocosm, vase, infection, site, survival)
mesocosm.growth <- merge(mesocosm.shoot.survival, mesocosm.growth, by = c("mesocosm", "vase", "infection", "site"))

##survival
mesocosm.survival <- mesocosm.leaf %>%
  dplyr::select(c(month, year, mesocosm, vase, infection, site, experiment.day, mortality.day, stat)) %>%
  subset(experiment.day == "28") %>%
  group_by(month, year, mesocosm, vase, infection, site) %>%
  filter(vase != 17 & vase != 21 & vase != 27 & vase != 29 & vase != 37 & vase != 47 & vase != 59 & vase != 81) %>%
  summarize(mortality.day = mean(mortality.day, na.rm = T), stat = mean(stat, na.rm = T)) #%>% ##adding survival analyses data
  #filter(vase != 17 & vase != 21 & vase != 27 & vase != 29 & vase != 37 & vase != 47 & vase != 59)


##Mesocosm lesions
mesocosm.lesions <- mesocosm.leaf %>%
  filter(shoot.no != 0 & experiment.day == 28) %>%
  dplyr::select(c(month, year, mesocosm, vase, infection, site, experiment.day, S1.no.leaves, area.cm, wd.lesion.area, wd.lesion.pc, lesion.presence, lesion.absence, exp.day.appeared, notes)) %>%
  group_by(month, year, mesocosm, vase, infection, site, experiment.day) %>%
  summarize(S1.no.leaves = mean(S1.no.leaves, na.rm = T), area.cm = sum(area.cm, na.rm = T), lesion.area = sum(wd.lesion.area, na.rm = T), WSWI = mean(wd.lesion.pc, na.rm = T), lesion.presence = sum(lesion.presence, na.rm = T), lesion.absence = sum(lesion.absence, na.rm = T), exp.day.appeared = mean(exp.day.appeared, na.rm = T))

mesocosm.lesions$lesions.pc <- (mesocosm.lesions$lesion.area/mesocosm.lesions$area.cm)*100
for (n in 1:length(mesocosm.lesions$lesions.pc)) {
  if (mesocosm.lesions$lesions.pc[n] == "NaN") {
    mesocosm.lesions$lesions.pc[n] <- 0
  } else {
   mesocosm.lesions$lesions.pc[n] <- mesocosm.lesions$lesions.pc[n]
  }
}

mesocosm.lesions$infected <- 0
for (n in 1:length(mesocosm.lesions$infected)) {
  if (mesocosm.lesions$lesion.presence[n] >= 1) {
    mesocosm.lesions$infected[n] <- 1
  } else {
   mesocosm.lesions$infected[n] <- 0
  }
}

mesocosm.lesions$field.prevalence <- 0
for (n in 1:length(mesocosm.lesions$site)) {
  if (mesocosm.lesions$site[n] == "LP")
  {mesocosm.lesions$field.prevalence[n] = 0.29
  }else if (mesocosm.lesions$site[n] == "NB")
  {mesocosm.lesions$field.prevalence[n] = 0.47
  } else if (mesocosm.lesions$site[n] == "DC")
  {mesocosm.lesions$field.prevalence[n] = 0.61
  }  else {
    mesocosm.lesions$field.prevalence[n] = 0.69
    }
}

##mesocosm lesions new
mesocosm.lesions.new <- mesocosm.leaf %>%
  filter(shoot.no != 0 & experiment.day == 28 & exp.leaf.no != "1" & exp.leaf.no != "2" & exp.leaf.no != "3" & exp.leaf.no != "4" & exp.leaf.no != "5") %>%
  dplyr::select(c(month, year, mesocosm, vase, infection, site, experiment.day, S1.no.leaves, area.cm, wd.lesion.area, wd.lesion.pc, lesion.presence, lesion.absence, exp.day.appeared, notes)) %>%
  group_by(month, year, mesocosm, vase, infection, site, experiment.day) %>%
  summarize(S1.no.leaves = mean(S1.no.leaves, na.rm = T), area.cm = sum(area.cm, na.rm = T), lesion.area = sum(wd.lesion.area, na.rm = T), WSWI = mean(wd.lesion.pc, na.rm = T), lesion.presence = sum(lesion.presence, na.rm = T), lesion.absence = sum(lesion.absence, na.rm = T), exp.day.appeared = mean(exp.day.appeared, na.rm = T))

mesocosm.lesions.new$lesions.pc <- (mesocosm.lesions.new$lesion.area/mesocosm.lesions.new$area.cm)*100
for (n in 1:length(mesocosm.lesions.new$lesions.pc)) {
  if (mesocosm.lesions.new$lesions.pc[n] == "NaN") {
    mesocosm.lesions.new$lesions.pc[n] <- 0
  } else {
   mesocosm.lesions.new$lesions.pc[n] <- mesocosm.lesions.new$lesions.pc[n]
  }
}

mesocosm.lesions.new$infected <- 0
for (n in 1:length(mesocosm.lesions.new$infected)) {
  if (mesocosm.lesions.new$lesion.presence[n] >= 1) {
    mesocosm.lesions.new$infected[n] <- 1
  } else {
   mesocosm.lesions.new$infected[n] <- 0
  }
}

mesocosm.lesions.new$field.prevalence <- 0
for (n in 1:length(mesocosm.lesions.new$site)) {
  if (mesocosm.lesions.new$site[n] == "LP")
  {mesocosm.lesions.new$field.prevalence[n] = 0.29
  }else if (mesocosm.lesions.new$site[n] == "NB")
  {mesocosm.lesions.new$field.prevalence[n] = 0.47
  } else if (mesocosm.lesions.new$site[n] == "DC")
  {mesocosm.lesions.new$field.prevalence[n] = 0.61
  }  else {
    mesocosm.lesions.new$field.prevalence[n] = 0.69
    }
}

##mesocosm lesions old
mesocosm.lesions.old <- mesocosm.leaf %>%
  filter(shoot.no != 0 & experiment.day == 28 & exp.leaf.no != "-2" & exp.leaf.no != "-1" & exp.leaf.no != "0") %>%
  dplyr::select(c(month, year, mesocosm, vase, infection, site, experiment.day, S1.no.leaves, area.cm, wd.lesion.area, wd.lesion.pc, lesion.presence, lesion.absence, exp.day.appeared, notes)) %>%
  group_by(month, year, mesocosm, vase, infection, site, experiment.day) %>%
  summarize(S1.no.leaves = mean(S1.no.leaves, na.rm = T), area.cm = sum(area.cm, na.rm = T), lesion.area = sum(wd.lesion.area, na.rm = T), WSWI = mean(wd.lesion.pc, na.rm = T), lesion.presence = sum(lesion.presence, na.rm = T), lesion.absence = sum(lesion.absence, na.rm = T), exp.day.appeared = mean(exp.day.appeared, na.rm = T))

mesocosm.lesions.old$lesions.pc <- (mesocosm.lesions.old$lesion.area/mesocosm.lesions.old$area.cm)*100
for (n in 1:length(mesocosm.lesions.old$lesions.pc)) {
  if (mesocosm.lesions.old$lesions.pc[n] == "NaN") {
    mesocosm.lesions.old$lesions.pc[n] <- 0
  } else {
   mesocosm.lesions.old$lesions.pc[n] <- mesocosm.lesions.old$lesions.pc[n]
  }
}

mesocosm.lesions.old$infected <- 0
for (n in 1:length(mesocosm.lesions.old$infected)) {
  if (mesocosm.lesions.old$lesion.presence[n] >= 1) {
    mesocosm.lesions.old$infected[n] <- 1
  } else {
   mesocosm.lesions.old$infected[n] <- 0
  }
}

mesocosm.lesions.old$field.prevalence <- 0
for (n in 1:length(mesocosm.lesions.old$site)) {
  if (mesocosm.lesions.old$site[n] == "LP")
  {mesocosm.lesions.old$field.prevalence[n] = 0.29
  }else if (mesocosm.lesions.old$site[n] == "NB")
  {mesocosm.lesions.old$field.prevalence[n] = 0.47
  } else if (mesocosm.lesions.old$site[n] == "DC")
  {mesocosm.lesions.old$field.prevalence[n] = 0.61
  }  else {
    mesocosm.lesions.old$field.prevalence[n] = 0.69
    }
}


## Field Data
field.leaf <- read.csv("TRIAL2_field.csv")
field.leaf$quad <- as.factor(field.leaf$quad)

field.leaf$lesion.pc.2.test <- is.na(field.leaf$lesion.pc.2)
field.leaf <- field.leaf %>%
  filter(field.leaf$lesion.pc.2.test == FALSE) %>%
  dplyr::select(-lesion.pc.2.test)

field.leaf$lesion.present <- NA

for (n in 1:length(field.leaf$lesion.pc.2)) {
  if (field.leaf$lesion.pc.2[n] <= 0) {
    field.leaf$lesion.present[n] <- 0
    } else {field.leaf$lesion.present[n] <- 1
  }
}

field.leaf$lesion.absent <- 1-field.leaf$lesion.present

field.leaf$quad.unique <- paste(field.leaf$site, field.leaf$quad, sep = "_")
  
str(field.leaf)

##2016
field.quad <- field.leaf %>%
  filter(year == "2016") %>%
  group_by(site, quad) %>%
  summarize(density = mean(shoot.m2, na.rm = T), canopy.height = mean(length.cm, na.rm = T), lesion.present = sum(lesion.present), lesion.absent = sum(lesion.absent), prevalence = sum(lesion.present)/(sum(lesion.present) + sum(lesion.absent)), leaf.no = mean(no.leaves, na.rm = T))

field.quad$leaf.density <- field.quad$density * field.quad$leaf.no

field.site.mean <- field.quad %>%
  group_by(site) %>%
  summarize(lesion.present = sum(lesion.present), lesion.absent = sum(lesion.absent), p.mean = mean(prevalence, na.rm = T), p.se = se(prevalence, na.rm = T), length.mean = mean(canopy.height, na.rm = T), shoot.density.mean = mean(density, na.rm = T), leaf.density.mean = mean(leaf.density, na.rm =T))

field.site.mean$leaf.loss <- c(2.18, 2.64, 1.82, 1.18)
field.site.mean$EWDSS <- c(0.77, 0.97, 0.89, 0.81)
field.site.mean$WSWI <- c(45.49, 53.06, 61.57, 38.28)
field.site.mean$site.cat <- c("bay", "fringe" , "fringe", "bay")
field.site.mean$beta <- c(0.295, 0.341, 0.434, 0.547)
field.site.mean$alpha <- c(0.057, 0.079, 0.070, 0.0001)

## Environmental Data
#d1.env <- read.csv("LabyInoc_T2_ZM_ENV_23JAN2017.csv")
#dfull.env <- read.csv("DC_Temp_2016_Complete.csv")
```


#GENERAL
#ANALYSES
#NOTES
```{r eval = FALSE, echo = FALSE}
# 1) HOW TO TREAT MESOCOSM IN MODELS?
  #Currently treating it as a BLOCKING EFFECT (Random effect gives errors in survival and shoot production models?)

# 2) LOG RESPONSE RATIO vs. SITE*INFECTION INTERACTION?
  #Starting with SITE*INFECTION interaction because less complex
```

#MESOCOSM
#Question 1: What are the effects of wasting disease on seagrass physiology and morphology
##Survival
```{r eval = FALSE, echo = FALSE}
#KM curves
surv_object <- Surv(time = mesocosm.survival$mortality.day, event = mesocosm.survival$stat)
fit.infection <- survfit(surv_object ~ infection, data = mesocosm.survival)
summary(fit.infection)
ggsurvplot(fit.infection, data = mesocosm.survival, pval = TRUE)
survdiff(surv_object ~ infection, data = mesocosm.survival)

fit.site <- survfit(surv_object ~ site, data = mesocosm.survival)
summary(fit.site)
ggsurvplot(fit.site, data = mesocosm.survival, pval = TRUE)

fit.mesocosm <- survfit(surv_object ~ mesocosm, data = mesocosm.survival)
summary(fit.mesocosm)
ggsurvplot(fit.mesocosm, data = mesocosm.survival, pval = TRUE)

#CoxPH --> doesn't work for site
#fit.coxph <- coxph(surv_object ~ infection, data = mesocosm.shoot)
#ggforest(fit.coxph, data = mesocosm.shoot)

p <- ggplot(mesocosm.shoot, aes(x = site, y = survival, fill = infection)) + 
  scale_fill_manual(values = c("white", "gray")) +
  geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.5) +
  stat_summary(fun.y = mean, geom = "point", size = 3, color = "red", position = position_dodge(1)) +
  labs(x = "Source Site", y = "Proportion seagrass survived") +
  theme_classic()
p

##NEED TO FIGURE OUT ANALYSES with Random effects!!
m.survival <- glm(cbind(survival, mortality) ~ site*infection + mesocosm, family = binomial, data = mesocosm.shoot)
anova(m.survival, test = "LR") #significant effect of infection
Anova(m.survival) ##use this for P values (package = car)
summary(m.survival)

m.survival <- glmer(cbind(survival, mortality) ~ site*infection + (1|mesocosm), family = binomial, data = mesocosm.shoot)
anova(m.survival)

#summary stats
prop.mortality <- subset(mesocosm.shoot, infection == "Y")
sum(prop.mortality$survival)

```

##Shoot Production
```{r eval = FALSE, echo = FALSE}
p <- ggplot(filter(mesocosm.shoot, vase != 17 & vase != 21 & vase != 27 & vase != 29 & vase != 37 & vase != 47 & vase != 59), aes(x = site, y = shoot.production)) + 
  #scale_fill_manual(values = c("white", "gray")) +
  #geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.5) +
  stat_summary(fun.y = mean, geom = "point", size = 3, color = "red", position = position_dodge(1)) +
  labs(x = "Source Site", y = "# New shoots produced") +
  theme_classic()
p

##NEED To sort out THIS ANALYSIS !! ... marginal effect of site
m.new.shoots <- aov(shoot.production ~ site * infection + mesocosm, data = filter(mesocosm.shoot, vase != 17 & vase != 21 & vase != 27 & vase != 29 & vase != 37 & vase != 47 & vase != 59))
Anova(m.new.shoots)

posthoc.new.shoots <- TukeyHSD(m.new.shoots)
posthoc.new.shoots
multcompLetters(posthoc.new.shoots$`site`[,"p adj"])

m.new.shoots <- lmer(shoot.production ~ site*infection + (1|mesocosm), data = mesocosm.shoot)
Anova(m.new.shoots) #significant effect of site
m.new.shoots <- glm(cbind(shoot.production, no.shoot.production) ~ site*infection + mesocosm, family = binomial, data = mesocosm.shoot)
anova(m.new.shoots, test = "LR")
Anova(m.new.shoots)#significant effect of infection ##use this for P values (package = car)
summary(m.new.shoots)

summary(glht(m.new.shoots, mcp(site = "Tukey"))) ##ERRORS

prop.new.shoot <- subset(mesocosm.shoot, infection == "Y")
sum(prop.new.shoot$shoot.production, na.rm = T)

new.shoot.mean <- mesocosm.shoot %>%
  group_by(site) %>%
  summarize(new.shoot.mean = mean(shoot.production, na.rm = T), new.shoot.se = se(shoot.production, na.rm = T))
```

##Leaf number
```{r eval = FALSE, echo = FALSE}
p <- ggplot(mesocosm.shoot, aes(x = infection, y = no.leaves.initial)) + 
  #scale_fill_manual(values = c("white", "gray")) +
  geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.5) +
  stat_summary(fun.y = mean, geom = "point", size = 3, color = "red", position = position_dodge(1)) +
  labs(x = "Inoculation Treatment", y = "Number of New Leaves Produced") +
  theme_classic()
p

m.leaves.initial <- aov(no.leaves.initial ~ site*infection + mesocosm, data = mesocosm.shoot)
anova(m.leaves.initial) #significant effect of infection (# of leaves intitial included as a covariate but not significant so removed)
shapiro.test(residuals(m.leaves.initial)) #passed
leveneTest(m.leaves.initial) #passed
plot(m.leaves.initial) #distribution looks ok
hist(residuals(m.leaves.initial), main = '') #residuals look pretty normal

#MESOCOSM AS RANDOM EFFECT
m.leaves.initial <- lmer(no.leaves.initial ~ site*infection + (1|mesocosm), data = mesocosm.shoot)
anova(m.leaves.initial)

#Summary statistics
leaf.initial.means <- mesocosm.shoot %>%
  group_by(site) %>%
  summarize(mean.leaves.initial = mean(no.leaves.initial, na.rm = T), SE.new.leaves = se(no.leaves.initial, na.rm = T))

#DC, NB, LP mean leaf #
(3.5 + 3.64 + 3.59)/3 #= 3.58
#WB mean leaf # = 2.64
```


##Leaf production
```{r eval = FALSE, echo = FALSE}
p <- ggplot(filter(mesocosm.shoot, vase != 17 & vase != 21 & vase != 27 & vase != 29 & vase != 37 & vase != 47 & vase != 59), aes(x = site, y = no.leaves.new.final, fill = infection)) + 
  scale_fill_manual(values = c("white", "gray")) +
  geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.5) +
  stat_summary(fun.y = mean, geom = "point", size = 3, color = "red", position = position_dodge(1)) +
  labs(x = "site", y = "Number of New Leaves Produced") +
  theme_classic()
p

p <- ggplot(mesocosm.shoot, aes(x = infection, y = no.leaves.new.final)) + 
  #scale_fill_manual(values = c("white", "gray")) +
  geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.5) +
  stat_summary(fun.y = mean, geom = "point", size = 3, color = "red", position = position_dodge(1)) +
  labs(x = "Inoculation Treatment", y = "Number of New Leaves Produced") +
  theme_classic()
p

m.new.leaves <- aov(no.leaves.new.final ~ site*infection + mesocosm + no.leaves.initial, data = filter(mesocosm.shoot, vase != 17 & vase != 21 & vase != 27 & vase != 29 & vase != 37 & vase != 47 & vase != 59))
Anova(m.new.leaves) #significant effect of infection (# of leaves intitial included as a covariate but not significant so removed)
shapiro.test(residuals(m.new.leaves)) #passed
leveneTest(m.new.leaves) #passed
plot(m.new.leaves) #distribution looks ok
hist(residuals(m.new.leaves), main = '') #residuals look pretty normal

posthoc.new.leaves <- TukeyHSD(aov(no.leaves.new.final ~ site*infection + mesocosm, data = mesocosm.shoot))
posthoc.new.leaves
multcompLetters(posthoc.new.leaves$site [,"p adj"])

#MESOCOSM AS RANDOM EFFECT
m.new.leaves <- lmer(no.leaves.new.final ~ site*infection + (1|mesocosm), data = mesocosm.shoot)
Anova(m.new.leaves)

#Summary statistics
leaf.production.means <- mesocosm.shoot %>%
  filter(vase != 17 & vase != 21 & vase != 27 & vase != 29 & vase != 37 & vase != 47 & vase != 59) %>%
  group_by(infection, site) %>%
  summarize(mean.new.leaves = mean(no.leaves.new.final, na.rm = T), SE.new.leaves = se(no.leaves.new.final, na.rm = T), SD.new.leaves = sd(no.leaves.new.final, na.rm = T))

leaf.production.per.day.means <- mesocosm.shoot %>%
  filter(vase != 17 & vase != 21 & vase != 27 & vase != 29 & vase != 37 & vase != 47 & vase != 59) %>%
  group_by(infection, site) %>%
  summarize(mean.leaf.p = mean(leaf.p, na.rm = T), SE.leaf.p = se(leaf.p, na.rm = T), SD.leaf.p = sd(leaf.p, na.rm = T))

#leaves produced/leaf: healthy DC, NB, LP
1.88/3.58 #= 0.53
#leaves produced/leaf: healthy WB
1.88/2.64 #= 0.71
#leaves produced/leaf: infected DC, NB, LP
1.21/3.58 #=0.34
#leaves produced/leaf: infected WB
1.21/2.64 #=0.46
```

##Leaf loss
```{r eval = FALSE, echo = FALSE}
p <- ggplot(filter(mesocosm.shoot, vase != 17 & vase != 21 & vase != 27 & vase != 29 & vase != 37 & vase != 47 & vase != 59), aes(x = site, y = no.leaves.lost.final, fill = infection)) + #removing infected controls
  scale_fill_manual(values = c("white", "gray")) +
  geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.5) +
  stat_summary(fun.y = mean, geom = "point", size = 3, color = "red", position = position_dodge(1)) +
  labs(x = "Source Site", y = "Number of Leaves Lost") +
  theme_classic()
p

m.lost.leaves <- aov(no.leaves.lost.final ~ site*infection + mesocosm + no.leaves.initial, data = filter(mesocosm.shoot,vase != 17 & vase != 21 & vase != 27 & vase != 29 & vase != 37 & vase != 47 & vase != 59))
Anova(m.lost.leaves) #significant effect of infection*site (# of leaves intitial included as a covariate)
shapiro.test(residuals(m.lost.leaves)) #pass
leveneTest(m.lost.leaves) #pass
plot(m.lost.leaves) #distribution looks ok
hist(residuals(m.lost.leaves), main = '') #residuals look pretty normal

posthoc.lost.leaves <- TukeyHSD(aov(no.leaves.lost.final ~ site*infection + mesocosm, data = filter(mesocosm.shoot,vase != 17 & vase != 21 & vase != 27 & vase != 29 & vase != 37 & vase != 47 & vase != 59)))
posthoc.lost.leaves
multcompLetters(posthoc.lost.leaves$`site:infection`[,"p adj"])

m.lost.leaves <- lmer(no.leaves.lost.final ~ site*infection + no.leaves.initial + (1|mesocosm), data = mesocosm.shoot)
anova(m.lost.leaves)
summary(m.lost.leaves)

#posthoc tests
lost.leaves.lsmo <- lsmeans::lsmeans(m.lost.leaves, ~site:infection)
lost.leaves.cld <- cld(lost.leaves.lsmo, adjust = 'tukey')
lost.leaves.cld

#Summary statistics
leaf.loss.means <- mesocosm.shoot %>%
  group_by(infection, site) %>%
  filter(vase != 17 & vase != 21 & vase != 27 & vase != 29 & vase != 37 & vase != 47 & vase != 59) %>%
  summarize(mean.lost.leaves = mean(no.leaves.lost.final, na.rm = T), SE.lost.leaves = se(no.leaves.lost.final, na.rm = T), SD.lost.leaves = sd(no.leaves.lost.final, na.rm = T))

leaf.loss.per.day.means <- mesocosm.shoot %>%
  filter(vase != 17 & vase != 21 & vase != 27 & vase != 29 & vase != 37 & vase != 47 & vase != 59) %>%
  group_by(infection, site) %>%
  summarize(mean.leaf.l = mean(leaf.l, na.rm = T), SE.leaf.l = se(leaf.l, na.rm = T), SD.leaf.l = sd(leaf.l, na.rm = T))


#DC healthy: 1.3/3.58 = 0.36; NB healthy: 0.64/3.58 = 0.18; LP healthy: 0.64/3.58 = 0.18; WB healthy: 0.73/2.64 = 0.28
#DC infected: 2/3.58 = 0.56; NB infected: 1.82/3.58 = 0.51; LP infected: 2.7/3.58 = 0.75; WB infected: 1.22/2.64 = 0.46

#only diseased shoots
#m.lost.leaves.disease <- aov(no.leaves.lost.final ~ site + mesocosm + no.leaves.initial, data = filter(mesocosm.shoot, infection == "Y"))
#anova(m.lost.leaves.disease)
#shapiro.test(residuals(m.lost.leaves.disease)) #pass
#leveneTest(m.lost.leaves.disease) #pass (removed mesocosm and initial leaf variables)
#plot(m.lost.leaves.disease) #distribution looks ok
#hist(residuals(m.lost.leaves.disease), main = '') #residuals look pretty normal

#posthoc.lost.leaves.disease <- TukeyHSD(aov(no.leaves.lost.final ~ site, data = filter(mesocosm.shoot, infection == "Y")))
#posthoc.lost.leaves.disease
#multcompLetters(posthoc.lost.leaves.disease$`site`[,"p adj"])


## Leaf loss by field infection
p <- ggplot(filter(mesocosm.shoot, infection == "Y"), aes(x = field.prevalence, y = no.leaves.lost.final, fill = site)) + 
  scale_fill_manual(values = c("white", "gray20", "gray80", "black")) +
  #geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.5) +
  stat_summary(fun.y = mean, geom = "point", size = 3, color = "red", position = position_dodge(1)) +
  labs(x = "Field prevalence", y = "Number of Leaves Lost") +
  theme_classic()
p
```

##leaf growth
```{r eval = FALSE, echo = FALSE}
p <- ggplot(filter(mesocosm.growth, vase != 17 & vase != 21 & vase != 27 & vase != 29 & vase != 37 & vase != 47 & vase != 59), aes(x = site, y = leaf1.growth)) + 
  #scale_fill_manual(values = c("white", "gray")) +
  geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.5) +
  stat_summary(fun.y = mean, geom = "point", size = 3, color = "red", position = position_dodge(1)) +
  labs(x = "Source Site", y = "Leaf 1 growth cm per day") +
  theme_classic()
p
p <- ggplot(filter(mesocosm.growth, vase != 17 & vase != 21 & vase != 27 & vase != 29 & vase != 37 & vase != 47 & vase != 59), aes(x = infection, y = leaf1.growth)) + 
  #scale_fill_manual(values = c("white", "gray")) +
  geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.5) +
  stat_summary(fun.y = mean, geom = "point", size = 3, color = "red", position = position_dodge(1)) +
  labs(x = "Inoculation Treatment", y = "Leaf 1 growth cm per day") +
  theme_classic()
p

m.leaf1.growth <- aov(leaf1.growth ~ site*infection + mesocosm + initial.length.cm, data = filter(mesocosm.growth, vase != 17 & vase != 21 & vase != 27 & vase != 29 & vase != 37 & vase != 47 & vase != 59))
Anova(m.leaf1.growth) #significant effect of infection (# of leaves intitial included as a covariate)
shapiro.test(residuals(m.leaf1.growth)) #pass
leveneTest(m.leaf1.growth) # pass, without mesocosm or initial length in model
plot(m.leaf1.growth) #distribution looks ok
hist(residuals(m.leaf1.growth), main = '') #residuals look pretty normal

posthoc.growth <- TukeyHSD(aov(leaf1.growth ~ site*infection + mesocosm, data = mesocosm.growth))
posthoc.growth
multcompLetters(posthoc.growth$`site`[,"p adj"])

m.leaf1.growth <- lmer(leaf1.growth ~ site*infection + initial.length.cm + (1|mesocosm), data = mesocosm.growth)
anova(m.leaf1.growth)

#Summary statistics
leaf1.growth.means <- mesocosm.growth %>%
  filter(vase != 17 & vase != 21 & vase != 27 & vase != 29 & vase != 37 & vase != 47 & vase != 59) %>%
  group_by(infection) %>%
  summarize(mean.leaf1.growth = mean(leaf1.growth, na.rm = T), SE.leaf1.growth = se(leaf1.growth, na.rm = T))
```

##Aboveground biomass
```{r eval = FALSE, echo = FALSE}
p <- ggplot(filter(mesocosm.shoot,vase != 17 & vase != 21 & vase != 27 & vase != 29 & vase != 37 & vase != 47 & vase != 59), aes(x = site, y = ag.biomass.final)) + 
  #scale_fill_manual(values = c("white", "gray")) +
  geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.5) +
  stat_summary(fun.y = mean, geom = "point", size = 3, color = "red", position = position_dodge(1)) +
  labs(x = "Source Site", y = "Aboveground Biomass g") +
  theme_classic()
p

p <- ggplot(filter(mesocosm.shoot,vase != 17 & vase != 21 & vase != 27 & vase != 29 & vase != 37 & vase != 47 & vase != 59), aes(x = infection, y = ag.biomass.final)) + 
  #scale_fill_manual(values = c("white", "gray")) +
  geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.5) +
  stat_summary(fun.y = mean, geom = "point", size = 3, color = "red", position = position_dodge(1)) +
  labs(x = "Source Site", y = "Aboveground Biomass g") +
  theme_classic()
p

m.ag.biomass <- aov(ag.biomass.final ~ site*infection + mesocosm, data = filter(mesocosm.shoot,vase != 17 & vase != 21 & vase != 27 & vase != 29 & vase != 37 & vase != 47 & vase != 59))
Anova(m.ag.biomass) #significant effect of infection (# of leaves intitial included as a covariate)
shapiro.test(residuals(m.ag.biomass)) #pass
leveneTest(m.ag.biomass) #pass run on model without mesocosm
plot(m.ag.biomass) #distribution looks ok
hist(residuals(m.ag.biomass), main = '') #residuals look pretty normal

posthoc.ag.biomass <- TukeyHSD(aov(ag.biomass.final ~ site*infection, data = mesocosm.shoot))
posthoc.ag.biomass
multcompLetters(posthoc.ag.biomass$`site`[,"p adj"])

m.ag.biomass <- lmer(ag.biomass.final ~ site*infection + (1|mesocosm), data = mesocosm.shoot)
anova(m.ag.biomass)

#posthoc tests
ag.lsmo <- lsmeans::lsmeans(m.ag.biomass, ~site)
ag.lsmo.cld <- cld(ag.lsmo, adjust = 'tukey')
ag.lsmo.cld

#Summary statistics
ag.biomass.means <- mesocosm.shoot %>%
  filter(vase != 17 & vase != 21 & vase != 27 & vase != 29 & vase != 37 & vase != 47 & vase != 59) %>%
  group_by(infection, site) %>%
  summarize(mean.ag.biomass = mean(ag.biomass.final, na.rm = T), SE.ag.biomass = se(ag.biomass.final, na.rm = T))
```

##Belowground Biomass
```{r eval = FALSE, echo = FALSE}
p <- ggplot(filter(mesocosm.shoot,vase != 17 & vase != 21 & vase != 27 & vase != 29 & vase != 37 & vase != 47 & vase != 59), aes(x = site, y = bg.biomass.final)) + 
  #scale_fill_manual(values = c("white", "gray")) +
  geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.5) +
  stat_summary(fun.y = mean, geom = "point", size = 3, color = "red", position = position_dodge(1)) +
  labs(x = "Source Site", y = "Belowground Biomass g") +
  theme_classic()
p

p <- ggplot(filter(mesocosm.shoot, vase != 17 & vase != 21 & vase != 27 & vase != 29 & vase != 37 & vase != 47 & vase != 59), aes(x = infection, y = bg.biomass.final)) + 
  #scale_fill_manual(values = c("white", "gray")) +
  geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.5) +
  stat_summary(fun.y = mean, geom = "point", size = 3, color = "red", position = position_dodge(1)) +
  labs(x = "Source Site", y = "Aboveground Biomass g") +
  theme_classic()
p

m.bg.biomass <- aov(bg.biomass.final ~ site*infection + mesocosm, data = filter(mesocosm.shoot,vase != 17 & vase != 21 & vase != 27 & vase != 29 & vase != 37 & vase != 47 & vase != 59))
Anova(m.bg.biomass) #significant effect of infection and site
shapiro.test(residuals(m.bg.biomass)) #pass
leveneTest(m.bg.biomass) #pass run on model without mesocosm
plot(m.bg.biomass) #distribution looks ok
hist(residuals(m.bg.biomass), main = '') #residuals look pretty normal

posthoc.bg.biomass <- TukeyHSD(aov(bg.biomass.final ~ site*infection + mesocosm, data = filter(mesocosm.shoot,vase != 17 & vase != 21 & vase != 27 & vase != 29 & vase != 37 & vase != 47 & vase != 59)))
posthoc.bg.biomass
multcompLetters(posthoc.bg.biomass$`site`[,"p adj"])

m.bg.biomass <- lmer(bg.biomass.final ~ site*infection + (1|mesocosm), data = mesocosm.shoot)
anova(m.bg.biomass)

#posthoc tests
bg.lsmo <- lsmeans::lsmeans(m.bg.biomass, ~site)
bg.lsmo.cld <- cld(bg.lsmo, adjust = 'tukey')
bg.lsmo.cld

#Summary statistics
bg.biomass.means <- mesocosm.shoot %>%
  filter(vase != 17 & vase != 21 & vase != 27 & vase != 29 & vase != 37 & vase != 47 & vase != 59) %>%
  group_by(site) %>%
  summarize(mean.bg.biomass = mean(bg.biomass.final, na.rm = T), SE.bg.biomass = se(bg.biomass.final, na.rm = T))
```

##Rhizome Growth
```{r eval = FALSE, echo = FALSE}
p <- ggplot(filter(mesocosm.shoot,vase != 17 & vase != 21 & vase != 27 & vase != 29 & vase != 37 & vase != 47 & vase != 59), aes(x = site, y = rhizome.growth, fill = infection)) +
  scale_fill_manual(values = c("white", "gray")) +
  geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.5) +
  stat_summary(fun.y = mean, geom = "point", size = 3, color = "red", position = position_dodge(1)) +
  labs(x = "Source Site", y = "Rhizome growth cm day-1") +
  theme_classic()
p

m.rhizome.growth <- aov(rhizome.growth ~ site*infection + mesocosm, data = filter(mesocosm.shoot, vase != 17 & vase != 21 & vase != 27 & vase != 29 & vase != 37 & vase != 47 & vase != 59))
Anova(m.rhizome.growth) #significant interaction of infection and site
shapiro.test(residuals(m.rhizome.growth)) #pass
leveneTest(m.rhizome.growth) #pass, run on model without mesocosm
plot(m.rhizome.growth) #distribution looks ok
hist(residuals(m.rhizome.growth), main = '') #residuals look pretty normal

posthoc.rhizome.growth <- TukeyHSD(aov(rhizome.growth ~ site*infection + mesocosm, data = filter(mesocosm.shoot, vase != 17 & vase != 21 & vase != 27 & vase != 29 & vase != 37 & vase != 47 & vase != 59)))
posthoc.rhizome.growth
multcompLetters(posthoc.rhizome.growth$`site:infection`[,"p adj"])

m.rhizome.growth <- lmer(rhizome.growth ~ site*infection + (1|mesocosm), data = mesocosm.shoot)
anova(m.rhizome.growth)

#posthoc tests
rz.lsmo <- lsmeans::lsmeans(m.rhizome.growth, ~site:infection)
rz.lsmo.cld <- cld(rz.lsmo, adjust = 'tukey')
rz.lsmo.cld

#Summary statistics
rhizome.growth.means <- mesocosm.shoot %>%
  filter( vase != 17 & vase != 21 & vase != 27 & vase != 29 & vase != 37 & vase != 47 & vase != 59)%>%
  group_by(site, infection) %>%
  summarize(mean.rhizome.growth = mean(rhizome.growth, na.rm = T), SE.rhizome.growth = se(rhizome.growth, na.rm = T))
```

##Lesion Percent cover
```{r eval = FALSE, echo = FALSE}
#proportion of new leaves infected (leaves produced during exp.)
p <- ggplot(filter(mesocosm.leaf, experiment.day == "28" & infection == "Y" & shoot.no != 0 & exp.leaf.no != "1" & exp.leaf.no != "2" & exp.leaf.no != "3" & exp.leaf.no != "4" & exp.leaf.no != "5"), aes(x = field.prevalence, y = lesion.presence, fill = site)) + #& exp.leaf.no != "-2" & exp.leaf.no != "4" & exp.leaf.no != "5" 
  scale_fill_manual(values = c("black", "gray80", "gray30", "white")) +
  #geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(0), dotsize  = 0.5) +
  stat_summary(fun.y = mean, geom = "point", size = 1, color = "red", position = position_dodge(0)) +
  labs(x = "Field prevalence", y = "Lesion presence") +
  ylim(0,1) +
  xlim (0,1) +
  theme_classic()
p

#proportion of exp leaf 1 infected (youngest leaf present at the start of exp.)
p <- ggplot(filter(mesocosm.leaf, experiment.day == "28" & infection == "Y" & shoot.no != 0 & exp.leaf.no == "1"), aes(x = field.prevalence, y = lesion.presence, fill = site)) + #& exp.leaf.no != "-2" & exp.leaf.no != "4" & exp.leaf.no != "5" 
  scale_fill_manual(values = c("black", "gray80", "gray30", "white")) +
  #geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(0), dotsize  = 0.5) +
  stat_summary(fun.y = mean, geom = "point", size = 1, color = "red", position = position_dodge(0)) +
  labs(x = "Field prevalence", y = "Lesion presence") +
  ylim(0,1) +
  xlim (0,1) +
  theme_classic()
p

m.severity.L1 <- glm(cbind(lesion.presence, lesion.absence) ~ field.prevalence, family = binomial, data = filter(mesocosm.leaf, experiment.day == "28" & infection == "Y" & shoot.no != 0 & exp.leaf.no != "-2" & exp.leaf.no != "-1" & exp.leaf.no != "1" & exp.leaf.no != "2" & exp.leaf.no != "3" & exp.leaf.no != "4" & exp.leaf.no != "5"))
Anova(m.severity.L1, test = "LR") ##use this for P values (package = car)
summary(m.severity.L1)

m.severity.LNEW <- glm(cbind(lesion.presence, lesion.absence) ~ field.prevalence, family = binomial, data = filter(mesocosm.leaf, experiment.day == "28" & infection == "Y" & shoot.no != 0 & exp.leaf.no != "1" & exp.leaf.no != "2" & exp.leaf.no != "3" & exp.leaf.no != "4" & exp.leaf.no != "5"))
Anova(m.severity.LNEW, test = "LR") ##use this for P values (package = car)
summary(m.severity.LNEW)

m.severity.LOLD <- glm(cbind(lesion.presence, lesion.absence) ~ field.prevalence, family = binomial, data = filter(mesocosm.leaf, experiment.day == "28" & infection == "Y" & shoot.no != 0 & exp.leaf.no != "-2" & exp.leaf.no != "-1" & exp.leaf.no != "0"))
Anova(m.severity.LOLD, test = "LR") ##use this for P values (package = car)
summary(m.severity.LOLD)

##Proportion of leaves infected (One plot of healthy, one plot of diseased)
p <- ggplot(filter(mesocosm.lesions, infection == "N"), aes(x = field.prevalence, y = lesion.presence/(lesion.presence+lesion.absence), fill = site)) +
  scale_fill_manual(values = c("white", "gray20", "gray80", "black")) + #"gray20", "gray80", 
  #geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.5) +
  stat_summary(fun.y = mean, geom = "point", size = 1, color = "red", position = position_dodge(1)) +
  labs(x = "Field pravalence", y = "Proportion of leaves infected") +
  ylim(0,1) +
  xlim(0,1) +
  theme_classic()
p

m.severity <- glm(cbind(lesion.presence, lesion.absence) ~ field.prevalence, family = binomial, data = filter(mesocosm.lesions, infection == "Y"))
anova(m.severity, test = "LR") #significant effect of site
Anova(m.severity, test = "LR") ##use this for P values (package = car)
summary(m.severity)

#how to post-hoc?

##Proportion of shoots infected in healthy treatment
p <- ggplot(filter(mesocosm.lesions, experiment.day == "28" & infection == "N"), aes(x = site, y = infected, fill = site)) + #& exp.leaf.no != "-2" & exp.leaf.no != "4" & exp.leaf.no != "5" 
  scale_fill_manual(values = c("white", "gray80", "gray20", "black")) +
  #geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.5) +
  stat_summary(fun.y = mean, geom = "point", size = 1, color = "red", position = position_dodge(1)) +
  labs(x = "site.", y = "infected") +
  ylim(0,1) +
  theme_classic()
p

#Lesion percent cover means
p <- ggplot(filter(mesocosm.lesions, infection == "Y"), aes(x = field.prevalence, y = lesions.pc, fill = site)) +
  scale_fill_manual(values = c("white", "gray20", "gray80", "black")) +
  #geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.5) +
  stat_summary(fun.y = mean, geom = "point", size = 1, color = "red", position = position_dodge(1)) +
  labs(x = "Field prevalence", y = "Mean lesion percent cover per shoot") +
  ylim(0,100) +
  theme_classic()
p

m.lesion.pc.d28.all <- glm(lesions.pc ~ field.prevalence, data = filter(mesocosm.lesions, infection == "Y")) ##Including leaves with 0% infection, exclude leaves 4 and 5 because of lack of replication across sites, lesion.pc.y not significant so removed from model
Anova(m.lesion.pc.d28.all) #significant interaction of infection and leaf number
shapiro.test(residuals(m.lesion.pc.d28.all)) #fail
leveneTest(m.lesion.pc.d28.all) #fail, run on model without shoot.id or mesocosm
plot(m.lesion.pc.d28.all) #does not look good
hist(residuals(m.lesion.pc.d28.all), main = '') #residuals look pretty normal



posthoc.d28.lesions <- TukeyHSD(aov(lesion.pc ~ infection*site*exp.leaf.no + mesocosm + shoot.ID, data = filter(mesocosm.leaf, experiment.day == "28" & exp.leaf.no != "-2" & exp.leaf.no !="4" & exp.leaf.no != "5")))
posthoc.d28.lesions
multcompLetters(posthoc.d28.lesions$`infection:exp.leaf.no`[,"p adj"])

#summary statistics
lesion.pc.d28.means <- lesion.pc.d28 %>%
  group_by(exp.leaf.no, infection) %>%
  summarize(mean.lesion.pc = mean(lesion.pc, na.rm= T), SE.lesion.pc = se(lesion.pc, na.rm = T))

#Appearance date of new leaves
p <- ggplot(filter(mesocosm.leaf, experiment.day == "28" & infection == "Y" & shoot.no != 0 & exp.leaf.no != "1" & exp.leaf.no != "2" & exp.leaf.no != "3" & exp.leaf.no != "4" & exp.leaf.no != "5"), aes(x = site, y = exp.day.appeared, fill = lesion.presence.factor)) +
  scale_fill_manual(values = c("white","black")) +
  #geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(0), dotsize  = 0.5) +
  stat_summary(fun.y = mean, geom = "point", size = 1, color = "red", position = position_dodge(0)) +
  labs(x = "Leaf appearance day", y = "Lesion presence") +
  ylim(0,30) +
  #xlim (0,1) +
  theme_classic()
p

plot(lesion.presence ~ exp.day.appeared, data = filter(mesocosm.leaf, experiment.day == "28" & infection == "Y" & shoot.no != 0 & exp.leaf.no != "1" & exp.leaf.no != "2" & exp.leaf.no != "3" & exp.leaf.no != "4" & exp.leaf.no != "5"))
```

###Whole Shoot Wasting Index (modified) Day 28
```{r eval = FALSE, echo = FALSE}
WSWI.model <- aov(lesions.pc ~ site * infection + mesocosm, data = filter(mesocosm.lesions, vase != "22" & vase != "24")) ##mesocosm not significant so removed from the model; excluding plants that lost vectors in <10 days
Anova(WSWI.model)

posthoc.WSWI <- TukeyHSD(WSWI.model)
posthoc.WSWI
multcompLetters(posthoc.WSWI$`site:infection`[,"p adj"])

p <- ggplot(filter(mesocosm.lesions, vase != "22" & vase != "24"), aes(x = site, y = lesions.pc, fill = infection)) +
  scale_fill_manual(values = c("white", "black")) +
  #geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.5) +
  stat_summary(fun.y = mean, geom = "point", size = 1, color = "red", position = position_dodge(1)) +
  labs(x = "Site", y = "Mean lesion percent cover per shoot") +
  ylim(0,100) +
  theme_classic()
p

WSWI.mean <- mesocosm.lesions %>%
  group_by(infection, site) %>%
  summarize(WSWI.mean = mean(WSWI, na.rm = T), prop.inf.se = se(WSWI, na.rm = T))
```


###Eelgrass Wasting Diseae Shoot Severity Day 28
```{r eval = FALSE, echo = FALSE}
##total shoot
EWDSS.model <- glm(cbind(lesion.presence, lesion.absence) ~ site*infection + mesocosm + exp.day.appeared, family = binomial, data = mesocosm.lesions)
Anova(EWDSS.model, test = "LR") #something wrong in model (trouble with sites with no disease)

leastsquares2 = lsmeans::lsmeans(EWDSS.model,
                                 pairwise ~ site:infection,
                                 adjust = "tukey")
leastsquares2$contrasts
lsmeans::cld(leastsquares2,
             alpha = 0.05,
             type = "response",
             Letters = letters,
             adjust = "tukey")

summary(glht(EWDSS.model, mcp(site ="Tukey"))) ##Need to run interaction??

p <- ggplot(mesocosm.lesions, aes(x = site, y = lesion.presence/(lesion.presence+lesion.absence), fill = infection)) +
  scale_fill_manual(values = c("white", "black")) +
  #geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.5) +
  stat_summary(fun.y = mean, geom = "point", size = 1, color = "red", position = position_dodge(1)) +
  labs(x = "site", y = "infected") +
  ylim(0,1) +
  theme_classic()
p

mesocosm.lesions$prop.inf <- mesocosm.lesions$lesion.presence/(mesocosm.lesions$lesion.presence+mesocosm.lesions$lesion.absence)

mesocosm.lesions.means <- mesocosm.lesions %>%
  group_by(infection, site) %>%
  summarize(prop.inf.mean = mean(prop.inf, na.rm = T), prop.inf.se = se(prop.inf, na.rm = T))

##new leaves
EWDSS.model.new <- glm(cbind(lesion.presence, lesion.absence) ~ site + mesocosm + exp.day.appeared, family = binomial, data = filter(mesocosm.lesions.new, infection == "Y"))
Anova(EWDSS.model.new)

p <- ggplot(mesocosm.lesions.new, aes(x = site, y = lesion.presence/(lesion.presence+lesion.absence), fill = infection)) +
  scale_fill_manual(values = c("white", "black")) +
  #geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.5) +
  stat_summary(fun.y = mean, geom = "point", size = 1, color = "red", position = position_dodge(1)) +
  labs(x = "site.", y = "infected") +
  ylim(0,1) +
  theme_classic()
p

##old leaves
EWDSS.model.old <- glm(cbind(lesion.presence, lesion.absence) ~ site + mesocosm, family = binomial, data = filter(mesocosm.lesions.old, infection == "Y"))
Anova(EWDSS.model.old)

summary(glht(EWDSS.model.old, mcp(site ="Tukey")))

leastsquares2old = lsmeans::lsmeans(EWDSS.model.old,
                                 pairwise ~ site,
                                 adjust = "tukey")
leastsquares2old$contrasts
lsmeans::cld(leastsquares2old,
             alpha = 0.05,
             type = "response",
             Letters = letters,
             adjust = "tukey")

p <- ggplot(mesocosm.lesions.old, aes(x = site, y = lesion.presence/(lesion.presence+lesion.absence), fill = infection)) +
  scale_fill_manual(values = c("white", "black")) +
  #geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.5) +
  stat_summary(fun.y = mean, geom = "point", size = 1, color = "red", position = position_dodge(1)) +
  labs(x = "site.", y = "infected") +
  ylim(0,1) +
  theme_classic()
p

#leaf appearance by site
la.model <- aov(exp.day.appeared ~ site, data = mesocosm.lesions)
Anova(la.model)
```

###Adaptation to disease risk
```{r eval = FALSE, echo = FALSE}
##Adaptation to disease risk
m.ewdss.risk <- glm(cbind(lesion.presence, lesion.absence) ~ field.prevalence * infection + exp.day.appeared, family = binomial, data = mesocosm.lesions)
Anova(m.ewdss.risk, test = "LR")

p <- ggplot(mesocosm.lesions, aes(x = field.prevalence, y = lesion.presence/(lesion.presence+lesion.absence), color = infection)) +
  scale_color_manual(values = c("gray", "black")) +
  #geom_violin(position = position_dodge(1)) +
  #geom_dotplot(dotsize = 0.5) +
  geom_smooth(method = lm, se = F, fullrange = T) +
  stat_summary(fun.y = mean, geom = "point", size = 1) +
  labs(x = "Field prevalence", y = "infected") +
  xlim(0,1) +
  theme_classic()
p


```


#FIELD
###Prevalence
```{r eval = FALSE, echo = FALSE}
##2016
p <- ggplot(filter(field.quad, canopy.height != 130.4 & canopy.height != 107.75 & canopy.height != 32.9), aes(x = canopy.height, y = prevalence, color = site)) +
  scale_color_manual(values = c("gray40","gray60", "gray90", "black")) +
  geom_point() +
  geom_smooth(method = lm, se = F, fullrange = F) +
  theme_classic()
p

p <- ggplot(field.quad, aes(x = site, y = lesion.present/10)) + 
  #scale_fill_manual(values = c("white", "gray")) +
  geom_boxplot(position = position_dodge(1)) +
  #geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.5) +
  stat_summary(fun.y = mean, geom = "point", size = 3, color = "black", position = position_dodge(1)) +
  labs(x = "Source Site", y = "Proportion seagrass infected") +
  theme_classic()
p

#prevalence by site with quad within site as a random variable
m.prevalence <- glmer(cbind(lesion.present, lesion.absent) ~ site + (1|quad.unique), family = binomial, data = filter(field.leaf, year == "2016"))
anova(m.prevalence, test = "LR") #significant effect of site
Anova(m.prevalence) ##use this for P values (package = car)
summary(m.prevalence)

##******* THIS IS THE 'MASTER' MODEL  ******
m.prevalence <- glm(cbind(lesion.present, lesion.absent) ~ site, family = binomial, data = field.quad)
Anova(m.prevalence, test = "LR")

summary(glht(m.prevalence, mcp(site="Tukey")))

#Multiple regression approach with length, density as fixed effects, and a random effect of quad ... or is this an ANCOVA
m.prevalence2.full <- glmer(cbind(lesion.present, lesion.absent) ~ length.cm + density.decm + site + (1|quad.unique), family = binomial, data = field.leaf.2016)
Anova(m.prevalence2.full)

#Multiple regression with canopy.height and density and random effect of site (using quad level data)
m.prevalence.quad <- lmer(prevalence ~ canopy.height + density + (1|site), data = field.quad)
Anova(m.prevalence.quad)

#Multiple regression with canopy.height and density and a fixed blocking effect of site (using quad level data)
m.prevalence.quad <- glm(cbind(lesion.present, lesion.absent) ~ canopy.height + density + site, family = binomial, data = field.quad) #density not significant so removed from model?
Anova(m.prevalence.quad)
summary(m.prevalence.quad)
shapiro.test(residuals(m.prevalence.quad)) #pass
plot(m.prevalence.quad) #distribution looks ok
hist(residuals(m.prevalence.quad), main = '')

summary(glht(m.prevalence.quad, mcp(site="Tukey")))

posthoc.prevalence.quad <- TukeyHSD(m.prevalence.quad)
posthoc.prevalence.quad
multcompLetters(posthoc.prevalence.quad$`site`[,"p adj"])

##### USE THIS FOR RESULTS multiple regression with site as a blocking factor???
##############################

#summary stats
field.lesion.prev <- field.leaf %>%
  filter(year == "2016") %>%
  group_by(site) %>%
  summarize(lesion.prevalence = sum(lesion.present)/(sum(lesion.present) + sum(lesion.absent)))

##Model selectino on disease ~ density and length
field.leaf.2016 <- field.leaf %>%
  filter(year == "2016")
field.leaf.2016.scale <- scale(field.leaf.2016[,c(8,17)], center = TRUE, scale = TRUE)#scaling data

field.leaf.2016$length.scale <- field.leaf.2016.scale[,1]
field.leaf.2016$density.scale <- field.leaf.2016.scale[,2]
field.leaf.2016$density.decm <- field.leaf.2016$shoot.m2/100

m.Dis1 <- glmer(cbind(lesion.present, lesion.absent) ~ length.cm + (1|site), family = binomial, data = field.leaf.2016)
summary(m.Dis1)

m.Dis2 <- glmer(cbind(lesion.present, lesion.absent) ~ density.decm + (1|site), family = binomial, data = field.leaf.2016)
summary(m.Dis2)

m.Dis3 <- glmer(cbind(lesion.present, lesion.absent) ~ length.cm + density.decm + (1|site), family = binomial, data = field.leaf.2016)
summary(m.Dis3)

AIC(m.Dis1, m.Dis2, m.Dis3)
AICctab(logLik(m.Dis1), logLik(m.Dis2), logLik(m.Dis3), delta = T, weights = T)

#making plot and figure out % increase in disease per cm
#Plot length effect, hold density at 200 shoots/m2 and Epiphytes at 1.8 mg/cm2
#dataset for predictions
tmpdat <- survey[, c("length.cm", "site")]
jvalues <- with(field.leaf.2016, seq(from = min(length.cm), to = max(length.cm), length.out = 477))

#predict results
LengthOut <- lapply(jvalues, function(j) {
  tmpdat$length.cm <- j
  predict(m.Dis1, newdata = tmpdat, type = "response")
})

plotLengthOut<- t(sapply(LengthOut, function(x) {
  c(M = mean(x), quantile(x, c(0.25, 0.75)))
}))

# create data frame and rename
plotLengthOut <- as.data.frame(cbind(plotLengthOut, jvalues))

colnames(plotLengthOut) <- c("PredictedProbability", "Lower", "Upper", "Length")

ppLength<-ggplot(plotLengthOut, aes(x = Length, y = PredictedProbability)) + geom_line() + geom_linerange(aes(ymin = Lower, ymax = Upper)) + ylim(c(0, 1)) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black"), panel.border = element_rect(colour = "black", fill=NA, size=1))+ylab("Probability of disease")+xlab("Shoot Length (cm)") +theme(text = element_text(size=16)) 
ppLength

prob.model <- lm(PredictedProbability ~ Length, data = plotLengthOut)
summary(prob.model)


##2017
p <- ggplot(filter(field.leaf, year == "2017" & leaf.no == "3"), aes(x = site, y = lesion.present)) + 
  #scale_fill_manual(values = c("white", "gray")) +
  geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.5) +
  stat_summary(fun.y = mean, geom = "point", size = 3, color = "red", position = position_dodge(1)) +
  labs(x = "Source Site", y = "Proportion seagrass infected") +
  theme_classic()
p

m.prevalence2017 <- glm(cbind(lesion.present, lesion.absent) ~ site, family = binomial, data = filter(field.leaf, year == "2017" & leaf.no == "3"))
anova(m.prevalence2017, test = "LR") #no effect of site
Anova(m.prevalence) ##use this for P values (package = car)
```

###Density
```{r eval = FALSE, echo = FALSE}
p <- ggplot(field.quad, aes(x = site, y = density)) + 
  #scale_fill_manual(values = c("white", "gray")) +
  geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.5) +
  stat_summary(fun.y = mean, geom = "point", size = 3, color = "red", position = position_dodge(1)) +
  labs(x = "Source Site", y = "Eelgrass density shoots/m2") +
  theme_classic()
p

plot(density.decm ~ prevalence, field.quad)

m.density <- aov(density ~ site, data = field.quad)
Anova(m.density) #no significant effects

#Summary statistics
field.density.means <- field.leaf.2016 %>%
  group_by(site) %>%
  summarize(mean.shoot.m2 = mean(shoot.m2, na.rm = T), SE.shoot.m2 = se(shoot.m2, na.rm = T))

mean(field.leaf.2016$shoot.m2) #=461 shoots/m2

#Leaf Density 
p <- ggplot(field.quad, aes(x = site, y = leaf.density.decm*100)) + 
  #scale_fill_manual(values = c("white", "gray")) +
  geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.5) +
  stat_summary(fun.y = mean, geom = "point", size = 3, color = "red", position = position_dodge(1)) +
  labs(x = "Source Site", y = "Eelgrass leaf density leaves/m2") +
  theme_classic()
p

m.leaf.density <- aov(leaf.density.decm ~ site, data = field.quad)
Anova(m.leaf.density) #marginal effect of site

#Summary statistics
field.leaf.density.means <- field.quad %>%
  group_by(site) %>%
  summarize(mean.leaves.m2 = mean(leaf.density.decm*100, na.rm = T), SE.leaves.m2 = se(leaf.density.decm*100, na.rm = T))

```

###Length
```{r eval = FALSE, echo = FALSE}
##2016
field.leaf$lesion.present.factor <- as.factor(field.leaf$lesion.present)

p <- ggplot(field.quad, aes(x = site, y = canopy.height)) + 
  scale_fill_manual(values = c("white", "gray")) +
  #geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.5) +
  stat_summary(fun.y = mean, geom = "point", size = 3, color = "red", position = position_dodge(1)) +
  labs(x = "Source Site", y = "Eelgrass length (cm)") +
  theme_classic()
p

p <- ggplot(field.leaf.2016, aes(x = lesion.present.factor, y = length.cm)) + 
  scale_fill_manual(values = c("white", "gray")) +
  #geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.5) +
  stat_summary(fun.y = mean, geom = "point", size = 3, color = "red", position = position_dodge(1)) +
  labs(x = "Lesion status", y = "Eelgrass length (cm)") +
  theme_classic()
p

m.length <- lmer(length.cm ~ site * lesion.present.factor + (1|quad.unique), data = field.leaf.2016)
summary(m.length) #significant effects of site and disease status
lmerTest::anova(m.length)

m.length <- lmer(length.cm ~ site + (1|quad.unique), data = field.leaf.2016)
Anova(m.length) #significant effect

m.length <- aov(canopy.height ~ site, data = field.quad)
Anova(m.length)
shapiro.test(residuals(m.length)) #pass
leveneTest(m.length) # pass
plot(m.length) #distribution looks ok
hist(residuals(m.length), main = '') #residuals look pretty normal

#posthoc tests
posthoc.length <- TukeyHSD(aov(canopy.height ~ site, data = field.quad))
posthoc.length
multcompLetters(posthoc.length$`site`[,"p adj"])

summary(glht(m.length, mcp(site="Tukey")))

length.lsmo <- lsmeans::lsmeans(m.length, ~site)
length.cld <- cld(length.lsmo, adjust = 'tukey')
length.cld

#summary statistics
field.length.summary <- field.quad %>%
  group_by(site) %>%
  summarize(length.mean = mean(canopy.height, na.rm = T), length.se = se(canopy.height, na.rm = T))

#DC, NB, LP length
(78.61+66.65+70.74)/3 #= 72

(66.7+70.7)/2

#WB length = 104.39

```

###leaf number
```{r eval = FALSE, echo = FALSE}
m.leaf.number <- lmer(no.leaves ~ site + lesion.present.factor + (1|quad.unique), data = field.leaf.2016)
summary(m.leaf.number) #significant effects of site and disease status
lmerTest::anova(m.leaf.number)

#posthoc tests
posthoc.leaf.number <- TukeyHSD(aov(no.leaves ~ site, data = field.leaf.2016))
posthoc.leaf.number
multcompLetters(posthoc.leaf.number$`site`[,"p adj"])

summary(glht(m.leaf.number, mcp(site="Tukey")))

leaf.number.lsmo <- lsmeans::lsmeans(m.leaf.number, ~site)
leaf.number.cld <- cld(leaf.number.lsmo, adjust = 'tukey')
leaf.number.cld

#summary statistics
field.leaf.number.summary <- field.leaf.2016 %>%
  group_by(site) %>%
  summarize(leaf.number.mean = mean(no.leaves, na.rm = T), leaf.number.se = se(no.leaves, na.rm = T))

#WB leaf number 3.0 * 461 shoots
#NB + LP leaf number 3.71 * 461 shoots
#DC leaf number 4.12 * 461 shoots

```


##Environmental Variables
```{r eval = FALSE, echo = FALSE}
# function to extract raster data within a radius defined by buffer (in meters...10000m = 10km)
buff <- function(rast,buffer=10000) {
  unlist(lapply(extract(rast, T2.geo, buffer=buffer ),mean,na.rm=T))
}

buffse <- function(rast,buffer=10000) {
  unlist(lapply(extract(rast, T2.geo, buffer=buffer ),se,na.rm=T))
}


#buff <- function(rast,buffer=10000) {
  #unlist(extract(rast, T2.geo, buffer=buffer ))
#}

########### Bio-ORACLE ##################
##Time period present 2000-2014
# get a list of files to work with
files <- list.files( "BioOracle Data/",pattern = ".asc")

# read in the raster data files and give appropriate projects (lat/lon WGS84)
r <- lapply( paste0("BioOracle Data/",files), raster )
# crop all rasters to same extent, and get rid of southern hemisphere
e <- extent(-180,180,0,70)
r2 <- lapply( r, function(rast) crop(rast,e) )

#Adding in site lat and long data frame
site <- c("Gloucester", "Nahant", "Manchester", "Beverly")
Longitude <- c(-70.65592, -70.91579, -70.80609, -70.85843)
Latitude <- c(42.59711, 42.42063, 42.55913, 42.54487)
#site <- c("Beverly")
#Longitude <- c(-70.85843)
#Latitude <- c(42.54487)
T2.site.LL <- data.frame(cbind(Longitude, Latitude))
T2.site.LL$site <- site
str(T2.site.LL)
T2.geo <- T2.site.LL[, c("Longitude", "Latitude")]
str(T2.geo)


# Use a buffer over which to look for surrounding cells that might have data and average them
# This will take a while for many variables
buffer <- 10000 #2km buffer ... no different from 10km buffer

# Apply the extract function to all rasters
T2.oracle <- lapply(r2, buff)
T2.oracle.se <- lapply(r2, buffse)

# combine all of these into a data.frame and give them names
Environmentals <- data.frame(do.call(cbind, T2.oracle))
Environmentals.se <- data.frame(do.call(cbind, T2.oracle.se))
names(Environmentals) <- c("Present.Surface.Diffuse.attenuation.Max", "Present.Surface.Diffuse.attenuation.Mean", "Present.Surface.Diffuse.attenuation.Min", "Present.Surface.Par.Max", "Present.Surface.Par.Mean", "Present.Surface.Salinity.Max", "Present.Surface.Salinity.Mean", "Present.Surface.Salinity.Min", "Present.Surface.Salinity.Range", "Present.Surface.Temperature.Max", "Present.Surface.Temperature.Mean", "Present.Surface.Temperature.Min", "Present.Surface.Temperature.Range") #need to add se for se function

#unlist(strsplit(files,".asc")) #automatic naming wasn't working because extra blank names in file?

# add the environmental data as additional columns on SubsiteData
T2.site.Env <- cbind( T2.site.LL, Environmentals)

# plot a map with any number of sites

#uploading MA maps data
ogrInfo(".", "GISDATA_OUTLINE25K_ARC")
MA.boundary <- readOGR(dsn = ".", layer = "GISDATA_OUTLINE25K_ARC")   #layer of MA State boundary

# define the sites to plotted, and make the points a SpatialPoints object
dplot <- T2.site.Env[,1:2] #for gloucester insert "T2.site.Env$site == "Gloucester"" into x spot
points <- SpatialPoints(coords = dplot, proj4string = CRS("+proj=longlat +datum=WGS84"))
# define the center of the site locations
cent <- apply(dplot,2,mean)

xtralat <- 0.5
xtralon <- 0.5
# define the extent of the plotting area
e2 <- extent( c( cent[1]-xtralon, cent[1]+xtralon, cent[2]-xtralat, cent[2]+xtralat) )
e3 <- extent( c( cent[1]-xtralon/2, cent[1]+xtralon/2, cent[2]-xtralat/2, cent[2]+xtralat/2) )

# stack the data layers
s <- stack(r2)
# redefine the extent of s to match e
se <- crop(s,e2)

extract( se, dplot, buffer=buffer )

# then pick which ones we want to plot
picks <- c("Present.Surface.Temperature.Max")
splot <- subset( se, which(names(se)%in%picks) )

#map("worldHires", "usa", xlim = c(-71.2,-70.45), ylim = c(42.2, 42.65), col = alpha("whitesmoke", 1), fill = FALSE)
plot( splot[[1]],col=viridis(256),
      ylim=e2[3:4]) 
plot(MA.boundary, add = TRUE, xlim = c(-71.2,-70.45), ylim = c(42.2, 42.65), col = "grey80", fill = TRUE)
#map( 'world', add=T, fill=T, col=alpha("whitesmoke",1) )
plot( points, cex=2, add=T, col = "orange" )
plot( points, pch=1, cex=2, add=T, col = "orange" )
```

##Field Mesocosm Synthesis
```{r eval = FALSE, echo = FALSE}
##Leaf loss
m.ll.p <- glm(cbind(lesion.present, lesion.absent) ~ leaf.loss, family = binomial, data = field.site.mean)
Anova(m.ll.p, test = "LR")

m.ll.p <- lm(p.mean ~ leaf.loss, data = field.site.mean)
Anova(m.ll.p)

p <- ggplot(field.site.mean, aes(x = leaf.loss, y = prevalence)) +
  #scale_color_manual(values = c("gray40","gray60", "gray90", "black")) +
  geom_point() +
  geom_smooth(method = lm, se = F, fullrange = F, color = "black") +
  theme_classic()
p

##pathogenicity
m.patho.p <- lm(p.mean ~ alpha, data = field.site.mean)
Anova(m.patho.p)

## transmission
m.t.p <- glm(cbind(lesion.present, lesion.absent) ~ EWDSS, family = binomial, data = field.site.mean)
Anova(m.t.p, test = "LR")

m.t.p <- lm(p.mean ~ beta, data = field.site.mean)
Anova(m.t.p)

p <- ggplot(field.site.mean, aes(x = alpha, y = p.mean)) +
  #scale_color_manual(values = c("gray40","gray60", "gray90", "black")) +
  geom_point() +
  geom_smooth(method = lm, se = F, fullrange = F, color = "black") +
  theme_classic()
p

##shoot density
m.sd.p <- glm(cbind(lesion.present, lesion.absent) ~ shoot.density.mean, family = binomial, data = field.site.mean)
Anova(m.sd.p, test = "LR")

##leaf density
m.ld.p <- glm(cbind(lesion.present, lesion.absent) ~ leaf.density.mean, family = binomial, data = field.site.mean)
Anova(m.ld.p, test = "LR")

m.ld.p <- lm(p.mean ~ leaf.density.mean, data = field.site.mean)
Anova(m.ld.p)

p <- ggplot(field.quad, aes(x = leaf.density, y = prevalence)) +
  #scale_color_manual(values = c("gray40","gray60", "gray90", "black")) +
  geom_point() +
  geom_smooth(method = lm, se = F, fullrange = F, color = "black") +
  theme_classic()
p

##Canopy Height
m.ch.p <- lm(m.ll.p$residuals ~ length.mean, data = field.site.mean)
Anova(m.ch.p)

p <- ggplot(field.site.mean, aes(x = length.mean, y = -m.ll.p$residuals)) +
  #scale_color_manual(values = c("gray40","gray60", "gray90", "black")) +
  geom_point() +
  geom_smooth(method = lm, se = F, fullrange = F, color = "black") +
  theme_classic()
p

m.t.ch <- lm(length.mean ~ leaf.loss, data = field.site.mean)
Anova(m.t.ch)

##multiple regression????
m.multi.p <- glm(cbind(lesion.present, lesion.absent) ~ leaf.loss + transmission + shoot.density.mean, family = binomial, data = field.site.mean)
Anova(m.multi.p, test = "LR")
```


#MODEL
```{r eval = FALSE, echo = FALSE}
#using significant diff means in model

#Function for disease model
solve.Disease.M <- function(t, y, parms) {
  with(c(parms, y), {
     y[y < 0] <- 0

     #Integrate differential equations
     dS <- (A * (S / (S + I)) + Ai * (I / (S + I))) - ((ic * L * D * z) * S * I) - (M * (S / (S + I)))  ###SHOOT DEPENDENT LEAF GROWTH (assuming constant shoot number i.e. no shoot mortality)  * (1-((S+I)/(K*5))) ; 
     #dS <- ((a - m) * S + ai * I) - (ic * ct) * S * I ###LEAF DEPENDENT LEAF GROWTH
     dI <- ((ic * L * D * z) * S * I) - (Mi * (I / (S + I)))
     #dI <- (ic * ct) * S * I - mi * I
     #dS = The number of susceptible leaves
     #dI = The number of infected leaves
     #(1 - (S + I) / cc) carrying capacity equation
     
    return(list(c(dS, dI)))
  })
}

#parameters (DC, LP, NB, WB)
times <- seq(from = 0, to = 1000, len = 1001)
A = c((2.2 / 28) * 461, (2.2 / 28) * 461, ( 2.2/ 28) * 461, (2.2 / 28) * 461) #production of susceptible leaves per 1 m2 quadrat per day from healthy shoots (MESOCOSM & FIELD)
  #DC:1.9, LP:2.09, NB:3.09, WB:1.82 = production of susceptible leaves per healthy shoot (MESOCOSM)
  #461 = Shoots per 1m2 (FIELD)
#a = c(0.53, 0.53, 0.53, 0.71) #production of susceptible leaves per susceptible leaf (MESOCOSM)
          #leaves produced/leaf: healthy DC, NB, LP
            #1.88/3.58 #= 0.53
          #leaves produced/leaf: healthy WB
            #1.88/2.64 #= 0.71
Ai = c((1.18 / 28) * 461, (1.18 / 28) * 461, (1.18 / 28) * 461, (1.18 / 28) * 461) #production of susceptible leaves per 1 m2 quadrat per day from infected shoots (MESOCOSM) DC:1.09, LP:1.27, NB:1.27, WB:1.09
#ai = c(0.34, 0.34, 0.34, 0.46) #production of susceptible leaves per infected leaf (MESOCOSM)
          #leaves produced/leaf: DC, LP, NB, WB
#cc = c(1899, 1710, 1710, 1383) #carrying capacity of leaves (FIELD)
          #WB leaf number 3.0 * 461 shoots = 1383
          #NB + LP leaf number 3.71 * 461 shoots = 1710
          #DC leaf number 4.12 * 461 shoots = 1899
ic = c(1, 1, 1, 1) #wasting disease infections (transission events) per contact between infected and susceptile leaves (MESOCOSM) *0.07?
L = c(78.6, 68.7, 68.7, 104.4) #Leaf length
D = c(461, 461, 461, 461) #Density of shoots (shoots/m2) accounts for differential spacing of leaves
z = c(9*10^-10, 9*10^-10, 9*10^-10, 9*10^-10) #transmission scaling coefficient
#K = c(461*4.14, 461*3.71, 461*3.71, 461*3) #carrying capacity of leaves
#D = c(461, 461, 461, 461) #Shoot density
#ct = c(0.00136751, 0.001231423, 0.001231423, 0.0014433852) #contacts per day between leaves (FIELD, density & length) *divided by 1*10^7 (should I account for density in this metric?? maybe no? ... yes I think I should account for compactness of shoots)
            #DC, LP, NB length
              #(78.61+66.65+70.74)/3 #= 72
              #DC length*leaf.no*density = 72 * 4.12 * 461 = 136751 (site specific leaf.no)
              #LP length*leaf.no*density = 72 * 3.71 * 461 = 123142.3
              #NB length*leaf.no*density = 72 * 3.71 * 461 = 123142.3
            #WB length = 104.39
              #WB length*leaf.no*density = 104.4 * 3 * 461 = 144385.2
M = c((1.3 / 28) * 461, (0.64 / 28) * 461, (0.64 / 28) * 461, (0.73 / 28) * 461) #mortality of leaves per 1 m2 quadrat per day from healthy shoots (MESOCOSM and FIELD)
#m = c(0.36, 0.18, 0.18, 0.28) #mortality rate of susceptible leaves per susceptible leaf (MESOCOSM)
        #DC healthy: 1.3/3.58 = 0.36; NB healthy: 0.64/3.58 = 0.18; LP healthy: 0.64/3.58 = 0.18; WB healthy: 0.73/2.64 = 0.28
Mi = c((2.18 / 28) * 461, (2.64 / 28) * 461, (1.82 / 28) * 461, (1.18 / 28) * 461) #mortality of leaves per 1 m2 quadrat per day from diseased shoots (MESOCOSM AND FIELD)
#mi = c(0.56, 0.75, 0.51, 0.46)  #mortality rate of infected leaves per infected leaf (MESOCOSM)
        #DC infected: 2/3.58 = 0.56; NB infected: 1.82/3.58 = 0.51; LP infected: 2.7/3.58 = 0.75; WB infected: 1.22/2.64 = 0.46

r.T1 <- matrix(nrow = 1001, ncol = 9, 0)

#simulation (can adjust parameters for each site see oyster modeling project)
for (n in 1:4) {
  r.T1[,1] <- ode(time = times, parms = list(A = A[1], Ai = Ai[1], ic = ic[1], L = L[1], D = D[1], z = z[1], K = K[1], M = M[1], Mi = Mi[1]), y = c(S = 750, I = 750),  func = solve.Disease.M, method = "ode45")[,1]
  
  r.T1[,n+1] <- ode(time = times, parms = list(A = A[n], Ai = Ai[n], ic = ic[n], L = L[n], D = D[n], z = z[n], K = K[n], M = M[n], Mi = Mi[n]), y = c(S = 750, I = 750),  func = solve.Disease.M, method = "ode45")[,2]
  
  r.T1[,n+5] <- ode(time = times, parms = list(A = A[n], Ai = Ai[n], ic = ic[n], L = L[n], D = D[n], z = z[n], K = K[n], M = M[n], Mi = Mi[n]), y = c(S = 750, I = 750),  func = solve.Disease.M, method = "ode45")[,3]
  }

r.T1 <- data.frame(r.T1)

prevalence <-c(r.T1[1001,6]/(r.T1[1001,2] + r.T1[1001,6]), r.T1[1001,7]/(r.T1[1001,3] + r.T1[1001,7]), r.T1[1001,8]/(r.T1[1001,4] + r.T1[1001,8]), r.T1[1001,9]/(r.T1[1001,5] + r.T1[1001,9]))
prevalence

#parameters (DC, LP, NB, WB)

plot(r.T1[,6]/(r.T1[,2] + r.T1[,6]) ~ r.T1[,1], t = "l", ylim = c(0,1), ylab = "Prevalence", xlab = "time", col = "purple", main = "")
lines(r.T1[,1], r.T1[,7]/(r.T1[,3] + r.T1[,7]), t = "l", col = "darkgreen")
lines(r.T1[,1], r.T1[,8]/(r.T1[,4] + r.T1[,8]), t = "l", col = "orange")
lines(r.T1[,1], r.T1[,9]/(r.T1[,5] + r.T1[,9]), t = "l", col = "blue")

plot((r.T1[,2] + r.T1[,6])/461 ~ r.T1[,1], t = "l", ylim = c(0,10), ylab = "leaf number/shoot", xlab = "time", col = "purple", main = "")
lines(r.T1[,1], (r.T1[,3] + r.T1[,7])/461, t = "l", col = "darkgreen")
lines(r.T1[,1], (r.T1[,4] + r.T1[,8])/461, t = "l", col = "orange")
lines(r.T1[,1], (r.T1[,5] + r.T1[,9])/461, t = "l", col = "blue")

#plot(r.T1[,2]+r.T1[,3] ~ r.T1[,1], t = "l", ylim = c(0,3000), ylab = "number of leaves", xlab = "time")
```

##(I)Simulated Annealing
```{r eval = FALSE}
#Simulated Annealing
##Function for SA disease model

solve.Disease.SA <- function(t, y, parms) {
  y[y < 0] <- 0
  with(c(parms, y), {
     y[y < 0] <- 0
     dS <- ai - b * S * I # as * S + ai * I (remove per leaf)
     dI <- b * S * I - mi # * I remove per leaf
     dD <- mi
     return(list(c(dS, dI, dD)))
  })
}

#as = healthy plant leaf production rate (currently ommited because no healthy plants)
#ai =diseased plant leaf production rate
#b = transmission rate
#ms = healthy leaf mortality rate (from healthy SA model, no healthy leaf mortality
#in disease treatment)
#mi = infected leaf mortality rate

##Uploading data
mesocosm.transmission <- read.csv("transmission.SimA.model.csv")
mesocosm.transmission.CB <- mesocosm.transmission[c(1:11), c(2:35)]
mesocosm.transmission.LP <- mesocosm.transmission[c(12:22), c(2:35)]
mesocosm.transmission.NB <- mesocosm.transmission[c(23:33), c(2:35)]
mesocosm.transmission.WB <- mesocosm.transmission[c(34:44), c(2:35)]

##Cost function
cost_function <- function(x, times, N0, data) {
  ai <- x[1] #ai <- x[4]
  b <- x[2]
  mi <- x[3]
  if (ai > 0 & b > 0 & mi > 0) {  # & ai > 0
    sim <-ode(y = N0, t = times, func = solve.Disease.SA,
              parms = list(ai = x[1], b = x[2], mi = x[3]), #, ai = x[4]
              method = "ode45")[c(1,2,3,4,5,6,8,11,15,22,29),]
    if (NROW(sim) == NROW(data)) {
      rmse <- sqrt(mean((as.numeric(data[,2] - (sim[,2])))^2)) +
        sqrt(mean((as.numeric(data[,3] - (sim[,3])))^2)) +
        sqrt(mean((as.numeric(data[,4] - (sim[,4])))^2))
    } else {
      rmse <- Inf
    }
  } else {
    rmse <- Inf
  }
}

##Acceptance function
acceptance <- function(cost_curr, cost_prop, temp) {
  if (cost_prop < cost_curr) {
    prob_accept <- 1
  } else {
    prob_accept <- exp(-(cost_prop - cost_curr)/temp)
  }
  return(prob_accept)
}

##simulated annealing (main simulation function)
sim_annealing <- function(I, tc, tr, data, times, N0) {
  rmse <- numeric(length = I); pars <- matrix(nrow = I, ncol = 3) #4
  colnames(pars) <- c("ai", "b", "mi") #, "as"
  x_curr <- c(runif(1, min = 0, max = 1), runif(1, min = 0, max = 1),
              runif(1, min = 0, max = 1)) #, runif(1, min = 0, max = 0.1) Change bounds
  rmse_curr <- cost_function(x_curr, times, N0, data)
  
  for (i in 1:I) {
    temp <- tc * exp(- tr * i / I)
    x_prop <- c(runif(1, min = 0, max = 1), runif(1, min = 0, max = 1),
                runif(1, min = 0, max = 1)) #, runif(1, min = 0, max = 0.1) Change bounds
    rmse_prop <- cost_function(x_prop, times, N0, data)
    
    if (acceptance(rmse_curr, rmse_prop, temp) >= runif(1)) {
      x_curr <- x_prop
      rmse_curr <- rmse_prop
    }
    pars[i, ] <- x_curr
    rmse[i] <- rmse_curr
  }
  return(list(x = x_curr, pars = pars, rmse = rmse))
}


##Trace plot
trace_plot <- function(x, burnin = 0) {
  names <- colnames(x)
  n <- ncol(x)
  par(mfrow = c(n, 2))
  for (i in 1:n) {
    plot(x[, i], type = "l", xlab = "Iterations", ylab = names[i],
         ylim = range(x[, i]), main = paste0("Trace of ", names[i]))
    d <- density(x[, i])
    plot(d$y, d$x, xlab = "Density", ylab = names[i], type = "l", ylim = range(x[, i]),
         main = paste0("Density of ", names[i]))
    abline(h = x[nrow(x), i], col = "red")
  }
}

##Running Simulations
###single data set
data <- mesocosm.transmission.CB[, c(1, 2, 13, 24)]
times <- 0:28
N0 <- c(S = mesocosm.transmission.CB[1, 2], I = 1, D = 0)
sims <- sim_annealing(I = 10^4, tc = 10^8, tr = 20, data, times, N0) #If you get this error message: #Error in if (cost_prop < cost_curr) { : missing value where TRUE/FALSE needed In addition: Warning messages: 1: In rk(y, times, func, parms, method = "ode45", ...) :Number of time steps 110814 exceeded maxsteps at t = 3.067472: In rk(y, times, func, parms, method = "ode45", ...) : Number of time steps 110804 exceeded maxsteps at t = 2.31483
#REDUCE THE RANGE OF PARAMETER!!!! UGH

trace_plot(sims$pars)

sims$pars[100,]
sims$x

str(sims)

sim.final <-ode(y = N0, t = times, func = solve.Disease.SA,
                parms = list(as = 0.067, b = 0.245, mi = 0.062),
                method = "ode45")[c(1,2,3,4,5,6,8,11,15,22,29),]

## Plotting data
par(mfrow = c(1,1))
plot(s.M1 ~ Day, data = data, col = "green", ylim = c(0,5)) #Experiment susceptible
points(i.M1 ~ Day, data = data, col = "red") #Experiment infected
points(d.M1 ~ Day, data = data) #Experiment dead
points(S ~ time, data = sim.final, t = "l", col = "green") #simulated susceptible
points(I ~ time, data = sim.final, t = "l", col = "red") #simulated infected
points(D ~ time, data = sim.final, t = "l") #simulated dead

###multiple data sets
set.seed(1)
pars.sim <- matrix(NA, nrow = 11, ncol = 3) #
data.temp <- matrix(NA, nrow = 11, ncol = 34)
pars.sim.master <- array(NA, c(11,3,4))
for(j in 0:3) {
  data.temp <- mesocosm.transmission[c((1+11*j):(11+11*j)), c(2:35)]
  for (i in 1:11) {
    data <- data.temp[, c(1,i + 1, i + 12, i + 23)]
    times <- 0:28
    N0 <- c(S = data.temp[1, i + 1], I = 1, D = 0)
    sims <- sim_annealing(I = 10^4, tc = 10^8, tr = 20, data, times, N0)
    pars.sim[i,] <- sims$x
  }
  pars.sim.master[ , , j+1] <- pars.sim
}

pars.sim.master

##CB
#pars.sim.CB <- matrix(NA, nrow = 11, ncol = 4)
#for (i in 1:11) {
#  data <- mesocosm.transmission.CB[, c(1,i + 1, i + 12, i + 23)]
#  times <- 0:28
#  N0 <- c(S = mesocosm.transmission.CB[1, i + 1], I = 1, D = 0)
#  sims <- sim_annealing(I = 10^4, tc = 10^8, tr = 20, data, times, N0)
#  pars.sim.CB[i,] <- sims$x
#}
#pars.sim.CB

## running model with parameters from sim
sim.final <- array(NA, c(11,4,44), )
for (j in 0:3) {
  data.temp.sim <- mesocosm.transmission[c((1+11*j):(11+11*j)), c(2:35)]
  for (i in 1:11) {
    N0 <- c(S = data.temp.sim[1, i + 1], I = 1, D = 0)
      sim.final[, , (i+(j*11))] <-ode(y = N0, t = times, func = solve.Disease.SA,
                             parms = list(ai = pars.sim.master[i, 1, (j+1)],
                                        b = pars.sim.master[i, 2, (j+1)],
                                        mi = pars.sim.master[i, 3, (j+1)]),
                           method = "ode45")[c(1,2,3,4,5,6,8,11,15,22,29),] #, ai = pars.sim.master[i, 4, (j+1)]
      }
  }

sim.final

##PLOTTING MODEL
par(mfrow = c(2,2))
for (i in 0:3) {
  data.temp.sim <- mesocosm.transmission[c((1+11*i):(11+11*i)), c(2:35)]
  plot(data.temp.sim[,2] ~ data.temp.sim[, 1], data = data.temp.sim, col = "green", ylim = c(0,6))
  for (j in 2:11) {
     points(data.temp.sim[, 1 + j] ~ data.temp.sim[, 1], data = data.temp.sim, col = "green")
  }
  for (n in 1:11) {
  points(data.temp.sim[, n + 12] ~ data.temp.sim[, 1], data = data.temp.sim, col = "red") #Experiment infected
    points(data.temp.sim[, n + 23] ~ data.temp.sim[, 1], data = data.temp.sim) #Experiment dead
    points(sim.final[, 2, (n + i * 11)] ~ sim.final[, 1, (n + i * 11)], data = sim.final[ , , (n + i * 11)], t = "l", col = "green") #simulated susceptible
    points(sim.final[, 3, (n + i * 11)] ~ sim.final[, 1, (n + i * 11)], data = sim.final[, , (n + i * 11)], t = "l", col = "red") #simulated infected
    points(sim.final[, 4, (n + i * 11)] ~ sim.final[, 1, (n + i * 11)], data = sim.final[, , (n + i * 11)], t = "l") #simulated dead
  }
}

##MEANS, SE, and SD

means.cb <- cbind(mean(pars.sim.master[, 1, 1]), mean(pars.sim.master[, 2, 1]), mean(pars.sim.master[, 3, 1]))
means.lp <- cbind(mean(pars.sim.master[, 1, 2]), mean(pars.sim.master[, 2, 2]), mean(pars.sim.master[, 3, 2]))
means.nb <- cbind(mean(pars.sim.master[, 1, 3]), mean(pars.sim.master[, 2, 3]), mean(pars.sim.master[, 3, 3]))
means.wb <- cbind(mean(pars.sim.master[, 1, 4]), mean(pars.sim.master[, 2, 4]), mean(pars.sim.master[, 3, 4]))
clabs <- c("ai", "b", "mi")

rbind(clabs, means.cb, means.lp, means.nb, means.wb)

se.cb <- cbind(se(pars.sim.master[, 1, 1]), se(pars.sim.master[, 2, 1]), se(pars.sim.master[, 3, 1]))
se.lp <- cbind(se(pars.sim.master[, 1, 2]), se(pars.sim.master[, 2, 2]), se(pars.sim.master[, 3, 2]))
se.nb <- cbind(se(pars.sim.master[, 1, 3]), se(pars.sim.master[, 2, 3]), se(pars.sim.master[, 3, 3]))
se.wb <- cbind(se(pars.sim.master[, 1, 4]), se(pars.sim.master[, 2, 4]), se(pars.sim.master[, 3, 4]))

rbind(se.cb, se.lp, se.nb, se.wb)

```

##(S)Simulated Annealing
```{r eval = FALSE}
##Function for SA healthy model
solve.Healthy.SA <- function(t, y, parms) {
  with(c(parms, y), {
    y[y < 0] <- 0
    dS <- as - ms
    dD <- ms
    return(list(c(dS, dD)))
  })
}

##Uploading data
mesocosm.transmission.S <- read.csv("transmission.SimA.model.S.csv")
mesocosm.transmission.CB.S <- mesocosm.transmission.S[c(1:11), c(2:10, 14:21)]
mesocosm.transmission.LP.S <- mesocosm.transmission.S[c(12:22), c(2:24)]
mesocosm.transmission.NB.S <- mesocosm.transmission.S[c(23:33), c(2:24)]
mesocosm.transmission.WB.S <- mesocosm.transmission.S[c(34:44), c(2:8, 14:19)]

##Cost function
cost_function.S <- function(x, times, N0, data) {
  as <- x[1]
  ms <- x[2]
  if (as >= 0 & ms >= 0) {
    sim <-ode(y = N0, t = times, func = solve.Healthy.SA,
              parms = list(as = x[1], ms = x[2]),
              method = "ode45")[c(1,2,3,4,5,6,8,11,15,22,29),]
    if (NROW(sim) == NROW(data)) {
      rmse <- sqrt(mean((as.numeric(data[,2] - (sim[,2])))^2)) +
        sqrt(mean((as.numeric(data[,3] - (sim[,3])))^2))
    } else {
      rmse <- Inf
    }
  } else {
    rmse <- Inf
  }
}

##Acceptance function
acceptance.S <- function(cost_curr, cost_prop, temp) {
  if (cost_prop < cost_curr) {
    prob_accept <- 1
  } else {
    prob_accept <- exp(-(cost_prop - cost_curr)/temp)
  }
  return(prob_accept)
}

##simulated annealing (main simulation function)
sim_annealing.S <- function(I, tc, tr, data, times, N0) {
  rmse <- numeric(length = I); pars <- matrix(nrow = I, ncol = 2) #4
  colnames(pars) <- c("as", "ms")
  x_curr <- c(runif(1, min = 0, max = 1), runif(1, min = 0, max = 1)) #Change bounds if error
  rmse_curr <- cost_function.S(x_curr, times, N0, data)
  
  for (i in 1:I) {
    temp <- tc * exp(- tr * i / I)
    x_prop <- c(runif(1, min = 0, max = 1), runif(1, min = 0, max = 1)) #Change bounds if error
    rmse_prop <- cost_function.S(x_prop, times, N0, data)
    
    if (acceptance.S(rmse_curr, rmse_prop, temp) >= runif(1)) {
      x_curr <- x_prop
      rmse_curr <- rmse_prop
    }
    pars[i, ] <- x_curr
    rmse[i] <- rmse_curr
  }
  return(list(x = x_curr, pars = pars, rmse = rmse))
}


##CB
pars.sim.CB <- matrix(NA, nrow = 8, ncol = 2)
for (i in 1:8) {
  data <- mesocosm.transmission.CB.S[, c(1,i + 1, i + 9)]
  times <- 0:28
  N0 <- c(S = mesocosm.transmission.CB.S[1, i + 1], D = 0)
  sims <- sim_annealing.S(I = 10^4, tc = 10^8, tr = 20, data, times, N0)
  pars.sim.CB[i,] <- sims$x
}
pars.sim.CB

#Simulating data based on parms for Sim.Annealing
sim.final <- array(NA, c(11,3,8), )
for (i in 1:8) {
  N0 <- c(S = mesocosm.transmission.CB.S[1, i + 1], D = 0)
  sim.final[, , i] <-ode(y = N0, t = times, func = solve.Healthy.SA,
                parms = list(as = pars.sim.CB[i,1], ms = pars.sim.CB[i,2]),
                method = "ode45")[c(1,2,3,4,5,6,8,11,15,22,29),]
}

sim.final

## Plotting CB data
par(mfrow = c(1,1))
  plot(mesocosm.transmission.CB.S[,2] ~ Day, data = mesocosm.transmission.CB.S, col = "green", ylim = c(0,9))
for (i in 1:8) {
  points(mesocosm.transmission.CB.S[,i+1] ~ Day, data = mesocosm.transmission.CB.S, col = "green") #Experiment susceptible
  points(mesocosm.transmission.CB.S[,i+9] ~ Day, data = mesocosm.transmission.CB.S) #Experiment dead
  points(sim.final[,2,i] ~ sim.final[,1,i], data = sim.final[,,i], t = "l", col = "green") #simulated susceptible
  points(sim.final[,3,i] ~ sim.final[,1,i], data = sim.final[,,i], t = "l") #simulated dead
}

##LP
pars.sim.LP <- matrix(NA, nrow = 11, ncol = 2)
for (i in 1:11) {
  data <- mesocosm.transmission.LP.S[, c(1,i + 1, i + 12)]
  times <- 0:28
  N0 <- c(S = mesocosm.transmission.LP.S[1, i + 1], D = 0)
  sims <- sim_annealing.S(I = 10^4, tc = 10^8, tr = 20, data, times, N0)
  pars.sim.LP[i,] <- sims$x
}
pars.sim.LP

#Simulating data based on parms for Sim.Annealing
sim.final <- array(NA, c(11,3,11), )
for (i in 1:11) {
  N0 <- c(S = mesocosm.transmission.LP.S[1, i + 1], D = 0)
  sim.final[, , i] <-ode(y = N0, t = times, func = solve.Healthy.SA,
                parms = list(as = pars.sim.LP[i,1], ms = pars.sim.LP[i,2]),
                method = "ode45")[c(1,2,3,4,5,6,8,11,15,22,29),]
}

sim.final

## Plotting LP data
par(mfrow = c(1,1))
  plot(mesocosm.transmission.LP.S[,2] ~ Day, data = mesocosm.transmission.LP.S, col = "green", ylim = c(0,9))
for (i in 1:11) {
  points(mesocosm.transmission.LP.S[,i+1] ~ Day, data = mesocosm.transmission.LP.S, col = "green") #Experiment susceptible
  points(mesocosm.transmission.LP.S[,i+9] ~ Day, data = mesocosm.transmission.LP.S) #Experiment dead
  points(sim.final[,2,i] ~ sim.final[,1,i], data = sim.final[,,i], t = "l", col = "green") #simulated susceptible
  points(sim.final[,3,i] ~ sim.final[,1,i], data = sim.final[,,i], t = "l") #simulated dead
}

##NB
pars.sim.NB <- matrix(NA, nrow = 11, ncol = 2)
for (i in 1:11) {
  data <- mesocosm.transmission.NB.S[, c(1,i + 1, i + 12)]
  times <- 0:28
  N0 <- c(S = mesocosm.transmission.NB.S[1, i + 1], D = 0)
  sims <- sim_annealing.S(I = 10^4, tc = 10^8, tr = 20, data, times, N0)
  pars.sim.NB[i,] <- sims$x
}
pars.sim.NB

#Simulating data based on parms for Sim.Annealing
sim.final <- array(NA, c(11,3,11), )
for (i in 1:11) {
  N0 <- c(S = mesocosm.transmission.NB.S[1, i + 1], D = 0)
  sim.final[, , i] <-ode(y = N0, t = times, func = solve.Healthy.SA,
                parms = list(as = pars.sim.NB[i,1], ms = pars.sim.NB[i,2]),
                method = "ode45")[c(1,2,3,4,5,6,8,11,15,22,29),]
}

sim.final

## Plotting NB data
par(mfrow = c(1,1))
  plot(mesocosm.transmission.NB.S[,2] ~ Day, data = mesocosm.transmission.NB.S, col = "green", ylim = c(0,9))
for (i in 1:11) {
  points(mesocosm.transmission.NB.S[,i+1] ~ Day, data = mesocosm.transmission.NB.S, col = "green") #Experiment susceptible
  points(mesocosm.transmission.NB.S[,i+9] ~ Day, data = mesocosm.transmission.NB.S) #Experiment dead
  points(sim.final[,2,i] ~ sim.final[,1,i], data = sim.final[,,i], t = "l", col = "green") #simulated susceptible
  points(sim.final[,3,i] ~ sim.final[,1,i], data = sim.final[,,i], t = "l") #simulated dead
}
  
##WB
pars.sim.WB <- matrix(NA, nrow = 6, ncol = 2)
for (i in 1:6) {
  data <- mesocosm.transmission.WB.S[, c(1,i + 1, i + 7)]
  times <- 0:28
  N0 <- c(S = mesocosm.transmission.WB.S[1, i + 1], D = 0)
  sims <- sim_annealing.S(I = 10^4, tc = 10^8, tr = 20, data, times, N0)
  pars.sim.WB[i,] <- sims$x
}
pars.sim.WB

mean(pars.sim.WB[,1])

#Simulating data based on parms for Sim.Annealing
sim.final <- array(NA, c(11,3,6), )
for (i in 1:6) {
  N0 <- c(S = mesocosm.transmission.WB.S[1, i + 1], D = 0)
  sim.final[, , i] <-ode(y = N0, t = times, func = solve.Healthy.SA,
                parms = list(as = pars.sim.WB[i,1], ms = pars.sim.WB[i,2]),
                method = "ode45")[c(1,2,3,4,5,6,8,11,15,22,29),]
}

sim.final

## Plotting WB data
par(mfrow = c(1,1))
  plot(mesocosm.transmission.WB.S[,2] ~ Day, data = mesocosm.transmission.WB.S, col = "green", ylim = c(0,9))
for (i in 1:6) {
  points(mesocosm.transmission.WB.S[,i+1] ~ Day, data = mesocosm.transmission.WB.S, col = "green") #Experiment susceptible
  points(mesocosm.transmission.WB.S[,i+7] ~ Day, data = mesocosm.transmission.WB.S) #Experiment dead
  points(sim.final[,2,i] ~ sim.final[,1,i], data = sim.final[,,i], t = "l", col = "green") #simulated susceptible
  points(sim.final[,3,i] ~ sim.final[,1,i], data = sim.final[,,i], t = "l") #simulated dead
}

 ##Mean parameters by site 
mean.as <-c(mean(pars.sim.CB[,1]), mean(pars.sim.LP[,1]), mean(pars.sim.NB[,1]), mean(pars.sim.WB[,1]))
mean.as
mean.ms <-c(mean(pars.sim.CB[,2]), mean(pars.sim.LP[,2]), mean(pars.sim.NB[,2]), mean(pars.sim.WB[,2]))
mean.ms

#calcualating virulence (disease induced mortality rate = mi-ms)
pathogenicity.est <- rbind(c("CB", "LP", "NB", "WB"), c(0.098-0.041, 0.108-0.029, 0.089-0.019, 0.0603-0.0602))
pathogenicity.est


```

##Sim.An.Stats
```{r eval = FALSE}

##Manipulating data:

site.vector <- c("cb", "cb", "cb", "cb", "cb", "cb", "cb", "cb", "cb", "cb", "cb", "lp", "lp", "lp", "lp", "lp", "lp", "lp", "lp", "lp", "lp", "lp", "nb", "nb", "nb", "nb", "nb", "nb", "nb", "nb", "nb", "nb", "nb", "wb", "wb", "wb", "wb", "wb", "wb", "wb", "wb", "wb", "wb", "wb")
SA.data.master <- matrix(site.vector, nrow = 44, ncol = 1)
SA.data.master <- as.data.frame(SA.data.master)
SA.data.master$ai <- matrix(rbind(pars.sim.master[, , 1], pars.sim.master[, , 2], pars.sim.master[, , 3], pars.sim.master[, , 4]), nrow = 44, ncol = 3)[,1]
SA.data.master$beta <- matrix(rbind(pars.sim.master[, , 1], pars.sim.master[, , 2], pars.sim.master[, , 3], pars.sim.master[, , 4]), nrow = 44, ncol = 3)[,2]
SA.data.master$mi <- matrix(rbind(pars.sim.master[, , 1], pars.sim.master[, , 2], pars.sim.master[, , 3], pars.sim.master[, , 4]), nrow = 44, ncol = 3)[,3]
colnames(SA.data.master) <- c("site", "ai", "beta", "mi")

SA.data.master$as <-c(pars.sim.CB[,1], NA, NA, NA, pars.sim.LP[,1], pars.sim.NB[,1], pars.sim.WB[,1], NA, NA, NA, NA, NA)
SA.data.master$ms <- c(pars.sim.CB[,2], NA, NA, NA, pars.sim.LP[,2], pars.sim.NB[,2], pars.sim.WB[,2], NA, NA, NA, NA, NA)
SA.data.master$patho <- SA.data.master$mi - SA.data.master$ms

str(SA.data.master)

##Healthy leaf production analyses (as)
SA.as.model <- aov(as ~ site, data = SA.data.master)
Anova(SA.as.model) ##No significant differences

##Healthy leaf loss analyses (ms)
SA.ms.model <-aov(ms ~ site, data = SA.data.master)
Anova(SA.ms.model) #significant effect of site

posthoc.SA.ms.model <- TukeyHSD(SA.ms.model)
multcompLetters(posthoc.SA.ms.model$`site`[,"p adj"]) #nb = least, lp&cb = intermediate, wb = most

##Infected leaf production analyses (ai)
SA.ai.model <- aov(ai ~ site, data = SA.data.master)
Anova(SA.ai.model) #No significant differences

#Infected leaf loss analyses (mi)
SA.mi.model <- aov(mi ~ site, data = SA.data.master)
Anova(SA.mi.model) #No significant differences

#Transmission analyses (beta)
SA.beta.model <- aov(beta ~ site, data = SA.data.master)
Anova(SA.beta.model) #Marginal difference
  #CB (0.29), WB (0.54), LP (0.34) and NB (0.43)

#Pathogenicity analyses (patho) ##ANCOVA
SA.patho.model <- aov(patho ~ site, data = SA.data.master)
Anova(SA.patho.model) #significant differences

posthoc.SA.patho.model <- TukeyHSD(SA.patho.model)
multcompLetters(posthoc.SA.patho.model$`site`[,"p adj"]) #wb = least, nb&cb = intermediate, lp = most

SA.data.master.patho <- SA.data.master %>%
  group_by(site) %>%
  summarize(patho.mean = mean(patho, na.rm = T), patho.se = se(patho, na.rm = T), patho.sd = sd(patho, na.rm = T))

```

##FIELD MODEL
```{r eval = FALSE, echo = FALSE}
# dS/dt = as * (S / (S + I)) * ((S + I) / LEAVES/PLANT) +
        # ai * (I / (S + I)) * ((S + I) / LEAVES/PLANT) - B * S * I -
        # ms * (S / (S + I)) * ((S + I) / LEAVES/PLANT)
# dI/dt = B * S * I - mi * (I / (S + I)) * ((S + I) / LEAVES/PLANT)
# dD/dt = ms * (S / (S + I)) * ((S + I) / LEAVES/PLANT) +
        # mi * (I / (S + I)) * ((S + I) / LEAVES/PLANT)


##Function for field model
solve.field <- function(t, y, parms) {
  with(c(parms, y), {
    y[y < 0] <- 0
    dS <- as * (S / (S + I)) * ((S + I) / lpp) + ai * (I / (S + I)) * ((S + I) / lpp) - beta * S * I - ms * (S / (S + I)) * ((S + I) / lpp)
    dI <- beta * S * I - (ms + alpha) * (I / (S + I)) * ((S + I) / lpp)
    #dD <- ms * (S / (S + I)) * ((S + I) / lpp) + (ms + alpha) * (I / (S + I)) * ((S + I) / lpp)
    return(list(c(dS, dI))) #dD
  })
}

#parameters (DC, LP, NB, WB)
as <- c(0.069, 0.076, 0.112, 0.090)
ai <- c(0.066, 0.081, 0.076, 0.052)
lpp <- c(4.143, 3.723, 3.698, 3.000)
beta <- c(0.295*0.001, 0.341*0.001, 0.434*0.001, 0.547*0.001)      #beta <- c(0.295, 0.341, 0.434, 0.547) --> Ran test to check changing order of magnitude of transmission rates does not affect interpretation = OK :) !!
ms <- c(0.042, 0.029, 0.019, 0.060)
alpha <- c(0.057, 0.079, 0.070, 0.0001)

#CB
alpha.mod <- seq(from = 0.5, to = 3, len = 251)  #alpha.mod <- seq(from = 0.5, to = 3, len = 6)

  #empty matrix
field.sim.CB <- matrix(nrow = 251, ncol = 4, 0)    #field.sim.CB.test <- matrix(nrow = 6, ncol = 4, 0)

  #time steps
times <- seq(from = 0, to = 10000, len = 10001)

  #simulation
for (i in 1:251) {
  field.sim.CB[i, 1] <- alpha[1] * alpha.mod[i]
  field.sim.CB[i, 2:4] <- ode(time = times, parms = list(as = as[1], ai = ai[1], lpp = lpp[1], beta = beta[1], ms = ms[1], alpha = field.sim.CB[i, 1]), y = c(S = 50, I = 1),  func = solve.field, method = "ode45")[10001,]
}

  #Post sim H* and y* calcs
field.sim.CB <- as.data.frame(field.sim.CB)    #field.sim.CB.test <- as.data.frame(field.sim.CB.test)
colnames(field.sim.CB)[1:4] <- c("alpha", "time.step", "S", "I") #colnames(field.sim.CB.test)[1:4] <- c("alpha", "time.step", "S", "I")
field.sim.CB$H <- field.sim.CB$S + field.sim.CB$I   #field.sim.CB.test$H <- field.sim.CB.test$S + field.sim.CB.test$I
field.sim.CB$y <- field.sim.CB$I / (field.sim.CB$S + field.sim.CB$I)  #field.sim.CB.test$y <- field.sim.CB.test$I / (field.sim.CB.test$S + field.sim.CB.test$I)
field.sim.CB$alpha.mod <- alpha.mod    #field.sim.CB.test$alpha.mod <- alpha.mod


  #plots
par(mfrow = c(1,2))
plot(H ~ alpha, data = field.sim.CB, ylim = c(0,500), xlim = c(0,0.2), ylab = "H*", t = "l")
points(H[51] ~ alpha[51], data = field.sim.CB, pch = 1, col = "red") #measured alpha
points(H[23] ~ alpha[23], data = field.sim.CB, pch = 0, col = "green") #field y* alpha
points(H[67] ~ alpha[67], data = field.sim.CB, pch = 8, col = "orange") #min H* alpha
arrows(0.057+0.019, 147.27, 0.057-0.019, 147.27, length = 0.05, angle = 90, code = 3, col = "red")
plot(y ~ alpha, data = field.sim.CB, ylim = c(0,1), xlim = c(0,0.2), ylab = "y*", t = "l")
points(y[51] ~ alpha[51], data = field.sim.CB, pch = 1, col = "red")
points(y[23] ~ alpha[23], data = field.sim.CB, pch = 0, col = "green")
points(y[67] ~ alpha[67], data = field.sim.CB, pch = 8, col = "orange")
arrows(0.057+0.019, 0.45, 0.057-0.019, 0.45, length = 0.05, angle = 90, code = 3, col = "red")


#LP
alpha.mod <- seq(from = 0.7, to = 2.7, len = 201)

  #empty matrix
field.sim.LP <- matrix(nrow = 201, ncol = 4, 0)

  #time steps
times <- seq(from = 0, to = 10000, len = 10001)

  #simulation
for (i in 1:201) {
  field.sim.LP[i, 1] <- alpha[2] * alpha.mod[i]
  field.sim.LP[i, 2:4] <- ode(time = times, parms = list(as = as[2], ai = ai[2], lpp = lpp[2], beta = beta[2], ms = ms[2], alpha = field.sim.LP[i, 1]), y = c(S = 50, I = 1),  func = solve.field, method = "ode45")[10001,]
}

  #Post sim H* and y* calcs
field.sim.LP <- as.data.frame(field.sim.LP)
colnames(field.sim.LP)[1:4] <- c("alpha", "time.step", "S", "I")
field.sim.LP$H <- field.sim.LP$S + field.sim.LP$I
field.sim.LP$y <- field.sim.LP$I / (field.sim.LP$S + field.sim.LP$I)
field.sim.LP$alpha.mod <- alpha.mod


  #plots
par(mfrow = c(1,2))
plot(H ~ alpha, data = field.sim.LP, ylim = c(0,1200), xlim = c(0,0.25), ylab = "H*", t = "l")
points(H[31] ~ alpha[31], data = field.sim.LP, pch = 1, col = "red") #measured alpha
points(H[142] ~ alpha[142], data = field.sim.LP, pch = 0, col = "green") #field y* alpha
points(H[75] ~ alpha[75], data = field.sim.LP, pch = 8, col = "orange") #min H* alpha
arrows(0.079+0.016, 233.16, 0.079-0.016, 233.16, length = 0.05, angle = 90, code = 3, col = "red")
plot(y ~ alpha, data = field.sim.LP, ylim = c(0,1), xlim = c(0,0.25), ylab = "y*", t = "l")
points(y[31] ~ alpha[31], data = field.sim.LP, pch = 1, col = "red")
points(y[142] ~ alpha[142], data = field.sim.LP, pch = 0, col = "green")
points(y[75] ~ alpha[75], data = field.sim.LP, pch = 8, col = "orange")
arrows(0.079+0.016, 0.635, 0.079-0.016, 0.635, length = 0.05, angle = 90, code = 3, col = "red")

#NB
alpha.mod <- seq(from = 0.9, to = 3, len = 211)

  #empty matrix
field.sim.NB <- matrix(nrow = 211, ncol = 4, 0)

  #time steps
times <- seq(from = 0, to = 10000, len = 10001)

  #simulation
for (i in 1:211) {
  field.sim.NB[i, 1] <- alpha[3] * alpha.mod[i]
  field.sim.NB[i, 2:4] <- ode(time = times, parms = list(as = as[3], ai = ai[3], lpp = lpp[3], beta = beta[3], ms = ms[3], alpha = field.sim.NB[i, 1]), y = c(S = 50, I = 1),  func = solve.field, method = "ode45")[10001,]
}

  #Post sim H* and y* calcs
field.sim.NB <- as.data.frame(field.sim.NB)
colnames(field.sim.NB)[1:4] <- c("alpha", "time.step", "S", "I")
field.sim.NB$H <- field.sim.NB$S + field.sim.NB$I
field.sim.NB$y <- field.sim.NB$I / (field.sim.NB$S + field.sim.NB$I)
field.sim.NB$alpha.mod <- alpha.mod


  #plots
par(mfrow = c(1,2))
plot(H ~ alpha, data = field.sim.NB, ylim = c(0,1000), xlim = c(0,0.25), ylab = "H*", t = "l")
points(H[11] ~ alpha[11], data = field.sim.NB, pch = 1, col = "red") #measured alpha
points(H[142] ~ alpha[142], data = field.sim.NB, pch = 0, col = "green") #field y* alpha
points(H[113] ~ alpha[113], data = field.sim.NB, pch = 8, col = "orange") #min H* alpha
arrows(0.070+0.015, 452.16, 0.070-0.015, 452.16, length = 0.05, angle = 90, code = 3, col = "red")
plot(y ~ alpha, data = field.sim.NB, ylim = c(0,1), xlim = c(0,0.25), ylab = "y*", t = "l")
points(y[11] ~ alpha[11], data = field.sim.NB, pch = 1, col = "red")
points(y[142] ~ alpha[142], data = field.sim.NB, pch = 0, col = "green")
points(y[113] ~ alpha[113], data = field.sim.NB, pch = 8, col = "orange")
arrows(0.070+0.015, 0.877, 0.070-0.015, 0.877, length = 0.05, angle = 90, code = 3, col = "red")

#WB
alpha.mod <- c(0,1, seq(from = 5, to = 1000, len = 200))

  #empty matrix
field.sim.WB <- matrix(nrow = 202, ncol = 4, 0)

  #time steps
times <- seq(from = 0, to = 10000, len = 10001)

  #simulation
for (i in 1:202) {
  field.sim.WB[i, 1] <- alpha[4] * alpha.mod[i]
  field.sim.WB[i, 2:4] <- ode(time = times, parms = list(as = as[4], ai = ai[4], lpp = lpp[4], beta = beta[4], ms = ms[4], alpha = field.sim.WB[i, 1]), y = c(S = 50, I = 1),  func = solve.field, method = "ode45")[10001,]
}

  #Post sim H* and y* calcs
field.sim.WB <- as.data.frame(field.sim.WB)
colnames(field.sim.WB)[1:4] <- c("alpha", "time.step", "S", "I")
field.sim.WB$H <- field.sim.WB$S + field.sim.WB$I
field.sim.WB$y <- field.sim.WB$I / (field.sim.WB$S + field.sim.WB$I)
field.sim.WB$alpha.mod <- alpha.mod


  #plots
par(mfrow = c(1,2))
plot(H ~ alpha, data = field.sim.WB, ylim = c(0,200), xlim = c(-0.05,0.15), ylab = "H*", t = "l")
points(H[2] ~ alpha[2], data = field.sim.WB, pch = 1, col = "red") #measured alpha
points(H[13] ~ alpha[13], data = field.sim.WB, pch = 0, col = "green") #field y* alpha
points(H[65] ~ alpha[65], data = field.sim.WB, pch = 8, col = "orange") #min H* alpha
arrows(0.0001+0.033, 172.27, 0.0001-0.033, 172.27, length = 0.05, angle = 90, code = 3, col = "red")
plot(y ~ alpha, data = field.sim.WB, ylim = c(0,1), xlim = c(-0.05,0.15), ylab = "y*", t = "l")
points(y[2] ~ alpha[2], data = field.sim.WB, pch = 1, col = "red")
points(y[13] ~ alpha[13], data = field.sim.WB, pch = 0, col = "green")
points(y[65] ~ alpha[65], data = field.sim.WB, pch = 8, col = "orange")
arrows(0.0001+0.033, 0.79, 0.0001-0.033, 0.79, length = 0.05, angle = 90, code = 3, col = "red")

r.T1 <- data.frame(r.T1)

r.T1[10001,2] + r.T1[10001,3] #Host pop. size: DC*1 = 147.84, DC*0.9 = 159.93, DC*1.1 = 145.18, DC*1.2 = 146.57
                              #Host pop. size: LP*1 = 233.15, LP*0.9 = 298.69, LP*1.3 = 198.09, LP*1.4 = 198.84
                              #Host pop. size: NB*1 = 452.16, NB*0.9 = 1181.9, NB*2.0 = 212.03, NB*2.1 = 214.11
                              #Host pop. size: WB*1 = 173.67, WB*0.9 = 526.16, WB*1.5 = 98.14, WB*1.6 = 98.39

r.T1[10001,3]/(r.T1[10001,2] + r.T1[10001,3]) #Prevalence: DC = 0.46, LP = 0.63, NB = 0.88, WB = 0.79

prevalence <-c(r.T1[1001,6]/(r.T1[1001,2] + r.T1[1001,6]), r.T1[1001,7]/(r.T1[1001,3] + r.T1[1001,7]), r.T1[1001,8]/(r.T1[1001,4] + r.T1[1001,8]), r.T1[1001,9]/(r.T1[1001,5] + r.T1[1001,9]))
prevalence

#parameters (DC, LP, NB, WB)
      ### ---> Simulation results aren't making a lot of sense (all becoming infected)?
          ###Possible causes: (1) transmission rates are too high? (2) Infected mortality rates too low? (3) Leaf production rates low
      ###Decreased transmission rates at constant proportion until numbers match field densities-ish (??) keep relative diffs same


      ###Develop for loop to solve for population size and prevalence at different pathogenicities
          


```


##ABC (Approximate Bayesian Computation)
```{r eval = FALSE, echo = FALSE}
#ABC

##Function for SA disease model
solve.Disease.ABC <- function(t, y, parms) {
  y[y < 0] <- 0
  with(c(parms, y), {
     y[y < 0] <- 0
     dS <- a - b * S * I
     dI <- b * S * I - mi * I
     dD <- mi * I
     return(list(c(dS, dI, dD)))
  })
}

#a = leaf production rate, eelgrass produces leaves independent of number of leaves present
#b = transmission rate
#mi = infected leaf mortality rate

##Uploading data
mesocosm.transmission <- read.csv("transmission.SimA.model.csv")
mesocosm.transmission.CB <- mesocosm.transmission[c(1:11), c(2,37:39)]
mesocosm.transmission.LP <- mesocosm.transmission[c(12:22), c(2,37:39)]
mesocosm.transmission.NB <- mesocosm.transmission[c(23:33), c(2,37:39)]
mesocosm.transmission.WB <- mesocosm.transmission[c(34:44), c(2,37:39)]

##Cost function
cost_function_ABC <- function(x, sim_pars) {
  sol <- ode(t = sim_pars$times, parms = list(a = x[1], b = x[2], mi = x[3]), y = sim_pars$N0, func = solve.Disease.ABC, method = "ode45")[c(1,2,3,4,5,6,8,11,15,22,29),]
  result <- sqrt(mean((sim_pars$data[,2] - sol[,2])^2)) + sqrt(mean((sim_pars$data[,3] - sol[,3])^2)) + sqrt(mean((sim_pars$data[,4] - sol[,4])^2))
  return(result)
}

##Acceptance function
acceptance_ABC <- function(x, sim_pars, tol) {
  if (any(x <= 0)) {
    return(FALSE)
    }
  sim_data <- cost_function_ABC(x, sim_pars)
  if (sim_data <= tol) {
    return(TRUE)
  } else {
    return(FALSE)
    }
}

mcmc_abc <- function(init_vals = runif(3), sim_pars, hyper_pars, niters = 10000, nchains = 3, tol = 6) {
  chain <- array(dim = c(niters + 1, nchains, length(init_vals)/nchains))
  chain[1, , ] <- init_vals
  for (i in 1:niters) {
    for (j in 1:nchains) {
      proposal_pars <- c(rnorm(n = 1, mean = chain[i, j, 1], sd = hyper_pars$sd_a), rnorm(n = 1, mean = chain[i, j, 2], sd = hyper_pars$sd_b), rnorm(n = 1, mean = chain[i, j, 3], sd = hyper_pars$sd_mi))
      if (acceptance_ABC(proposal_pars, sim_pars, tol)) {
        chain[i + 1, j, ] <- proposal_pars
      } else {
        chain[i + 1, j, ] <- chain[i, j, ]
      }
    }
  }
  dimnames(chain)[[3]] <- c("a", "b", "mi")
  return(chain)
}

#Trace plot ABC
trace_plot_abc <- function(x, burnin = 0) {
  names <- colnames(x)
  n <- ncol(x)
  par(mfrow = c(n, 2))
  for (i in 1:n) {
    plot(x[, i], type = "l", xlab = "Iterations", ylab = names[i], ylim = range(x[, i]), main = paste0("Trace of ", names[i]))
    d <- density(x[, i])
    plot(d$y, d$x, xlab = "Density", ylab = names[i], type = "l", ylim = range(x[, i]), main = paste0("Density of ", names[i]))
    abline(h = x[nrow(x), i], col = "red")
  }
}

set.seed(10)
nchains <- 3
start_values <- cbind(runif(nchains, min =0.033, max = 0.045), runif(nchains, min = 0, max = 1), runif(nchains, min = 0.068, max = 0.078)) #need to calcualte all values in per days!!
tol <- 1
data <- mesocosm.transmission.CB
times <- 0:28
N0 <- c(S = 2.17, I = 1, D = 0)
sim_pars <- list(N0 = N0, data = data, times = times)
hyper_pars <- list(sd_a = 0.019, sd_b = 0.05, sd_mi = 0.035)
posterior <- mcmc_abc(init_vals = start_values, sim_pars = sim_pars, hyper_pars = hyper_pars, niters = 30000, nchains = 3, tol = tol)

trace_plot_abc(posterior[, , 2])

#Bayesian Credible Intervals (BCI)
alpha <- 0.05; burnin <- 2000
print(bci <- apply(posterior[(burnin + 1):nrow(posterior), , ], 
                   MARGIN = c(2,3), FUN = function(x)
                     quantile(x, c(alpha/2, 0.5, 1-alpha/2))))

## running model with parameters from ABC
sol.final.cb <- ode(t = sim_pars$times, parms = list(a = 0.040, b = 0.22, mi = 0.036), y = sim_pars$N0, func = solve.Disease.ABC, method = "ode45")[c(1,2,3,4,5,6,8,11,15,22,29),]

## Plotting data
par(mfrow = c(1,1))
plot(mean.s ~ Day, data = mesocosm.transmission.CB, col = "green", ylim = c(0,5), ylab = "Leaves per plant") #Experiment susceptible
points(mean.i ~ Day, data = mesocosm.transmission.CB, col = "red") #Experiment infected
points(mean.d ~ Day, data = mesocosm.transmission.CB) #Experiment dead
points(S ~ time, data = sol.final.cb, t = "l", col = "green") #simulated susceptible
points(I ~ time, data = sol.final.cb, t = "l", col = "red") #simulated infected
points(D ~ time, data = sol.final.cb, t = "l") #simulated dead
legend("topright", legend = c("Susceptible", "Infected", "Dead"), col = c("green", "red", "black"), lty = 1, cex = 0.5)
```


#Day0 Analyses

##Data manipulation
```{r eval = FALSE, echo = FALSE}
mesocosm.leaf.d0 <- filter(mesocosm.leaf, experiment.day == "0")
str(mesocosm.leaf.d0)
```

##Lesion Spread Figures and Analyes
```{r eval = FALSE, echo = FALSE}
#Figures
  ##Infection proportion ~ site * leaf.no
bargraph.CI(x.factor = exp.leaf.no, group = site, response = lesion.presence, data = mesocosm.leaf.d0, ylim = c(0,1), ylab = "Proportion of leaves with lesions", xlab = "Leaf number", legend = T)

  ##Infection proportion ~ infection treatment * leaf.no
bargraph.CI(x.factor = exp.leaf.no, group = infection, response = lesion.presence, data = mesocosm.leaf.d0, ylim = c(0,1), ylab = "Proportion of leaves with lesions", xlab = "Leaf number", legend = T)
  ##Infection proportion ~ infection treatment * leaf.no (only leaves 1 and 2)
bargraph.CI(x.factor = exp.leaf.no, group = infection, response = lesion.presence, data = filter(d1.d0, exp.leaf.no == "1" | exp.leaf.no == "2"), ylim = c(0,1), ylab = "Proportion of leaves with lesions", xlab = "Leaf number", legend = T)
            
  ##Infected proportion ~ site * infection treatment
bargraph.CI(x.factor = site, group = infection, response = lesion.presence, data = d1.d0, ylim = c(0,1), ylab = "Proportion of leaves with lesions", xlab = "Site", legend = T)
  ##Infection proportion ~ site * infection (only leaves 1 and 2)
bargraph.CI(x.factor = site, group = infection, response = lesion.presence, data = filter(d1.d0, exp.leaf.no == "1" | exp.leaf.no == "2"), ylim = c(0,1), ylab = "Proportion of leaves with lesions", xlab = "Infection Expected", legend = T)


#Analyses

  ###Something wrong here and no p-values??
model.lesion.presence <- glmer(cbind(lesion.presence, lesion.absence) ~ infection*site*exp.leaf.no + (1|shoot.ID) + (1|mesocosm), data = filter(d1.d0, exp.leaf.no != "5" & exp.leaf.no != "4"), family = "binomial")
anova(model.lesion.presence, test = "LR")
```


##Lesion Percent Cover Figures and Analyses
```{r eval = FALSE, echo = FALSE}
#Figures

  ##Lesion Percent Cover ~ Site * Leaf.no
bargraph.CI(x.factor = exp.leaf.no, group = site, response = lesion.pc, data = mesocosm.leaf.d0, ylim = c(0,10), ylab = "Lesion percent cover", xlab = "Site", legend = T)

  ##Lesion percent cover ~ infection treatment * leaf.no
bargraph.CI(x.factor = exp.leaf.no, group = infection, response = lesion.pc, data = mesocosm.leaf.d0, ylim = c(0,10), ylab = "Lesion percent cover", xlab = "Infection Expected", legend = T)

  ##Lesion percent cover ~ site * infection treatment
bargraph.CI(x.factor = site, group = infection, response = lesion.pc, data = filter(d1.d0, lesion.presence == "1" & exp.leaf.no != "4" & exp.leaf.no != "5"), ylim = c(0,10), ylab = "Lesion percent cover", xlab = "Site", legend = T)

  ##Lesion percent cover ~ site
bargraph.CI(x.factor = site, response = lesion.pc, data = filter(d1.d0, lesion.presence == "1"), ylim = c(0,100), ylab = "Lesion percent cover", xlab = "Site", legend = T)

#Analyses
model.lesion.pc.d0 <- lmer(lesion.pc ~ infection*site*exp.leaf.no + (1|shoot.ID) + (1|mesocosm), data = filter(d1.d0, lesion.presence == "1"))
anova(model.lesion.pc.d0) #main effect of site, interaction of site:leaf number, but not biologically significant! Also hard to deal with contrasts when sites have diff. amt of leaves with lesions

# Including plants WITHOUT lesions (aka including 0% values) and excluding leaves 4 and 5 because of lack of replication at this high leaf number 
model.lesion.pc.d0.all.plants <- lmer(lesion.pc ~ infection*site*exp.leaf.no + (1|shoot.ID) + (1|mesocosm), data = filter(d1.d0, exp.leaf.no != "4" & exp.leaf.no != "5"))
anova(model.lesion.pc.d0.all.plants) #no effects significant and NO ERRORS in model.
```

##Length Figures and Analyses
```{r eval = FALSE, echo = FALSE}
#Figures

  ##Shoot Length ~ infection *site
bargraph.CI(x.factor = site, group = infection, response = S1.total.length.initial, data = mesocosm.shoot)

  ##Leaf Length ~ infection * site
bargraph.CI(x.factor = site, group = infection, response = length.cm, data = filter(mesocosm.leaf.d0, exp.leaf.no == "2"), ylim = c(0,30), ylab = "Leaf length (cm)", xlab = "Site", legend = T)

  ##Length ~ infection * leaf number (*only DC)
bargraph.CI(x.factor = exp.leaf.no, group = infection, response = length.cm, data = filter(d1.d0, site =="DC" & exp.leaf.no != "5"), ylim = c(0,30), ylab = "Leaf length (cm)", xlab = "Leaf number", legend = T)

  #Length ~ site * exp.leaf.no (Excluding leaves 4 and 5)
bargraph.CI(x.factor = exp.leaf.no, group = site, response = length.cm, data = filter(mesocosm.leaf.d0, exp.leaf.no != "5" & exp.leaf.no != "4"), ylim = c(0,30), ylab = "Leaf length (cm)", xlab = "Leaf number", legend = T)

#Analyses
  ##Including all leaves in analysis
model.length.cm.d0 <- lmer(length.cm ~ infection*site*exp.leaf.no + (1|shoot.ID) + (1|mesocosm), data = d1.d0)
anova(model.length.cm.d0) ##Not all sites have multiple plants with 4th or 5th leaf

  ###Checking to see if results change if exclude leaves 4 and 5 from analyses
model.length.cm.d0.L123 <- lmer(length.cm ~ site*infection*exp.leaf.no + (1|shoot.ID) + (1|mesocosm), data = filter(d1.d0, exp.leaf.no != "4" & exp.leaf.no != "5"))
anova(model.length.cm.d0.L123) ##not change in results; error message goes away :)
```


#Day5 Analyses

##Data manipulation
```{r eval = FALSE, echo = FALSE}
d1.d5 <- filter(d1, experiment.day == "5" & mesocosm != "28")
str(d1.d5)

#Leaf Growth
d0 <- subset(d1.d0, select = c(researcher:exp.leaf.no, lesion.pc, length.cm, no.leaves, lesion.presence, lesion.absence))

d1.d5 <- merge(d1.d5, d0, all.x = TRUE, by = c("vase", "exp.leaf.no"))
d1.d5 <- subset(d1.d5, select = c(vase:shoot.ID, lesion.pc.y, length.cm.y, no.leaves.y, lesion.presence.y, lesion.absence.y))
str(d1.d5)

d1.d5$delta.sheath.length[is.na(d1.d5$delta.sheath.length)] <- 0
d1.d5$std.length.cm <- d1.d5$length.cm.x - d1.d5$delta.sheath.length

d1.d5$delta.length.cm <- d1.d5$std.length.cm - d1.d5$length.cm.y

##Lesion Percent Cover and Leaf Growth Effect Sizes
d1.d5.ef <- d1.d5 %>%
  filter(infection.x == "N") %>%
  filter(exp.leaf.no != "4" & exp.leaf.no != "5") %>%
  group_by(site.x, exp.leaf.no) %>%
  summarize(control.lpc5 = mean(lesion.pc.x, na.rm = T), control.growth5 = mean(delta.length.cm, na.rm = T))

d5.ef <- merge(d1.d5, d1.d5.ef, by = c("site.x", "exp.leaf.no"), all.x = T)

d5.ef <- d5.ef %>%
  filter(infection.x == "Y") %>%
  filter(exp.leaf.no != "4" & exp.leaf.no != "5") %>%
  subset(select = c(site.x, exp.leaf.no, vase, mesocosm.x, lesion.pc.x, delta.length.cm, control.lpc5, control.growth5))

d5.ef$lpc.ef <- (d5.ef$lesion.pc.x - d5.ef$control.lpc5)/d5.ef$control.lpc5
d5.ef$growth.ef <- (d5.ef$delta.length.cm - d5.ef$control.growth5)/d5.ef$control.growth5

#data for growth effect size figures
d5.ef.fig <- d5.ef %>%
  filter(exp.leaf.no != "0") %>%
  group_by(exp.leaf.no) %>%
  summarize(growth.ef.mean = mean(growth.ef, na.rm = T), growth.ef.95ci = 1.96*se(growth.ef))

#Leaf number
d1.d5.leaves = d1.d5 %>%
  filter(no.leaves.y != "NA") %>%
  group_by(mesocosm.x, infection.x, site.x, shoot.ID) %>%
  summarize(no.leaves.x = mean(no.leaves.x), no.leaves.y = mean(no.leaves.y), no.leaves.new = mean(no.leaves.new), no.leaves.lost = mean(no.leaves.lost))

d1.d5.leaves$delta.no.leaves <- d1.d5.leaves$no.leaves.x - d1.d5.leaves$no.leaves.y

##Leaf number effect sizes
d1.d5.leaves.ef <- d1.d5.leaves %>%
  filter(infection.x == "N") %>%
  group_by(infection.x) %>%
  summarize(control.dnl = mean(delta.no.leaves, na.rm = T), control.new = mean(no.leaves.new, na.rm = T), control.lost = mean(no.leaves.lost, na.rm =T))

#d5.leaves.ef <- merge(d1.d5.leaves, d1.d5.leaves.ef, by = c("site.x"), all.x = T)

#d5.leaves.ef <- d5.leaves.ef %>%
  #filter(infection.x == "Y") %>%
  #subset(select = c(site.x, mesocosm.x, no.leaves.new:control.lost))

d5.leaves.ef <- merge(filter(d1.d5.leaves, infection.x == "N"), d1.d5.leaves.ef, by = c("infection.x"), all.x = T)
d5.leaves.ef <- subset(d5.leaves.ef, select = c("site.x", "control.dnl", "control.new", "control.lost"))

d5.leaves.ef <- merge(d1.d5.leaves, d5.leaves.ef, by = "site.x", all.x =T)
d5.leaves.ef <- d5.leaves.ef %>%
  filter(infection.x == "Y") %>%
  group_by(infection.x, shoot.ID) %>%
  summarize(delta.no.leaves = mean(delta.no.leaves), no.leaves.new = mean(no.leaves.new), no.leaves.lost = mean(no.leaves.lost), control.dnl = mean(control.dnl), control.new = mean(control.new), control.lost = mean(control.lost))

d5.leaves.ef$dnl.ef <- (d5.leaves.ef$delta.no.leaves - d5.leaves.ef$control.dnl)/d5.leaves.ef$control.dnl
d5.leaves.ef$new.ef <- (d5.leaves.ef$no.leaves.new - d5.leaves.ef$control.new)/d5.leaves.ef$control.new
d5.leaves.ef$lost.ef <- (d5.leaves.ef$no.leaves.lost - d5.leaves.ef$control.lost)/d5.leaves.ef$control.lost
###how to deal with leaves lost being 0 for controls --> don't analyze by site

d5.leaves.ef.fig <- d5.leaves.ef %>%
  group_by(infection.x) %>%
  summarize(dnl.ef.mean = mean(dnl.ef), dnl.ef.95ci = 1.96*se(dnl.ef), new.ef.mean = mean(new.ef), new.ef.95ci = 1.96*se(new.ef), lost.ef.mean = mean(lost.ef), lost.ef.95ci = 1.96*se(lost.ef))

d5.leaves.ef.fig$infection.x <- c("")
d5.leaves.ef.fig$infection.x <- as.factor(d5.leaves.ef.fig$infection.x)
str(d5.leaves.ef.fig)
```

##Lesion Spread Figures and Analyes
```{r eval = FALSE, echo = FALSE}
#Figures

 ##Infection proportion ~ infection treatment * leaf.no
bargraph.CI(x.factor = exp.leaf.no, group = infection.x, response = lesion.presence.x, data = d1.d5, ylim = c(0,2), ylab = "Proportion of leaves with lesions", xlab = "Leaf number", legend = T)

  ##Infected proportion ~ site * infection treatment
bargraph.CI(x.factor = site.x, group = infection.x, response = lesion.presence.x, data = d1.d5, ylim = c(0,2), ylab = "Proportion of leaves with lesions", xlab = "Site", legend = T)

  ##Infection proportion ~ site * leaf.no (*Only infected)
bargraph.CI(x.factor = exp.leaf.no, group = site.x, response = lesion.presence.x, data = filter(d1.d5, infection.x == "Y"), ylim = c(0,2), ylab = "Proportion of leaves with lesions", xlab = "Site", legend = T)

#Analyses (Get glm code from Torrie 1/12/17)


```

##Lesion Percent Cover Figures and Analyses
```{r eval = FALSE, echo = FALSE}
#Figures

  ## Lesion percent cover effect size ~ leaf.no (grouped by site)
bargraph.CI(x.factor = exp.leaf.no, group = site.x, response = lpc.ef, data = d5.ef, ylim = c(0,100), ylab = "Effect of disease on lesion percent cover", xlab = "Leaf number", legend = T)

  ##Lesion percent cover ~ infection treatment * leaf.no
#bargraph.CI(x.factor = exp.leaf.no, group = infection.x, response = lesion.pc.x, data = filter(d1.d5, lesion.presence.x == "1"), ylim = c(0,100), ylab = "Lesion percent cover", xlab = "Leaf number", legend = T)
    ###Lesion percent cover ~ infection treatment * leaf.no (*all leaves, excluding leaves 4 & 5)
par(mfrow = c(2,2))
bargraph.CI(x.factor = exp.leaf.no, group = infection.x, response = lesion.pc.x, data = filter(d1.d5, exp.leaf.no != "4" & exp.leaf.no != "5" & site.x == "DC"), ylim = c(0,100), ylab = "Lesion percent cover", xlab = "Leaf number", legend = T) ##DC plot
bargraph.CI(x.factor = exp.leaf.no, group = infection.x, response = lesion.pc.x, data = filter(d1.d5, exp.leaf.no != "4" & exp.leaf.no != "5" & site.x == "LP"), ylim = c(0,100), ylab = "Lesion percent cover", xlab = "Leaf number", legend = T) ##LP plot
bargraph.CI(x.factor = exp.leaf.no, group = infection.x, response = lesion.pc.x, data = filter(d1.d5, exp.leaf.no != "4" & exp.leaf.no != "5" & site.x == "NB"), ylim = c(0,100), ylab = "Lesion percent cover", xlab = "Leaf number", legend = T) ##NB plot
bargraph.CI(x.factor = exp.leaf.no, group = infection.x, response = lesion.pc.x, data = filter(d1.d5, exp.leaf.no != "4" & exp.leaf.no != "5" & site.x == "WB"), ylim = c(0,100), ylab = "Lesion percent cover", xlab = "Leaf number", legend = T) ##WB plot

  ##Lesion percent cover ~ infection treatment * leaf.no (*all leaves, excluding leaves 4 and 5)
#bargraph.CI(x.factor = exp.leaf.no, group = infection.x, response = lesion.pc.x, data = filter(d1.d5, exp.leaf.no != "4" & exp.leaf.no != "5"), ylim = c(0,100), ylab = "Lesion percent cover", xlab = "Leaf number", legend = T)

  ##Lesion percent cover ~ site * infection treatment
#bargraph.CI(x.factor = site.x, group = infection.x, response = lesion.pc.x, data = filter(d1.d5, lesion.presence.x == "1"), ylim = c(0,100), ylab = "Lesion percent cover", xlab = "Site", legend = T)

  ##Lesion Percent Cover ~ Site * Leaf.no (*Only infected)
par(mfrow = c(1,1))
bargraph.CI(x.factor =  exp.leaf.no, group =site.x, response = lesion.pc.x, data = filter(d1.d5, infection.x == "Y" & exp.leaf.no != "4" & exp.leaf.no != "5"), ylim = c(0,100), ylab = "Lesion percent cover", xlab = "Leaf number", legend = T)

  ##Lesion Percent Cover ~ Site * Leaf.no (*Only control)
par(mfrow = c(1,1))
bargraph.CI(x.factor =  exp.leaf.no, group =site.x, response = lesion.pc.x, data = filter(d1.d5, infection.x == "N" & exp.leaf.no != "4" & exp.leaf.no != "5"), ylim = c(0,5), ylab = "Lesion percent cover", xlab = "Leaf number", legend = T)

  ##Lesion Percent Cover ~ Site * Leaf.no (*Only infected and all leaves)
#bargraph.CI(x.factor = exp.leaf.no, group = site.x, response = lesion.pc.x, data = filter(d1.d5, infection.x == "Y"), ylim = c(0,100), ylab = "Lesion percent cover", xlab = "Leaf number", legend = T)

#Analyses
#model.lesion.pc.d5 <- lmer(lesion.pc.x ~ infection.x*site.x*exp.leaf.no + (1|shoot.ID) + (1|mesocosm.x) + lesion.pc.y, data = filter(d1.d5, lesion.presence.x == "1"))
#anova(model.lesion.pc.d5)

#Correct FULL model (1/23/17)
model.lesion.pc.d5.all <- lmer(lesion.pc.x ~ infection.x*site.x*exp.leaf.no + (1|shoot.ID) + (1|mesocosm.x), data = filter(d1.d5, exp.leaf.no != "4" & exp.leaf.no != "5")) ##Including leaves with 0% infection, exclude leaves 4 and 5 because of lack of replication across sites, lesion.pc.y not significant so removed from model
anova(model.lesion.pc.d5.all)

model.lesion.pc.disease.d5 <- lmer(lesion.pc.x ~ site.x*exp.leaf.no + (1|shoot.ID) + (1|mesocosm.x) + lesion.pc.y, data = filter(d1.d5, infection.x == "Y" & exp.leaf.no != "4" & exp.leaf.no != "5")) #Looking at relationship between site and leaf number within infected plants
anova(model.lesion.pc.disease.d5)

model.lesion.pc.control.d5 <- lmer(lesion.pc.x ~ site.x*exp.leaf.no + (1|shoot.ID) + (1|mesocosm.x) + lesion.pc.y, data = filter(d1.d5, infection.x == "N" & exp.leaf.no != "4" & exp.leaf.no != "5")) #Looking at relationship between site and leaf number within control plants
anova(model.lesion.pc.control.d5)

  ##Just leaf 2 of infected plants that are showing signs of lesions (aka all plants)
#model.lesion.pc.d5.leaf2 <- lmer(lesion.pc.x ~ site.x + (1|mesocosm.x) + lesion.pc.y, data = filter(d1.d5, lesion.presence.x == "1" & exp.leaf.no == "2" & infection.x == "Y"))
#anova(model.lesion.pc.d5.leaf2)
```

##Leaf Growth Figures and Analyses
```{r eval = FALSE, echo = FALSE}
 ## Growth effect size ~ leaf.no (grouped by site)
fig.growth <- barplot(c(0,0), names = d5.ef.fig$exp.leaf.no[1:2] , ylim = c(-1, 1),
                  ylab = "Effect size of disease on leaf growth",
                  xlab = "Leaf number")
points(x = fig.growth, d5.ef.fig$growth.ef.mean[1:2])
arrows(y0 = d5.ef.fig$growth.ef.mean[1:2] - d5.ef.fig$growth.ef.95ci[1:2], y1 = d5.ef.fig$growth.ef.mean[1:2] + d5.ef.fig$growth.ef.95ci[1:2], x0 = fig.growth, x1 =fig.growth, angle = 90, code = 3, #95% CI
length = 0.1)

#bargraph.CI(x.factor = exp.leaf.no, group = site.x, response = growth.ef, data = filter(d5.ef, exp.leaf.no != "3"), ylim = c(-1,1), ylab = "Effect of disease on leaf growth", xlab = "Leaf number", legend = T)

  ##Growth ~ infection treatment * leaf.no (Excluding leaves 4 and 5)
bargraph.CI(x.factor = exp.leaf.no, group = infection.x, response = delta.length.cm, data = filter(d1.d5, exp.leaf.no != "4" & exp.leaf.no != "5"), ylim = c(0,7), ylab = "Leaf growth (cm)", xlab = "Leaf number", legend = T)

  ##Growth ~ site * leaf.no 
bargraph.CI(x.factor = exp.leaf.no, group = site.x, response = delta.length.cm, data = filter(d1.d5, exp.leaf.no != "4" & exp.leaf.no != "5"), ylim = c(0,7), ylab = "Leaf growth (cm)", xlab = "Leaf number", legend = T)

#Analyses
model.growth.std.d5 <- lmer(std.length.cm ~ infection.x*site.x*exp.leaf.no + (1|shoot.ID) + (1|mesocosm.x) + length.cm.y, data = filter(d1.d5, exp.leaf.no != "4" & exp.leaf.no != "5")) #adjusting for delta sheath length (*Excluding leaves 4 and 5 because not enough reps for adequate contrasts)
anova(model.growth.std.d5) #Significant interactions: site*leaf number and Infection*leaf number
```

##Change in leaf number Figures and Analyses
```{r eval = FALSE, echo = FALSE}
#Figures

##Change in leaves (effect size)
#bargraph.CI(x.factor = infection.x, response = dnl.ef, data = d5.leaves.ef, ylim = c(-5,5), ylab = "Effect of disease on change in leaf number")

fig.dnl <- barplot(0, names =d5.leaves.ef.fig$infection.x , ylim = c(-5, 5),
                  ylab = "Effect size of disease on net leaf change",
                  xlab = "")
points(x = fig.dnl[1], d5.leaves.ef.fig$dnl.ef.mean[1])
arrows(y0 = d5.leaves.ef.fig$dnl.ef.mean - d5.leaves.ef.fig$dnl.ef.95ci, y1 = d5.leaves.ef.fig$dnl.ef.mean + d5.leaves.ef.fig$dnl.ef.95ci, x0 = fig.dnl, x1 =fig.dnl, angle = 90, code = 3, #95% CI
length = 0.1)

## number of leaves lost (effect size)
fig.lost <- barplot(0, names =d5.leaves.ef.fig$infection.x , ylim = c(-35, 35),
                  ylab = "Effect size of disease on the number of leaves lost",
                  xlab = "")
points(x = fig.lost[1], d5.leaves.ef.fig$lost.ef.mean[1])
arrows(y0 = d5.leaves.ef.fig$lost.ef.mean - d5.leaves.ef.fig$lost.ef.95ci, y1 = d5.leaves.ef.fig$lost.ef.mean + d5.leaves.ef.fig$lost.ef.95ci, x0 = fig.dnl, x1 =fig.dnl, angle = 90, code = 3, #95% CI
length = 0.1)

#bargraph.CI(x.factor = infection.x, response = lost.ef, data = d5.leaves.ef, ylab = "Effect of disease on leaves lost")

## number of leaves new (effect size)
#bargraph.CI(x.factor = infection.x, response = new.ef, data = d5.leaves.ef, ylab = "Effect of disease on leaves produced")

fig.new <- barplot(0, names =d5.leaves.ef.fig$infection.x , ylim = c(-2, 2),
                  ylab = "Effect size of disease on the number of new leaves",
                  xlab = "")
points(x = fig.new[1], d5.leaves.ef.fig$new.ef.mean[1])
arrows(y0 = d5.leaves.ef.fig$new.ef.mean - d5.leaves.ef.fig$new.ef.95ci, y1 = d5.leaves.ef.fig$new.ef.mean + d5.leaves.ef.fig$new.ef.95ci, x0 = fig.dnl, x1 =fig.dnl, angle = 90, code = 3, #95% CI
length = 0.1)

  ##Change in leaves ~ infection
bargraph.CI(x.factor = infection.x, response = delta.no.leaves, data = d1.d5.leaves, ylim = c(-1,1), ylab = "Change in the number of leaves per shoot", xlab = "Infection")

  ##Number of leaves lost ~ infection
  bargraph.CI(x.factor = infection.x, response = no.leaves.lost, data = d1.d5.leaves, ylim = c(0, 1), ylab = "Number of leaves lost per shoot", xlab = "Site", legend = T)
  
  
#Analyses
model.no.leaves.d5 <- lmer(no.leaves.x ~ infection.x*site.x + (1|mesocosm.x) + no.leaves.y, data = d1.d5.leaves)
anova(model.no.leaves.d5) #Significant effect of infection

model.new.leaves.d5 <- lmer(no.leaves.new ~ infection.x*site.x + (1|mesocosm.x) + no.leaves.y, data = d1.d5.leaves)
anova(model.new.leaves.d5) # No significant effects

model.leaves.lost.d5 <- lmer(no.leaves.lost ~ infection.x*site.x + (1|mesocosm.x) + no.leaves.y, data = d1.d5.leaves)
anova(model.leaves.lost.d5) #Significant main effect of infection, marginal effect of site (P = 0.056)
```

#Day28 Analyses
##Data manipulation
```{r eval = FALSE, echo = FALSE}
mesocosm.leaf.d28 <- filter(mesocosm.leaf, experiment.day == "28")
str(mesocosm.leaf.d28)

##CHANGE IN LEAF NUMBER
d1.d28.leaf.no <- merge(d1.d28, d0, all.x = TRUE, by = c("vase", "exp.leaf.no"))
d1.d28.leaf.no <- subset(d1.d28.leaf.no, select = c(vase:shoot.ID, lesion.pc.y, length.cm.y, no.leaves.y, lesion.presence.y))
str(d1.d28.leaf.no)
d1.d28.leaves = d1.d28.leaf.no %>%
  filter(no.leaves.y != "NA") %>%
  group_by(mesocosm.x, infection.x, site.x, shoot.ID) %>%
  summarize(no.leaves.x = mean(no.leaves.x), no.leaves.y = mean(no.leaves.y), no.leaves.new = mean(no.leaves.new), no.leaves.lost = mean(no.leaves.lost))

d1.d28.leaves$delta.no.leaves <- d1.d28.leaves$no.leaves.x - d1.d28.leaves$no.leaves.y

## LEAF GROWTH
d5 <- subset(d1.d5, select = c(vase:exp.leaf.no, lesion.pc.x, delta.sheath.length, std.length.cm, lesion.presence.x, lesion.absence.x))

d1.d28 <- merge(d1.d28, d0, all.x = TRUE, by = c("vase", "exp.leaf.no"))
d1.d28 <- subset(d1.d28, select = c(vase:shoot.ID, lesion.pc.y:lesion.absence.y))

colnames(d1.d28)[13:15] <- c("length.cm.d28", "area.cm.d28", "lesion.area.d28")
colnames(d1.d28)[17:20] <- c("lesion.pc.d28", "lesion.presence.d28", "lesion.absence.d28", "no.leaves.d28")
colnames(d1.d28)[25] <- "delta.sheath.length.d28"
colnames(d1.d28)[29:33] <- c("lesion.pc.d0", "length.cm.d0", "no.leaves.d0", "lesion.presence.d0", "lesion.absence.d0")

d1.d28 <- merge(d1.d28, d5, all.x = TRUE, by = c("vase", "exp.leaf.no"))

colnames(d1.d28)[34:38] <- c("lesion.pc.d5", "delta.sheath.length.d5", "std.length.cm.d5", "lesion.presence.d5", "lesion.abseence.d5")

d1.d28$delta.sheath.length.d28[is.na(d1.d28$delta.sheath.length.d28)] <-0
d1.d28$delta.sheath.length.d5[is.na(d1.d28$delta.sheath.length.d5)] <- 0

  ###TOTAL GROWTH
d1.d28$delta.sheath.length.total <- d1.d28$delta.sheath.length.d5 + d1.d28$delta.sheath.length.d28
d1.d28$std.length.cm.total <- d1.d28$length.cm.d28 - d1.d28$delta.sheath.length.total

d1.d28.leaf.growth.total <- subset(d1.d28, select = c(vase:current.leaf.no, shoot.ID, std.length.cm.total, length.cm.d0))
d1.d28.leaf.growth.total <- filter(d1.d28.leaf.growth.total, std.length.cm.total != "NA" & length.cm.d0 != "NA")

d1.d28.leaf.growth.total$delta.length.cm <- d1.d28.leaf.growth.total$std.length.cm.total - d1.d28.leaf.growth.total$length.cm.d0


    ####Leaf growth total effect size leaf 1
d1.d28.L1.total.ef <- filter(d1.d28.leaf.growth.total, exp.leaf.no == "1")

d1.d28.L1.total.ef.mean <- aggregate(delta.length.cm ~ infection.x*site.x, FUN = mean, data = d1.d28.L1.total.ef)

d1.d28.L1.total.ef <- filter(d1.d28.L1.total.ef, infection.x == "Y")

d1.d28.L1.total.ef.DC <- filter(d1.d28.L1.total.ef, site.x == "DC")
d1.d28.L1.total.ef.DC$growth.ef <- (d1.d28.L1.total.ef.DC$delta.length.cm - 11.885909)/11.885909

d1.d28.L1.total.ef.LP <- filter(d1.d28.L1.total.ef, site.x == "LP")
d1.d28.L1.total.ef.LP$growth.ef <- (d1.d28.L1.total.ef.LP$delta.length.cm - 9.808545)/9.808545

d1.d28.L1.total.ef.NB <- filter(d1.d28.L1.total.ef, site.x == "NB")
d1.d28.L1.total.ef.NB$growth.ef <- (d1.d28.L1.total.ef.NB$delta.length.cm - 10.861545)/10.861545

d1.d28.L1.total.ef.WB <- filter(d1.d28.L1.total.ef, site.x == "WB")
d1.d28.L1.total.ef.WB$growth.ef <- (d1.d28.L1.total.ef.WB$delta.length.cm - 7.181091)/7.181091

d1.d28.L1.total.ef <- rbind(d1.d28.L1.total.ef.DC, d1.d28.L1.total.ef.LP, d1.d28.L1.total.ef.NB, d1.d28.L1.total.ef.WB)

d1.d28.L1.total.ef.fig <- d1.d28.L1.total.ef %>%
  group_by(site.x) %>%
  summarize(mean.ef = mean(growth.ef), CI.ef = 1.96*se(growth.ef))

  ###GROWTH SINCE DAY 5
d1.d28$std.length.cm.d5d28 <- d1.d28$length.cm.d28 - d1.d28$delta.sheath.length.d28

d1.d28.leaf.growth.d5d28 <- subset(d1.d28, select = c(vase:current.leaf.no, shoot.ID, std.length.cm.d5d28, std.length.cm.d5))
d1.d28.leaf.growth.d5d28 <- filter(d1.d28.leaf.growth.d5d28, std.length.cm.d5d28 != "NA" & std.length.cm.d5 != "NA")

d1.d28.leaf.growth.d5d28$delta.length.cm <- d1.d28.leaf.growth.d5d28$std.length.cm.d5d28 - d1.d28.leaf.growth.d5d28$std.length.cm.d5

#Total growth effect size day28
d1.d28.ef <- d1.d28.leaf.growth.total %>%
  filter(infection.x == "N") %>%
  filter(exp.leaf.no != "4" & exp.leaf.no != "5") %>%
  group_by(exp.leaf.no) %>%
  summarize(control.growth28 = mean(delta.length.cm, na.rm = T))

d28.ef <- merge(d1.d28.leaf.growth.total, d1.d28.ef, by = c("exp.leaf.no"), all.x = T)

d28.ef <- d28.ef %>%
  filter(infection.x == "Y") %>%
  filter(exp.leaf.no != "4" & exp.leaf.no != "5") %>%
  subset(select = c(exp.leaf.no, mesocosm.x, delta.length.cm, control.growth28))

d28.ef$growth.ef <- (d28.ef$delta.length.cm - d28.ef$control.growth28)/d28.ef$control.growth28

#growth fig day 28
d28.ef.fig <- d28.ef %>%
  filter(exp.leaf.no != "0") %>%
  group_by(exp.leaf.no) %>%
  summarize(growth.ef.mean = mean(growth.ef, na.rm = T), growth.ef.95ci = 1.96*se(growth.ef))

#growth since day 5 effect size
d5.d28.ef <- d1.d28.leaf.growth.d5d28 %>%
  filter(infection.x == "N") %>%
  filter(exp.leaf.no != "4" & exp.leaf.no != "5") %>%
  group_by(exp.leaf.no) %>%
  summarize(control.growth528 = mean(delta.length.cm, na.rm = T))

d528.ef <- merge(d1.d28.leaf.growth.d5d28, d5.d28.ef, by = c("exp.leaf.no"), all.x = T)

d528.ef <- d528.ef %>%
  filter(infection.x == "Y") %>%
  filter(exp.leaf.no != "4" & exp.leaf.no != "5") %>%
  subset(select = c(exp.leaf.no, mesocosm.x, delta.length.cm, control.growth528))

d528.ef$growth.ef <- (d528.ef$delta.length.cm - d528.ef$control.growth528)/d528.ef$control.growth528

#growth since day 5 fig day 28
d528.ef.fig <- d528.ef %>%
  group_by(exp.leaf.no) %>%
  summarize(growth.ef.mean = mean(growth.ef, na.rm = T), growth.ef.95ci = 1.96*se(growth.ef))

#growth figure combined day0-28 and day5-28

#d28.ef.1 <-filter(d28.ef, exp.leaf.no == "1")
#d28.ef.1$control.growth28 <- d28.ef.1$control.growth28 + 5.493182
#d28.ef.1$delta.length.cm <- d28.ef.1$delta.length.cm +5.493182
#d28.ef.1$growth.ef <- (d28.ef.1$delta.length.cm - d28.ef.1$control.growth28)/d28.ef.1$control.growth28

#d28.ef.2 <-filter(d28.ef, exp.leaf.no == "2")
#d28.ef.2$control.growth28 <- d28.ef.2$control.growth28 +  12.57829
#d28.ef.2$delta.length.cm <- d28.ef.2$delta.length.cm +  12.57829
#d28.ef.2$growth.ef <- (d28.ef.2$delta.length.cm - d28.ef.2$control.growth28)/d28.ef.2$control.growth28

#d28.ef.3 <-filter(d28.ef, exp.leaf.no == "3")
#d28.ef.3$control.growth28 <- d28.ef.3$control.growth28 + 14.45502
#d28.ef.3$delta.length.cm <- d28.ef.3$delta.length.cm + 14.45502
#d28.ef.3$growth.ef <- (d28.ef.3$delta.length.cm - d28.ef.3$control.growth28)/d28.ef.3$control.growth28

#d28.ef <- rbind(d28.ef.1, d28.ef.2, d28.ef.3)

#growth fig day 28
#d28.ef.fig <- d28.ef %>%
 # filter(exp.leaf.no != "0") %>%
  #group_by(exp.leaf.no) %>%
  #summarize(growth.ef.mean = mean(growth.ef, na.rm = T), growth.ef.95ci = 1.96*se(growth.ef))

d28.ef.fig <- rbind(d528.ef.fig[1,], d28.ef.fig)


####################################################

##BIOMASS AND RHIZOME LENGTH
  ###biomass (d.28)
d1.shoot$b.t.d28 <- d1.shoot$a.g.d28 + d1.shoot$b.g.d28

d1.shoot <- filter(d1.shoot, mesocosm != "28")

d1.shoot$rhizome.growth <- d1.shoot$rhizome.length.cm.D28 - d1.shoot$rhizome.length.cm.D0

  ###Total Biomass effect size
      #### (mean control[split by site] - individual infected)/ mean control [split by site]
d1.shoot.mean.tb <- aggregate(b.t.d28 ~ site + infection, FUN = mean, data = d1.shoot)

d1.shoot.ef.tb.DC <- subset(d1.shoot, site == "DC")
d1.shoot.ef.tb.LP <- subset(d1.shoot, site == "LP")
d1.shoot.ef.tb.NB <- subset(d1.shoot, site == "NB")
d1.shoot.ef.tb.WB <- subset(d1.shoot, site == "WB")

d1.shoot.ef.tb.DC$tb.ef <- (0.5315455 - d1.shoot.ef.tb.DC$b.t.d28)/0.5315455
d1.shoot.ef.tb.LP$tb.ef <- (0.3527273 - d1.shoot.ef.tb.LP$b.t.d28)/0.3527273
d1.shoot.ef.tb.NB$tb.ef <- (0.4861818- d1.shoot.ef.tb.NB$b.t.d28)/0.4861818
d1.shoot.ef.tb.WB$tb.ef <- (0.6234545 - d1.shoot.ef.tb.WB$b.t.d28)/0.6234545

d1.shoot.ef.tb <- rbind(d1.shoot.ef.tb.DC, d1.shoot.ef.tb.LP, d1.shoot.ef.tb.NB, d1.shoot.ef.tb.WB)

d1.shoot.ef.tb <-subset(d1.shoot.ef.tb, infection == "Y")

  ###Rhizome length effect size
    #### (mean control[split by site] - individual infected)/ mean control [split by site]
d1.shoot.mean.si <- aggregate(rhizome.growth ~ site + infection, FUN = mean, data = d1.shoot)

d1.shoot.ef.rhiz.DC <- subset(d1.shoot, site == "DC")
d1.shoot.ef.rhiz.LP <- subset(d1.shoot, site == "LP")
d1.shoot.ef.rhiz.NB <- subset(d1.shoot, site == "NB")
d1.shoot.ef.rhiz.WB <- subset(d1.shoot, site == "WB")

d1.shoot.ef.rhiz.DC$growth.ef <- (1.863636 - d1.shoot.ef.rhiz.DC$rhizome.growth)/1.863636
d1.shoot.ef.rhiz.LP$growth.ef <- (3.363636 - d1.shoot.ef.rhiz.LP$rhizome.growth)/3.363636
d1.shoot.ef.rhiz.NB$growth.ef <- (4.454545 - d1.shoot.ef.rhiz.NB$rhizome.growth)/4.454545
d1.shoot.ef.rhiz.WB$growth.ef <- (2.454545 - d1.shoot.ef.rhiz.WB$rhizome.growth)/2.454545

d1.shoot.ef.rhiz <- rbind(d1.shoot.ef.rhiz.DC, d1.shoot.ef.rhiz.LP, d1.shoot.ef.rhiz.NB, d1.shoot.ef.rhiz.WB)

d1.shoot.ef.rhiz <-subset(d1.shoot.ef.rhiz, infection == "Y")
```

##Lesion Spread Figures and Analyes
```{r eval = FALSE, echo = FALSE}
#Figures (*Only infected)
 ##Infection proportion ~ leaf.no
bargraph.CI(x.factor = exp.leaf.no, response = lesion.presence, data = d1.d28.disease, ylim = c(0,1.1), ylab = "Proportion of leaves with lesions", xlab = "exp.leaf.no")

  ##Infected proportion ~ site * leaf.no
bargraph.CI(x.factor = site, group = exp.leaf.no, response = lesion.presence, data = d1.d28.disease, ylim = c(0,5), ylab = "Proportion of leaves with lesions", xlab = "Site", legend = T)

#Analyses (ASK TORRIE FOR GLM)
```

##Lesion Percent Cover Figures and Analyses
```{r eval = FALSE, echo = FALSE}
#Figures

  ##Lesion Percent Cover ~ Infection * Leaf.no,
bargraph.CI(x.factor = exp.leaf.no, group = infection.x, response = lesion.pc.d28, data = d1.d28, ylim = c(0,100), ylab = "Lesion percent cover", xlab = "Leaf number", legend = T)

 ###Lesion percent cover ~ infection treatment * leaf.no (*all leaves, excluding dehisced/senesced leaves)
par(mfrow = c(2,2))
bargraph.CI(x.factor = exp.leaf.no, group = infection.x, response = lesion.pc.d28, data = filter(d1.d28, site.x == "DC" & dehisced.senesced == "N"), ylim = c(0,100), ylab = "Lesion percent cover", xlab = "Leaf number", legend = T) ##DC plot
bargraph.CI(x.factor = exp.leaf.no, group = infection.x, response = lesion.pc.d28, data = filter(d1.d28, site.x == "LP" & dehisced.senesced == "N"), ylim = c(0,100), ylab = "Lesion percent cover", xlab = "Leaf number", legend = T) ##LP plot
bargraph.CI(x.factor = exp.leaf.no, group = infection.x, response = lesion.pc.d28, data = filter(d1.d28, site.x == "NB" & dehisced.senesced == "N"), ylim = c(0,100), ylab = "Lesion percent cover", xlab = "Leaf number", legend = T) ##NB plot
bargraph.CI(x.factor = exp.leaf.no, group = infection.x, response = lesion.pc.d28, data = filter(d1.d28, site.x == "WB" & dehisced.senesced == "N"), ylim = c(0,100), ylab = "Lesion percent cover", xlab = "Leaf number", legend = T) ##WB plot

#Analyses
model.lesion.pc.d28 <- lmer(lesion.pc.d28 ~ infection.x*site.x*exp.leaf.no + (1|shoot.ID) + (1|mesocosm.x), data = filter(d1.d28, dehisced.senesced == "N"))
anova(model.lesion.pc.d28) ##Significant interaction: infection*leaf number, lesion.pc.d0 not significant so dropped from model, marginal 3 way interaction between infection*site*leaf number
```

##Leaf Growth Figures and Analyses
```{r eval = FALSE, echo = FALSE}
#Total leaf growth
  ##FIGURES
    ###growth effect size
fig.growth <- barplot(c(0,0,0,0), names = d28.ef.fig$exp.leaf.no , ylim = c(-2, 2),
                  ylab = "Effect size of disease on leaf growth",
                  xlab = "Leaf number")
points(x = fig.growth, d28.ef.fig$growth.ef.mean)
arrows(y0 = d28.ef.fig$growth.ef.mean[1:4] - d28.ef.fig$growth.ef.95ci[1:4], y1 = d28.ef.fig$growth.ef.mean[1:4] + d28.ef.fig$growth.ef.95ci[1:4], x0 = fig.growth, x1 =fig.growth, angle = 90, code = 3, #95% CI
length = 0.1)

  ###Leaf 1 growth effect size by site
fig.growth <- barplot(c(0,0,0,0), names = d1.d28.L1.total.ef.fig$site.x , ylim = c(-1, 1),
                  ylab = "Effect size of disease on leaf 1 growth",
                  xlab = "Site")
points(x = fig.growth, d1.d28.L1.total.ef.fig$mean.ef)
arrows(y0 = d1.d28.L1.total.ef.fig$mean.ef[1:4] - d1.d28.L1.total.ef.fig$CI.ef[1:4], y1 = d1.d28.L1.total.ef.fig$mean.ef[1:4] + d1.d28.L1.total.ef.fig$CI.ef[1:4], x0 = fig.growth, x1 =fig.growth, angle = 90, code = 3, #95% CI
length = 0.1)

  ##Leaf 1 growth effect size one-sample t-test
fig.growth <- barplot(c(0), ylim = c(-1, 1),
                  ylab = "Effect size of disease on leaf 1 growth")
points(x = fig.growth, mean(d1.d28.L1.total.ef$growth.ef))
arrows(y0 = mean(d1.d28.L1.total.ef$growth.ef)- 1.96*se(d1.d28.L1.total.ef$growth.ef), y1 = mean(d1.d28.L1.total.ef$growth.ef) + 1.96*se(d1.d28.L1.total.ef$growth.ef), x0 = fig.growth, x1 =fig.growth, angle = 90, code = 3, #95% CI
length = 0.1)


    ###Growth ~ infection treatment * leaf.no
bargraph.CI(x.factor = exp.leaf.no, group = infection.x, response = delta.length.cm, data = filter(d1.d28.leaf.growth.total, exp.leaf.no != "4" & exp.leaf.no != "5"), ylim = c(0,15), ylab = "Leaf growth (cm)", xlab = "Leaf number", legend = T)

    ###Growth ~ site * leaf.no 
bargraph.CI(x.factor = exp.leaf.no, group = site.x, response = delta.length.cm, data = filter(d1.d28.leaf.growth.total, exp.leaf.no != "4" & exp.leaf.no != "5"), ylim = c(0,15), ylab = "Leaf growth (cm)", xlab = "Leaf number", legend = T)

  ##Analyses
model.growth.std.total <- lmer(std.length.cm.total ~ infection.x*site.x*exp.leaf.no + (1|shoot.ID) + (1|mesocosm.x) + length.cm.d0, data = filter(d1.d28.leaf.growth.total, exp.leaf.no != "4" & exp.leaf.no != "5")) #adjusting for delta sheath length 
anova(model.growth.std.total) #Significant interactions: site*leaf number and Infection*leaf number (Excluded leaves 4 and 5 because not enough reps)

    ####Only leaf 1
model.growth.std.d28.L1 <- lmer(std.length.cm.total ~ infection.x*site.x + (1|mesocosm.x) + length.cm.d0, data = filter(d1.d28.leaf.growth.total, exp.leaf.no == "1")) #adjusting for delta sheath length 
anova(model.growth.std.d28.L1)

    ####Effect size
model.L1.ef.total <- lmer(growth.ef ~ site.x +(1|mesocosm.x), data = d1.d28.L1.total.ef)
anova(model.L1.ef.total)

t.test(d1.d28.L1.total.ef$growth.ef, mu = 0)

#Day5-Day28 leaf growth
  ##FIGURES
    ###Growth effect size
fig.growth <- barplot(c(0,0,0), names = d528.ef.fig$exp.leaf.no[1:3] , ylim = c(-1, 1),
                  ylab = "Effect size of disease on leaf growth d5-28",
                  xlab = "Leaf number")
points(x = fig.growth, d528.ef.fig$growth.ef.mean[1:3])
arrows(y0 = d528.ef.fig$growth.ef.mean[1:3] - d528.ef.fig$growth.ef.95ci[1:3], y1 = d528.ef.fig$growth.ef.mean[1:3] + d528.ef.fig$growth.ef.95ci[1:3], x0 = fig.growth, x1 =fig.growth, angle = 90, code = 3, #95% CI
length = 0.1)

    ###Growth ~ infection treatment * leaf.no
bargraph.CI(x.factor = exp.leaf.no, group = infection.x, response = delta.length.cm, data = filter(d1.d28.leaf.growth.d5d28, exp.leaf.no != "4" & exp.leaf.no != "5"), ylim = c(0,20), ylab = "Leaf growth (cm)", xlab = "Leaf number", legend = T)

    ###Growth ~ site * leaf.no 
bargraph.CI(x.factor = exp.leaf.no, group = site.x, response = delta.length.cm, data = filter(d1.d28.leaf.growth.d5d28, exp.leaf.no != "4" & exp.leaf.no != "5"), ylim = c(0,25), ylab = "Leaf growth (cm)", xlab = "Leaf number", legend = T)

  ##Analyses
model.growth.std.d5d28 <- lmer(std.length.cm.d5d28 ~ infection.x*site.x*exp.leaf.no + (1|shoot.ID) + (1|mesocosm.x) + std.length.cm.d5, data = filter(d1.d28.leaf.growth.d5d28, exp.leaf.no != "4" & exp.leaf.no != "5")) #adjusting for delta sheath length 
anova(model.growth.std.d5d28) #Significant interactions: site*leaf number and Infection*leaf number (Excluded leaves 4 and 5 because not enough reps)

    ### Only leaf 0
model.growth.std.d5d28.L1 <- lmer(std.length.cm.d5d28 ~ infection.x*site.x + (1|mesocosm.x) + std.length.cm.d5, data = filter(d1.d28.leaf.growth.d5d28, exp.leaf.no == "0")) #adjusting for delta sheath length 
anova(model.growth.std.d5d28.L1) #Significant interactions: site*leaf number and Infection*leaf number (Excluded leaves 4 and 5 because not enough reps)
```


##Change in leaf number Figures and Analyses
```{r eval = FALSE, echo = FALSE}
#Figures

  ##Change in leaves ~ site*infection
bargraph.CI(x.factor = site.x, group = infection.x, response = delta.no.leaves, data = d1.d28.leaves, ylim = c(-2,2), ylab = "Change in the number of leaves per shoot", xlab = "Site", legend = T)

  ##Change in leaves ~ infection
bargraph.CI(x.factor = infection.x, response = delta.no.leaves, data = d1.d28.leaves, ylim = c(-2,2), ylab = "Change in the number of leaves per shoot", xlab = "Infection")

  ##Change in leaves ~ site
bargraph.CI(x.factor = site.x, response = delta.no.leaves, data = d1.d28.leaves, ylim = c(-2,2), ylab = "Change in the number of leaves per shoot", xlab = "Infection")

  ##Number of leaves produced ~ infection
  bargraph.CI(x.factor = infection.x, response = no.leaves.new, data = d1.d28.leaves, ylim = c(0, 3), ylab = "Number of leaves produced per shoot", xlab = "Infection")

  ##Number of leaves lost ~ site * infection
  bargraph.CI(x.factor = site.x, group = infection.x, response = no.leaves.lost, data = d1.d28.leaves, ylim = c(0, 3), ylab = "Number of leaves lost per shoot", xlab = "Site", legend = T)
  
  
#Analyses
model.no.leaves.d28 <- lmer(no.leaves.x ~ infection.x*site.x + (1|mesocosm.x) + no.leaves.y , data = d1.d28.leaves)
anova(model.no.leaves.d28) #Significant main effets of infection and site, marginally significant interaction between site and infection

model.new.leaves.d28 <- lmer(no.leaves.new ~ infection.x*site.x + (1|mesocosm.x) + no.leaves.y, data = d1.d28.leaves)
anova(model.new.leaves.d28) #Significant Main effect of infection 

model.leaves.lost.d28 <- lmer(no.leaves.lost ~ infection.x*site.x + (1|mesocosm.x) + no.leaves.y, data = d1.d28.leaves)
anova(model.leaves.lost.d28) # Significant interaction between infection and site
```

## Biomass Figures and Analysis
```{r eval = FALSE, echo = FALSE}
#Figures
  ##Effect Size
    ###Effect Size ~ Infection x site
bargraph.CI(x.factor = site, response = tb.ef, data = d1.shoot.ef.tb, ylim = c(0,1), ylab = "Proportion Biomass reduction in disease plants over 28 days", xlab = "Site", legend = TRUE)

  ##Raw Data
    ##Total biomass: infection x site
bargraph.CI(x.factor = site, group = infection, response = b.t.d28, data = d1.shoot, ylab = "Total biomass (g)", xlab = "Site", ylim = c(0,1), legend = TRUE)

    ##above-ground: infection x site
bargraph.CI(x.factor = site, group = infection, response = a.g.d28, data = d1.shoot, ylab = "Above-ground biomass (g)", xlab = "Site", ylim = c(0,0.7), col = c("darkgreen", "brown"))
legend(x= "topright", legend = c("Control", "Infected"), fill = c("darkgreen", "brown"))

    ##below-ground: infection x site
bargraph.CI(x.factor = site, group = infection, response = b.g.d28, data = d1.shoot, ylab = "Below-ground biomass (g)", xlab = "Site", ylim = c(0,0.4), col = c("darkgreen", "brown"))
legend(x= "topright", legend = c("Control", "Infected"), fill = c("darkgreen", "brown"))

#Analyses
  ##Effect Size
model.biomass.tb.ef <- lmer(tb.ef ~ site + (1|mesocosm), data = d1.shoot.ef.tb)
anova(model.biomass.tb.ef)

summary(glht(model.biomass.tb.ef,linfct = mcp(site = "Tukey")))

  ##Raw Data
    ###total biomass
model.biomass.A <- lmer(b.t.d28 ~ infection * site + (1|mesocosm), data = d1.shoot)
anova(model.biomass.A)

    ###above-ground biomass
model.biomass.B <- lmer(a.g.d28 ~ infection * site + (1|mesocosm), data = d1.shoot)
anova(model.biomass.B)

    ###below-ground biomass
model.biomass.C <- lmer(b.g.d28 ~ infection * site + (1|mesocosm), data = d1.shoot)
anova(model.biomass.C)
```


##Rhizome Figures and Analyses
```{r eval = FALSE, echo = FALSE}
#Figures
  ##Effect Size
    ###Effect Size ~ Infection x site
bargraph.CI(x.factor = site, response = growth.ef, data = d1.shoot.ef.rhiz, ylim = c(0,1.5), ylab = "Proportion rhizome growth reduction in disease plants over 28 days", xlab = "Site", legend = TRUE)

  ##Raw data
    ##chance in rhizome length ~ infection * site
bargraph.CI(x.factor = site, group = infection, response = rhizome.length.cm.D28-rhizome.length.cm.D0, data = filter(d1.shoot, rhizome.length.cm.D0 != "NA"), ylim = c(0,8), ylab = "Rhizome growth (cm)", xlab = "Site", legend = TRUE)

#Analyses
  ##Effect Size
model.rhizome.growth.ef <- lmer(growth.ef ~ site + (1|mesocosm), data = d1.shoot.ef.rhiz)
anova(model.rhizome.growth.ef)

summary(glht(model.rhizome.growth.ef,linfct = mcp(site = "Tukey")))

  ##Raw data
model.rhizome.growth <- lmer(rhizome.length.cm.D28 ~ infection * site + (1|mesocosm), data = filter(d1.shoot, rhizome.length.cm.D0 != "NA"))
anova(model.rhizome.growth) #mesocosm not significant so removed from the model
```

##Home VS. Away

###Data management
```{r eval = FALSE, echo = FALSE}

d1.shoot.ef.tb$hva <- NA
d1.shoot.ef.tb$hva[d1.shoot.ef.tb$site == "DC"] <- "home"
d1.shoot.ef.tb$hva[d1.shoot.ef.tb$site == "LP"] <- "away"
d1.shoot.ef.tb$hva[d1.shoot.ef.tb$site == "NB"] <- "away"
d1.shoot.ef.tb$hva[d1.shoot.ef.tb$site == "WB"] <- "away"

d1.shoot$hva <- NA
d1.shoot$hva[d1.shoot$site == "DC"] <- "home"
d1.shoot$hva[d1.shoot$site == "LP"] <- "away"
d1.shoot$hva[d1.shoot$site == "NB"] <- "away"
d1.shoot$hva[d1.shoot$site == "WB"] <- "away"

```

###Biomass Figures and Analysis
```{r eval = FALSE, echo = FALSE}
#Figures
  ##Effect Size
    ###Effect Size ~ Infection x site
bargraph.CI(x.factor = hva, response = tb.ef, data = d1.shoot.ef.tb, ylim = c(0,1), ylab = "Proportion Total Biomass reduction in disease plants over 28 days", xlab = "Location", legend = TRUE)

  ##Raw Data
    ##Total biomass: infection x site
bargraph.CI(x.factor = hva, group = infection, response = b.t.d28, data = d1.shoot, ylab = "Total biomass (g)", xlab = "Location", ylim = c(0,1), legend = TRUE)

    ##above-ground: infection x site
bargraph.CI(x.factor = hva, group = infection, response = a.g.d28, data = d1.shoot, ylab = "Above-ground biomass (g)", xlab = "Location", ylim = c(0,0.7), col = c("grey90", "black"))
legend(x= "topright", legend = c("Control", "Infected"), fill = c("grey90", "black"))

    ##below-ground: infection x site
bargraph.CI(x.factor = hva, group = infection, response = b.g.d28, data = d1.shoot, ylab = "Below-ground biomass (g)", xlab = "Location", ylim = c(0,0.4), col = c("grey90", "black"))
legend(x= "topright", legend = c("Control", "Infected"), fill = c("grey90", "black"))

#Analyses
  ##Effect Size
model.biomass.tb.ef.hva <- lmer(tb.ef ~ hva + (1|site) + (1|mesocosm), data = d1.shoot.ef.tb)
anova(model.biomass.tb.ef.hva)

  ##Raw Data
    ###total biomass
model.biomass.A <- lmer(b.t.d28 ~ infection * hva + (1|site) + (1|mesocosm), data = d1.shoot)
anova(model.biomass.A)

    ###above-ground biomass
model.biomass.B <- lmer(a.g.d28 ~ infection * hva + (1|site) + (1|mesocosm), data = d1.shoot)
anova(model.biomass.B)

    ###below-ground biomass
model.biomass.C <- lmer(b.g.d28 ~ infection * hva + (1|site) + (1|mesocosm), data = d1.shoot)
anova(model.biomass.C)
```

#Environment Analysis
##Data manipulation
```{r eval = FALSE, echo = FALSE}
d1.env$mesocosm <- as.factor(d1.env$mesocosm)

str(d1.env)

d1.env.summary = d1.env %>%
  group_by(day, experiment.day, infection) %>%
  summarize(mean.T = mean(Temperature.C), sd.T = sd(Temperature.C), mean.S = mean(Salinity.ppt), sd.S = 1.96*sd(Salinity.ppt))

str(d1.env.summary)

d1.env.summary.I <- subset(d1.env.summary, infection == "Y")
d1.env.summary.C <- subset(d1.env.summary, infection == "N")
d1.env.summary.F <- subset(d1.env.summary, infection == "DC")
```

## Temperature Figures and Analyses
```{r eval = FALSE, echo = FALSE}
#Full summer figures
plot(dfull.env$sample.no, dfull.env$Temp.C,
     ylim = range(c(5, 25)),
     pch = 19,
     cex = .25,
     xlab = "Day",
     ylab = "Temperature (C)")


#Figures
plot(d1.env.summary.F$day, d1.env.summary.F$mean.T,
     ylim = range(c(10,25)),
     pch = 19, col = "blue",
     xlab = "Day of August", ylab = "Temperature (C)")

arrows(d1.env.summary.F$day, d1.env.summary.F$mean.T - d1.env.summary.F$sd.T, d1.env.summary.F$day, d1.env.summary.F$mean.T + d1.env.summary.F$sd.T, length = 0.05, angle = 90, code = 3, col = "blue")

points(d1.env.summary.C$day, d1.env.summary.C$mean.T,
     pch = 1, xlab = "Day of August", ylab = "Temperature (C)")

arrows(d1.env.summary.C$day, d1.env.summary.C$mean.T - d1.env.summary.C$sd.T, d1.env.summary.C$day, d1.env.summary.C$mean.T + d1.env.summary.C$sd.T, length = 0.05, angle = 90, code = 3)

points(d1.env.summary.I$day, d1.env.summary.I$mean.T,
     pch = 19, xlab = "Day of August", ylab = "Temperature (C)")

arrows(d1.env.summary.I$day, d1.env.summary.I$mean.T - d1.env.summary.I$sd.T, d1.env.summary.I$day, d1.env.summary.I$mean.T + d1.env.summary.I$sd.T, length = 0.05, angle = 90, code = 3)

#Analyses

```

## Salinity Figures and Analyses
```{r eval = FALSE, echo = FALSE}
#Figures
plot(d1.env.summary.I$day, d1.env.summary.I$mean.S,
     ylim = range(c(30,34)),
     pch = 19,
     xlab = "Day of August", ylab = "Salinty (ppt)")

arrows(d1.env.summary.I$day, d1.env.summary.I$mean.S - d1.env.summary.I$sd.S, d1.env.summary.I$day, d1.env.summary.I$mean.S + d1.env.summary.I$sd.S, length = 0.05, angle = 90, code = 3)

points(d1.env.summary.C$day, d1.env.summary.C$mean.S,
     pch = 1, xlab = "Day of August", ylab = "Salinity (ppt)")

arrows(d1.env.summary.C$day, d1.env.summary.C$mean.S - d1.env.summary.C$sd.S, d1.env.summary.C$day, d1.env.summary.C$mean.S + d1.env.summary.C$sd.S, length = 0.05, angle = 90, code = 3)
```


#Field Data
##Data manipulation
```{r eval = FALSE, echo = FALSE}
str(d1.field)
d1.field$quad <- as.factor(d1.field$quad)

#means by quad
d1.field.quad <- d1.field %>%
  group_by(site, quad) %>%
  summarize(mean.length = mean(length.cm, na.rm = T), mean.leaves = mean(no.leaves, na.rm = T), mean.lp = mean(lesion.present, na.rm = T), no.shoots = mean(no.shoots))

#means by site
d1.field.site <- d1.field %>%
  group_by(site) %>%
  summarize(mean.lp = mean(lesion.present, na.rm = T))

#mean severity by quad
d1.field.severity <- filter(d1.field, lesion.pc.2 > 0)
d1.field.qs <- d1.field.severity %>%
  group_by(site,quad) %>%
  summarize(mean.lpc = mean(lesion.pc.2))

#master mean data by quad
d1.field.quad <- merge(d1.field.quad, d1.field.qs, all.x = T)
```

##Figures
```{r eval = FALSE, echo = FALSE}
#Site * Length
bargraph.CI(x.factor = site, response = mean.length, data = d1.field.quad, ylab = "Length (cm)", xlab = "Site", ylim = c(0,150))

#Site * Leaf number
bargraph.CI(x.factor = site, response = mean.leaves, data = d1.field.quad, ylab = "Leaf number", xlab = "Site", ylim = c(0,6))

#Site * shoot number
bargraph.CI(x.factor = site, response = no.shoots, data = d1.field.quad, ylab = "shoot number", xlab = "Site", ylim = c(0,40))

#Site * lesion prevalence
bargraph.CI(x.factor = site, response = mean.lp, data = d1.field.quad, ylab = "Proportion infected", xlab = "Site", ylim = c(0,1))

#Site * lesion percent cover
bargraph.CI(x.factor = site, response = mean.lpc, data = d1.field.quad, ylab = "Lesion percent cover", xlab = "Site", ylim = c(0,15))

#lesion prevalence * Length
plot(mean.lp ~ mean.length, data = d1.field.quad)

plot(mean.lp ~ mean.length, data = subset(d1.field.quad, site == "DC"), ylim = c(0,1), xlim = c(35,120))
points(mean.lp ~ mean.length, data = subset(d1.field.quad, site == "LP"), col = "blue")
points(mean.lp ~ mean.length, data = subset(d1.field.quad, site == "WB"), col = "red")
points(mean.lp ~ mean.length, data = subset(d1.field.quad, site == "NB"), col = "orange")

#lesion.prevalence * leaf number
plot(mean.lp ~ mean.leaves, data = d1.field.quad)

#lesion.prevalence * shoot number
plot(mean.lp ~ no.shoots, data = subset(d1.field.quad, site == "DC"), xlim = c(0,70))
points(mean.lp ~ no.shoots, data = subset(d1.field.quad, site == "LP"), col = "blue")
points(mean.lp ~ no.shoots, data = subset(d1.field.quad, site == "WB"), col = "red")
points(mean.lp ~ no.shoots, data = subset(d1.field.quad, site == "NB"), col = "orange")

#Map of sites
setwd("~/Dropbox/EEMB Graduate/Research/ZosteraWastingDisease/Greenhouse_Mesocosm/Innoculation Trials/Trial_2/NE_seagrass_habitat/MassDEP Seagrass (1995 and 2001)")
ogrInfo(".", "GISDATA_EELGRASS_POLY")
zm.95.01 <- readOGR(dsn = ".", layer = "GISDATA_EELGRASS_POLY")   #layer of seagrass habitat MA
#str(zm.95.01)

setwd("~/Dropbox/EEMB Graduate/Research/ZosteraWastingDisease/Greenhouse_Mesocosm/Innoculation Trials/Trial_2/NE_seagrass_habitat/SAV12")
ogrInfo(".", "SAV12")
zm.ri.12 <- readOGR(dsn = ".", layer = "SAV12")   #layer of seagrass habitat RI
data_name <- "zm.ri.12.reproj" #name for new projection
assign(data_name, spTransform(zm.ri.12, CRS("+proj=longlat"))) #reassigning polygons to new projection
plot(zm.ri.12.reproj) #testing plot

setwd("~/Dropbox/EEMB Graduate/Research/ZosteraWastingDisease/Greenhouse_Mesocosm/Innoculation Trials/Trial_2/State Boundaries/MA Boundary")
ogrInfo(".", "GISDATA_OUTLINE25K_ARC")
MA.boundary <- readOGR(dsn = ".", layer = "GISDATA_OUTLINE25K_ARC")   #layer of MA State boundary

setwd("~/Dropbox/EEMB Graduate/Research/ZosteraWastingDisease/Greenhouse_Mesocosm/Innoculation Trials/Trial_2/State Boundaries/RI_CUSP")
ogrInfo(".", "RI_CUSP")
RI.boundary <- readOGR(dsn = ".", layer = "RI_CUSP")   #layer of RI coastline


(setwd("~/Dropbox/EEMB Graduate/Research/ZosteraWastingDisease/Greenhouse_Mesocosm/Innoculation Trials/Trial_2/Analyses/Data for analyses")) ##Returning working direction

#Site figure
map("worldHires", "usa", xlim = c(-71.2,-70.45), ylim = c(42.2, 42.65), col = "white", fill = FALSE)
plot(MA.boundary, add = TRUE, xlim = c(-71.2,-70.45), ylim = c(42.2, 42.65), col = "grey80")
plot(zm.95.01, add = TRUE, xlim = c(-71.2,-70.45), ylim = c(42.2, 42.65), col = "red", border = FALSE)
add.pie(z = c(0.6,0.4), x = -70.81579, y = 42.38063, radius = 0.02, col = c("purple", "white"), labels = "Nahant*", label.dist = 1.25, clockwise = TRUE)
add.pie(z = c(0.29, 0.71), x = -70.80543, y = 42.464487, radius = 0.02, col = c("darkgreen", "white"), labels = "Beverly", label.dist = 1.25, clockwise = TRUE)
add.pie(z = c(0.69, 0.31), x = -70.7309, y = 42.54013, radius = 0.02, col = c("blue", "white"), labels = c("Manchester", ""), label.dist = 1.25, clockwise = TRUE)
add.pie(z = c(0.47, 0.53), x = -70.75592, y = 42.60711, radius = 0.02, col = c("orange", "white"), labels = c("", "Gloucester"), label.dist = 1.25, clockwise = TRUE)
points(-70.91579, 42.42063, pch = "O", col = "purple")
points(-70.85843, 42.54487, pch = "O", col = "darkgreen")
points(-70.80609, 42.55913, pch = "O", col = "blue")
points(-70.65592, 42.59711, pch = "O", col = "orange")
points(-71.05888, 42.36008, pch = 18, col = "Black", cex = 2)
text(-71.02, 42.335, "Boston, MA")
map.scale(-70.637, 42.25, ratio = FALSE)
box(col = "darkblue", lwd = "3")

#seagrass distribution
map("worldHires", "usa", xlim = c(-71.2,-70.45), ylim = c(42.2, 42.65), col = "white", fill = FALSE)
plot(MA.boundary, add = TRUE, xlim = c(-71.2,-70.45), ylim = c(42.2, 42.65), col = "grey80")
plot(zm.95.01, add = TRUE, xlim = c(-71.2,-70.45), ylim = c(42.2, 42.65), col = "red", border = FALSE)
points(-71.05888, 42.36008, pch = 18, col = "Black", cex = 2)
text(-71.02, 42.335, "Boston, MA")
map.scale(-70.63, 42.25, ratio = FALSE)

#Site locations
map("worldHires", "usa", xlim = c(-71.2,-70.45), ylim = c(42.2, 42.65), col = "white", fill = FALSE)
plot(MA.boundary, add = TRUE, xlim = c(-71.2,-70.45), ylim = c(42.2, 42.75), col = "grey80")
points(-70.91579, 42.42063, pch = 17, col = "purple")
points(-70.85843, 42.54487, pch = 17, col = "darkgreen")
points(-70.80609, 42.55913, pch = 17, col = "blue")
points(-70.65592, 42.59711, pch = 17, col = "orange")
points(-71.05888, 42.36008, pch = 18, col = "Black", cex = 2)
text(-70.85, 42.4, "Nahant")
text( -70.92, 42.56, "Beverly")
text(-70.7, 42.55, "Manchester")
text(-70.58, 42.62, "Gloucester")
text(-71.02, 42.335, "Boston, MA")
map.scale(-70.637, 42.25, ratio = FALSE)
box(col = "darkblue", lwd = "3")

#New England seagrass distribution
map('state', region = c('mass', 'rhode island'), col = "white")
map("worldHires", xlim = c(-72,-69), ylim = c(40, 43.00), col = "white", fill = FALSE)
plot(MA.boundary, add = TRUE, xlim = c(-71.2,-69), ylim = c(40, 43), col = "grey80", lwd = 0.25)
plot(RI.boundary, add = TRUE, xlim = c(-72, -71), ylim = c(40, 42.65), col = "grey80", lwd = 0.25)
plot(zm.95.01, add = TRUE, xlim = c(-72.2,-69), ylim = c(40, 43), col = "red", border = FALSE)
plot(zm.ri.12.reproj, add = TRUE, col = "red", border = FALSE)
points(-71.05888, 42.36008, pch = 18, col = "Black", cex = 2)
text(-71.02, 42.335, "Boston, MA")
map.scale(-72, 42, ratio = FALSE)
```

##Dorothy Cove Depth Prevalence analyses/Figures
```{r eval = FALSE, echo = FALSE}

#Test of variation in proportion across depth
disease <- c(21, 53, 72)
healthy <- c(139, 75, 47)
total <- c(160, 128, 119)

prop.test(disease, total)

m.dc.prev <- glm(cbind(lesion.present, lesion.absent) ~ depth, data = d1.dc.field, family = "binomial")
summary(m.dc.prev, test = "LR")

#figure, prevalence
counts <- table(d1.dc.field$lesion.absent, d1.dc.field$depth)
par(las =1, mgp = c(2.5, 0.2, 0), mfrow = c(1,1), mar = c(3.75,4,0.5,0.375), tck = 0.01)
#par(oma = c(2, 1, 1, 1))
op <- par("usr")
barplot(counts,
        ylab = "No. Z. marina shoots", xlab = "Depth",
        legend = c("lesions", "no lesions"),
        args.legend = list(x = "topright", bty = "n", cex = 1.5),
        cex.lab = 2, cex.axis = 1.25,cex.names = 1.25,
        ylim = c(0,200))

#Test severity across depth
m.dc.l.pc <- aov(lesion.pc.2 ~ depth, data = d1.dc.field)
anova(m.dc.l.pc)

TukeyHSD(m.dc.l.pc)

#figure, severity
bargraph.CI(x.factor = depth, response = lesion.pc.2, data = d1.dc.field, ylim = c(0,15), ylab = "Lesion percent cover", xlab = "Depth")


```







































############################################################################################
############################################################################################

#Data manipulation
```{r eval = FALSE, echo = FALSE}
# ###NEED TO FIX THIS AROUND TO INCORPORATE NEW DATA MANAGEMENT STRATEGY 1/11/17 :) :P
# 
# #change per leaf
#   library(dplyr)
# 
# d2 <- select(d1, c(infection, leaf.no, length.cm, mesocosm, site))
# d2$growth <- d2$length.d5 - d2$length.d0
# 
#   ##change new leaf
# d2.new <- filter(d2, leaf.no == "0")
# 
#   ##change leaf 1
# d2.1 <- filter(d2, leaf.no == "1")
# 
#   ##change leaf 2
# d2.2 <- filter(d2, leaf.no == "2")
# 
#   ##change leaf 3
# d2.3 <- filter(d2, leaf.no == "3")
# 
#   ##change leaf 4
# d2.4 <- filter(d2, leaf.no == "4")
# 
# 
# #lesion percent cover
# 
# d3 <- select(d1, c(mesocosm, site, infection, leaf.no, lesion.area.d5, percent.cover.d5))
# 
#   ##lesions leaf 1
# d3.1 <- filter(d3, infection == "Y", leaf.no == "1")
# 
#   ##lesions leaf 2
# d3.2 <- filter(d3, infection == "Y", leaf.no == "2")
# 
#   ##lesions leaf 3
# d3.3 <- filter(d3, infection == "Y", leaf.no == "3")
# 
#   ##mean area and percent cover over leaves 1 and 2
# d3.mean <- aggregate(lesion.area.d5 ~ mesocosm + site + infection, FUN = mean, data = subset(d3, leaf.no == "1" | leaf.no == "2"))
# 
# d3.mean.pc <- aggregate(percent.cover.d5 ~ mesocosm + site + infection, FUN = mean, data = subset(d3, leaf.no == "1" | leaf.no == "2"))
# 
# d3.mean$percent.cover.d5 <- d3.mean.pc$percent.cover.d5
# 
# #change no.leaves
# d4 <- select(d1, c(mesocosm, site, infection, no.leaves.d0, no.leaves.d5, no.leaves.d28, new.leaves.d28, leaves.lost.d28))
# d4$change.leaves.d5 <- d4$no.leaves.d5 - d4$no.leaves.d0
# d4$change.leaves.d28 <- d4$no.leaves.d28 - d4$no.leaves.d0
# d4 <- aggregate(data=d4, cbind(no.leaves.d0, no.leaves.d5, no.leaves.d28, change.leaves.d5, change.leaves.d28, new.leaves.d28, leaves.lost.d28) ~ infection*site*mesocosm, FUN = mean)
# 
# ##Leaf Growth Effect Size
# ###Mean growth by infection and site
# d2.mean.si <- aggregate(growth ~ site + infection + leaf.no, FUN = mean, data = subset(d2, leaf.no == "1" | leaf.no == "2"))
# 
# d2.ef.1 <- subset(d2, leaf.no == "1")
# d2.ef.2 <- subset(d2, leaf.no == "2")
# 
# d2.ef.1.DC <- subset(d2.ef.1, site == "DC")
# d2.ef.1.LP <- subset(d2.ef.1, site == "LP")
# d2.ef.1.NB <- subset(d2.ef.1, site == "NB")
# d2.ef.1.WB <- subset(d2.ef.1, site == "WB")
# d2.ef.2.DC <- subset(d2.ef.2, site == "DC")
# d2.ef.2.LP <- subset(d2.ef.2, site == "LP")
# d2.ef.2.NB <- subset(d2.ef.2, site == "NB")
# d2.ef.2.WB <- subset(d2.ef.2, site == "WB")
# 
# d2.ef.1.DC$growth.ef <- (4.4395455 - d2.ef.1.DC$growth)/4.4395455
# d2.ef.1.LP$growth.ef <- (3.5593636 - d2.ef.1.LP$growth)/3.5593636
# d2.ef.1.NB$growth.ef <- (4.4511818 - d2.ef.1.NB$growth)/4.4511818
# d2.ef.1.WB$growth.ef <- (3.1115455 - d2.ef.1.WB$growth)/3.1115455
# d2.ef.2.DC$growth.ef <- (0.9873636 - d2.ef.2.DC$growth)/0.9873636
# d2.ef.2.LP$growth.ef <- (1.1100000 - d2.ef.2.LP$growth)/1.1100000
# d2.ef.2.NB$growth.ef <- (2.1352727 - d2.ef.2.NB$growth)/2.1352727
# d2.ef.2.WB$growth.ef <- (0.7261000 - d2.ef.2.WB$growth)/0.7261000
# 
# d2.ef <- rbind(d2.ef.1.DC, d2.ef.1.LP, d2.ef.1.NB, d2.ef.1.WB, d2.ef.2.DC, d2.ef.2.LP, d2.ef.2.NB, d2.ef.2.WB)
# 
# d2.ef <-subset(d2.ef, infection == "Y")
# 
# #biomass (d.28)
# d1.shoot$b.t.d28 <- d1.shoot$a.g.d28 + d1.shoot$b.g.d28
# 
# d1.shoot <- filter(d1.shoot, vase != "91", vase != "92")
# 
# d1.shoot$rhizome.growth <- d1.shoot$rhizome.length.cm.D28 - d1.shoot$rhizome.length.cm.D0
# 
# ##Rhizome length effect size
# ### (mean control[split by site] - individual infected)/ mean control [split by site]
# d1.shoot.mean.si <- aggregate(rhizome.growth ~ site + infection, FUN = mean, data = d1.shoot)
# 
# d1.shoot.ef.rhiz.DC <- subset(d1.shoot, site == "DC")
# d1.shoot.ef.rhiz.LP <- subset(d1.shoot, site == "LP")
# d1.shoot.ef.rhiz.NB <- subset(d1.shoot, site == "NB")
# d1.shoot.ef.rhiz.WB <- subset(d1.shoot, site == "WB")
# 
# d1.shoot.ef.rhiz.DC$growth.ef <- (1.863636 - d1.shoot.ef.rhiz.DC$rhizome.growth)/1.863636
# d1.shoot.ef.rhiz.LP$growth.ef <- (3.291667 - d1.shoot.ef.rhiz.LP$rhizome.growth)/3.291667
# d1.shoot.ef.rhiz.NB$growth.ef <- (4.416667 - d1.shoot.ef.rhiz.NB$rhizome.growth)/4.416667
# d1.shoot.ef.rhiz.WB$growth.ef <- (2.333333 - d1.shoot.ef.rhiz.WB$rhizome.growth)/2.333333
# 
# d1.shoot.ef.rhiz <- rbind(d1.shoot.ef.rhiz.DC, d1.shoot.ef.rhiz.LP, d1.shoot.ef.rhiz.NB, d1.shoot.ef.rhiz.WB)
# 
# d1.shoot.ef.rhiz <-subset(d1.shoot.ef.rhiz, infection == "Y")
# ```
# 
# #Length Area Regression
# ```{r}
# model.length.area <- aov(area.cm ~ length.cm*leaf.no*site*infection*experiment.day*clipped, data = d1)
# summary(model.length.area)
# 
# model.length.area <- lm(area.cm ~ length.cm, data = subset(d1, length.cm >= 0 & broken.sheath != "Y"))
# summary(model.length.area)
# 
# plot(area.cm ~ length.cm, ylim = c(0,30), xlim = c(0, 75), data = subset(d1, length.cm >= 0 & broken.sheath != "Y"))
# 
# plot(length.cm ~ area.cm, data = d1, ylim = c(0,75), xlim = c(0,30), col = c("red", "orange", "yellow", "green", "blue", "purple", "black", "brown")[leaf.no])
# legend(x="topright", legend = levels(d1$leaf.no), col=c("red", "orange", "yellow", "green", "blue", "purple", "black", "brown"), pch=1)
# 
#    plot(length.cm ~ area.cm, data = subset(d1, leaf.no == "1"))
# 
# plot(length.cm ~ area.cm, data = d1, ylim = c(0,75), xlim = c(0,30), col = c("red", "yellow", "green", "blue")[site])
# legend(x="topright", legend = levels(d1$site), col=c("red", "yellow", "green", "blue"), pch=1)
# 
# plot(length.cm ~ area.cm, data = d1, ylim = c(0,75), xlim = c(0,30), col = c("green", "brown")[infection])
# legend(x="topright", legend = levels(d1$infection), col=c("green", "brown"), pch=1)
# 
# plot(length.cm ~ area.cm, data = d1, ylim = c(0,75), xlim = c(0,30), col = c("red", "blue", "green")[clipped])
# legend(x="topright", legend = levels(d1$clipped), col=c("red", "blue", "green"), pch=1)
# 
# plot(length.cm ~ area.cm, data = d1, ylim = c(0,75), xlim = c(0,30), col = c("red", "blue", "green")[experiment.day])
# legend(x="topright", legend = levels(d1$experiment.day), col=c("red", "blue", "green"), pch=1)
```



# Initial Shoot Morphology Analyses and Figures
##Leaf Number
```{r eval = FALSE, echo = FALSE}
# str(d1.shoot)
# 
# #Initial Leaf Number ~ treatment x Site x Mesocosm
# bargraph.CI(x.factor = site, group = infection, response = leaf.number.D0, data = d1.shoot, ylim = c(0,6), ylab = "Leaf number", xlab = "Site", legend = TRUE)
# 
# model.leaf.no.D0 <- aov(leaf.number.D0 ~ infection * site + mesocosm, data = d1.shoot)
# anova(model.leaf.no.D0) #no effect of mesocosm so dropped
# 
# model.leaf.no.D0 <- aov(leaf.number.D0 ~ infection * site, data = d1.shoot)
# anova(model.leaf.no.D0) #Marginal effect of infection*site, significant effect of site
# 
#  #Sites tested individually
# model.leaf.no.D0.DC <- aov(leaf.number.D0 ~ infection + mesocosm, data = filter(d1.shoot, site == "DC"))
# anova(model.leaf.no.D0.DC) #no significant effects
# 
# model.leaf.no.D0.LP <- aov(leaf.number.D0 ~ infection + mesocosm, data = filter(d1.shoot, site == "LP"))
# anova(model.leaf.no.D0.LP) #no significant effects
# 
# model.leaf.no.D0.NB <- aov(leaf.number.D0 ~ infection + mesocosm, data = filter(d1.shoot, site == "NB"))
# anova(model.leaf.no.D0.NB) #no significant effects
# 
# model.leaf.no.D0.WB <- aov(leaf.number.D0 ~ infection + mesocosm, data = filter(d1.shoot, site == "WB"))
# anova(model.leaf.no.D0.WB) #marginal effect of infection, significant effect of mesocosm --> due to large variability in leaf no. between shoots
# 
# bargraph.CI(x.factor = site, group = mesocosm, response = leaf.number.D0, data = d1.shoot, ylim = c(0,6), ylab = "Leaf number", xlab = "Site", legend = TRUE)
# 
# ##WB shoots had significantly fewer leaves at the start of the experiment than shoots from DC, LP, NB. No effects of infection treatment or mesocosm on initial leaf number. Marginally significant interaction between site and infection treatment??
```

##leaf Length
```{r eval = FALSE, echo = FALSE}
#Leaf length ~ site * treatment * leaf.no
# bargraph.CI(x.factor = leaf.no, group = infection, response = length.d0, data =  filter(d1, leaf.no != "5"), ylim = c(0,30), ylab = "Leaf length", xlab = "Site", legend = TRUE)
# 
# bargraph.CI(x.factor = leaf.no, group = site, response = length.d0, data =  filter(d1, leaf.no != "5"), ylim = c(0,30), ylab = "Leaf length", xlab = "Site", legend = TRUE)
# 
# bargraph.CI(x.factor = site, group = infection, response = length.d0, data =  filter(d1, leaf.no != "5"), ylim = c(0,30), ylab = "Leaf length", xlab = "Site", legend = TRUE)
# 
# model.leaf.length.D0 <- aov(length.d0 ~ infection * site * leaf.no + mesocosm, data = filter(d1, leaf.no != "5"))
# anova(model.leaf.length.D0) #effect of mesocosm; interaction between site and infection --> DC infected leaves are longer than non-infected DC leaves (others sites no difference); interaction between site and leaf number --> WB plants have longer 1st leaves than other sites (function of fewer leaves); LP plants have shorter 2nd leaves than other sites (b/c they are shorter plants?); NB has longer 3rd and 4rth leaves than other sites (probably due to less infection of NB plants --> less clipping)
# 
# ##Leaf 1 and 2 analyses
# bargraph.CI(x.factor = site, group = infection, response = length.d0, data =  filter(d1, leaf.no == "1"), ylim = c(0,30), ylab = "Leaf length", xlab = "Site", legend = TRUE)
# 
# bargraph.CI(x.factor = site, group = infection, response = length.d0, data =  filter(d1, leaf.no == "2"), ylim = c(0,30), ylab = "Leaf length", xlab = "Site", legend = TRUE)
# 
# model.leaf1.length.D0 <- aov(length.d0 ~ infection * site + mesocosm, data = filter(d1, leaf.no == "1"))
# anova(model.leaf1.length.D0) #only significant effect of site --> WB taller
# 
# model.leaf2.length.D0 <- aov(length.d0 ~ infection * site + mesocosm, data = filter(d1, leaf.no == "2"))
# anova(model.leaf2.length.D0) #only significant effect of site --> LP shorter
```


#Delta Length Figures
```{r eval = FALSE, echo = FALSE}
#   #library(sciplot)
# 
# ###NOTE - only examined leaves 1 and 2 in order to capture all plants analyzed
# 
# #Leaf length
#   ## Infection (yes or no)
# bargraph.CI(x.factor = infection, response = growth, data = subset(d2, leaf.no == "1" | leaf.no == "2"), ylim = c(0,5), ylab = "Total change in leaf length (cm) over 5 days", xlab = "Infection")
# 
#   ##Infection x site
# ixs.plot <- bargraph.CI(x.factor = site, group = infection, response = growth, data = aggregate(growth ~ infection + site + mesocosm, FUN = mean, data = subset(d2, leaf.no == " 1" | leaf.no == "2")), ylim = c(0,4), ylab = "Growth (cm) over 5 days", xlab = "Site", col = c("darkgreen", "brown"))
# legend(x= "topright", legend = c("Control", "Infected"), fill = c("darkgreen", "brown"))
# 
#   ##Infection x leaf.no
# bargraph.CI(x.factor = leaf.no, group = infection, response = growth, data = d2, ylim = c(0,6), ylab = "Total change in leaf length (cm) over 5 days", xlab = "Leaf ID number", legend = TRUE)
# 
# 
#   ##Infection x mesocosm
# bargraph.CI(x.factor = infection, group = mesocosm, response = growth, data = subset(d2, leaf.no == "1" | leaf.no == "2"), ylim = c(0,5), ylab = "Total change in leaf length (cm) over 5 days", xlab = "Infection", legend = TRUE)
# 
#   ##Effect Size Infection x site
# bargraph.CI(x.factor = site, group = leaf.no, response = growth.ef, data = d2.ef, ylim = c(0,1), ylab = "Proportion growth reduction over 5 days", xlab = "Site", legend = TRUE)
```

#Delta Length Analyses
```{r eval = FALSE, echo = FALSE}
# model.d2 <- aov(length.d5 ~ infection * site * leaf.no + length.d0 + mesocosm, data = subset(d2, leaf.no == "1" | leaf.no == "2"))
# anova(model.d2)
# 
# model.d2.B <- aov(growth ~ infection*site*leaf.no + length.d0 + mesocosm, data = subset(d2, leaf.no == "1" | leaf.no == "2"))
# anova(model.d2.B)
# library(multcompView)
# (tukey=TukeyHSD(model.d2.B))
# multcompLetters(tukey$'infection:site'[,"p adj"])
# multcompLetters(tukey$'infection:leaf.no'[,"p adj"])
# 
# ##Planned contrasts
# model.d2.B.DC <- aov(growth ~ infection*leaf.no + length.d0 + mesocosm, data = filter(d2, leaf.no == "1" | leaf.no == "2", site =="DC"))
# anova(model.d2.B.DC)
# 
# model.d2.B.LP <- aov(growth ~ infection*leaf.no + length.d0 + mesocosm, data = filter(d2, leaf.no == "1" | leaf.no == "2", site =="LP"))
# anova(model.d2.B.LP)
# 
# model.d2.B.NB <- aov(growth ~ infection*leaf.no + length.d0 + mesocosm, data = filter(d2, leaf.no == "1" | leaf.no == "2", site =="NB"))
# anova(model.d2.B.NB)
# 
# model.d2.B.WB <- aov(growth ~ infection*leaf.no + length.d0 + mesocosm, data = filter(d2, leaf.no == "1" | leaf.no == "2", site =="WB"))
# anova(model.d2.B.WB)
# 
# 
# ## Create an effect size
# ### (mean control[split by site] - individual infected)/ mean control [split by site]
# model.d2.ef.1 <- aov(growth.ef ~ site*length.d0 + mesocosm, data = subset(d2.ef, leaf.no == "1"))
# anova(model.d2.ef.1)
# 
# model.d2.ef.2 <- aov(growth.ef ~ site*length.d0 + mesocosm, data = subset(d2.ef, leaf.no == "2"))
# anova(model.d2.ef.2)
# 
# model.d2.ef <- aov(growth.ef ~ site*leaf.no*length.d0 + mesocosm, data = d2.ef)
# anova(model.d2.ef)
```

#Delta leaf.no
##Day 5 Figures
```{r eval = FALSE, echo = FALSE}
# bargraph.CI(x.factor = infection, response = change.leaves, data = d4, ylim = c(-2,2), ylab = "Change in leaf number over 5 days", xlab = "Infection")
# 
# bargraph.CI(x.factor = site, response = change.leaves, data = d4, ylim = c(-2,2), ylab = "Change in leaf number over 5 days", xlab = "Site")
# 
# plot(no.leaves.d5 ~ no.leaves.d0, data = d4)
```

#Day 5 Analyes
```{r eval = FALSE, echo = FALSE}
# model.d4 <- aov(no.leaves.d5 ~ infection*site + no.leaves.d0 + mesocosm, data = d4)
# anova(model.d4)
```

##Day 28 Analyses
```{r eval = FALSE, echo = FALSE}
# model.dln28 <- aov(no.leaves.d28 ~ infection * site + no.leaves.d0 + mesocosm, data = d4)
# anova(model.dln28)
# 
# model.newleaf28 <- aov(new.leaves.d28 ~ infection * site + no.leaves.d0 + mesocosm, data = d4)
# anova(model.newleaf28)
# 
# model.leaflost28 <- aov(leaves.lost.d28 ~ infection * site + no.leaves.d0 + mesocosm, data = d4)
# anova(model.leaflost28)
# 
# (tukey=TukeyHSD(model.leaflost28))
# multcompLetters(tukey$'infection:site'[,"p adj"])
```

##Day 28 Figures
```{r eval = FALSE, echo = FALSE}
# bargraph.CI(x.factor = site, group = infection, response = change.leaves.d28, data = d4, ylim = c(-4,4), ylab = "Change in leaf number over 28 days", xlab = "Site", legend = T)
# 
# bargraph.CI(x.factor = site, group = infection, response = new.leaves.d28, data = d4, ylim = c(0,4), ylab = "New leaves produced over 28 days", xlab = "Site", legend = T)
# 
# bargraph.CI(x.factor = site, group = infection, response = leaves.lost.d28, data = d4, ylim = c(0,4), ylab = "Leaves lost over 28 days", xlab = "Site", legend = T)
```


#Lesion Figures
```{r eval = FALSE, echo = FALSE}
# #Lesion area
#   ##Infection x Site
# bargraph.CI(x.factor = site, group = infection, response = lesion.area.d5, data = d3.mean, ylim = c(0,10), ylab = "Lesion area (cm2) after 5 days infection", xlab = "Site", legend = TRUE)
# 
#   ##Infection x Leaf.no
# bargraph.CI(x.factor = leaf.no, group = infection, response = lesion.area.d5, data = d3, ylim = c(0,6), ylab = "Lesion area (cm2) after 5 days infection", xlab = "Leaf ID number", legend=TRUE)
# 
# #Lesion percent cover
#   ##Infection x Site
# bargraph.CI(x.factor = site, group = infection, response = percent.cover.d5, data = d3.mean, ylim = c(0,100), ylab = "Lesion percent cover after 5 days infection", xlab = "Site", col = c("darkgreen", "brown"))
# legend(x= "topright", legend = c("Control", "Infected"), fill = c("darkgreen", "brown"))
# 
#   ##Infection x Leaf.no
# bargraph.CI(x.factor = leaf.no, group = infection, response = percent.cover.d5, data = d3, ylim = c(0,100), ylab = "Lesion percent cover after 5 days infection", xlab = "Leaf ID number", legend=TRUE)
# 
#   ## Leaf.no (only leaves 1 & 2) x Site (infected leaves only)
# bargraph.CI(x.factor = site, group = leaf.no, response = percent.cover.d5, data = filter(d3, infection == 'Y', leaf.no == "1" | leaf.no =="2"), ylim = c(0,100), ylab = "Lesion percent cover after 5 days infection", xlab = "Site", legend = TRUE)
```

#Lesion Analyses
```{r eval = FALSE, echo = FALSE}
##Area.cm2
# model.d3.A <- aov(lesion.area.d5 ~ infection * site * leaf.no + mesocosm, data = subset(d3, leaf.no == "1" | leaf.no == "2"))
# anova(model.d3.A)
# 
# (tukey=TukeyHSD(model.d3.A))
# multcompLetters(tukey$'infection:site'[,"p adj"])
# multcompLetters(tukey$'infection:leaf.no'[,"p adj"])
# 
# 
# ##Percent.cover
# model.d3.B <- aov(percent.cover.d5 ~ infection * site * leaf.no + mesocosm, data = subset(d3, leaf.no == "1" | leaf.no == "2"))
# anova(model.d3.B)
# (tukey=TukeyHSD(model.d3.B))
# multcompLetters(tukey$'infection:leaf.no'[,"p adj"])
```

#Biomass Figures
```{r eval = FALSE, echo = FALSE}
# #Total biomass: infection x site
# bargraph.CI(x.factor = site, group = infection, response = b.t.d28, data = d1.shoot, ylab = "Total biomass (g)", xlab = "Site", ylim = c(0,1), legend = TRUE)
# 
# #above-ground: infection x site
# bargraph.CI(x.factor = site, group = infection, response = a.g.d28, data = d1.shoot, ylab = "Above-ground biomass (g)", xlab = "Site", ylim = c(0,0.7), col = c("darkgreen", "brown"))
# legend(x= "topright", legend = c("Control", "Infected"), fill = c("darkgreen", "brown"))
# 
# #below-ground: infection x site
# bargraph.CI(x.factor = site, group = infection, response = b.g.d28, data = d1.shoot, ylab = "Below-ground biomass (g)", xlab = "Site", ylim = c(0,0.4), col = c("darkgreen", "brown"))
# legend(x= "topright", legend = c("Control", "Infected"), fill = c("darkgreen", "brown"))

```

#Biomass (d.28) analyses
```{r eval = FALSE, echo = FALSE}
# #total biomass
# model.biomass.A <- aov(b.t.d28 ~ infection * site + mesocosm, data = d1.shoot)
# anova(model.biomass.A)
# 
# #above-ground biomass
# model.biomass.B <- aov(a.g.d28 ~ infection * site + mesocosm, data = d1.shoot)
# anova(model.biomass.B)
# 
# #below-ground biomass
# model.biomass.C <- aov(b.g.d28 ~ infection * site + mesocosm, data = d1.shoot)
# anova(model.biomass.C)

```

#Rhizome length (d.28 analyses)
```{r eval = FALSE, echo = FALSE}
# bargraph.CI(x.factor = site, group = infection, response = rhizome.length.cm.D28-rhizome.length.cm.D0, data = filter(d1.shoot, rhizome.length.cm.D0 != "NA"), ylim = c(0,8), ylab = "Rhizome growth (cm)", xlab = "Site", legend = TRUE)
# 
# model.rhizome.growth <- aov(rhizome.length.cm.D28 ~ infection * site, data = filter(d1.shoot, rhizome.length.cm.D0 != "NA"))
# anova(model.rhizome.growth) #mesocosm not significant so removed from the model
# 
# (tukey=TukeyHSD(model.rhizome.growth))
# multcompLetters(tukey$'infection:site'[,"p adj"])
# 
# ###### Planned contrasts??
# model.rhizome.growth.DC <- aov(rhizome.length.cm.D28 ~ infection, data = filter(d1.shoot, rhizome.length.cm.D0 != "NA", site == "DC"))
# anova(model.rhizome.growth.DC)
# 
# model.rhizome.growth.LP <- aov(rhizome.length.cm.D28 ~ infection, data = filter(d1.shoot, rhizome.length.cm.D0 != "NA", site == "LP"))
# anova(model.rhizome.growth.LP)
# 
# model.rhizome.growth.NB <- aov(rhizome.length.cm.D28 ~ infection, data = filter(d1.shoot, rhizome.length.cm.D0 != "NA", site == "NB"))
# anova(model.rhizome.growth.NB)
# 
# model.rhizome.growth.WB <- aov(rhizome.length.cm.D28 ~ infection, data = filter(d1.shoot, rhizome.length.cm.D0 != "NA", site == "WB"))
# anova(model.rhizome.growth.WB)
# 
# ##Effect Size
#   ##Effect Size Infection x site
# bargraph.CI(x.factor = site, response = growth.ef, data = d1.shoot.ef.rhiz, ylim = c(0,1.5), ylab = "Proportion growth reduction over 28 days", xlab = "Site", legend = TRUE)
# 
# model.rhizome.growth.ef <- aov(growth.ef ~ site, data = d1.shoot.ef.rhiz)
# anova(model.rhizome.growth.ef) #mesocosm not significant so removed from the model
# 
# (tukey=TukeyHSD(model.rhizome.growth.ef))
# multcompLetters(tukey$'site'[,"p adj"])
```


